---
description: 5240 PcOff Electron 프로젝트 요구사항·API·아키텍처 준수 (PRD/TRD/API/VIBE 기준)
alwaysApply: true
---

# 5240 PcOff Electron 프로젝트 룰

이 프로젝트는 MFC 레거시를 Electron + TypeScript로 전환하는 5240.PcOff Agent다. 단일 소스: `PRD_5240_PcOff_Electron.md`, `TRD_5240_PcOff_Electron.md`, `PC_OFF_AGENT_API.md`, `VIBE_PROMPT_IMPLEMENTATION.md`.

## 에이전트 실행 흐름

에이전트는 **항상 계획을 먼저 세운 뒤** 실행한다.

### 1. 계획 수립

**분석할 것**
- 요청의 **목표**(무엇을 달성해야 하는지), **영향 범위**(어떤 파일·모듈이 걸리는지), **의존 관계**(A를 해야 B가 가능한지).
- **난이도 판단**: 3단계 이상이거나, 여러 파일 수정, 신규 기능, 리팩터링, API/상태머신/시뮬레이터·CI 변경 → Todos 필수. 한두 줄 수정·단일 파일 읽기·단순 질의 → Todos 생략 가능.

**산출할 것**
- 난이도 있는 작업: 단계 목록을 글로 적고, `TodoWrite`로 체크리스트 생성 후 첫 항목을 `in_progress`로 두고 실행 시작.
- 단순 요청: 바로 실행. 도중에 작업이 늘어나면 그 시점에 체크리스트 추가.

### 2. 태스크 세분화 (난이도 있는 작업)

**세분화 기준**
- **한 항목 = 한 번에 검증 가능한 단위**. 대략 "한 가지 파일/한 가지 관심사" 수준. 너무 크면 나눈다.
- **좋은 예**: "getPcOffLoginUserInfo.do 요청/응답 타입 정의" → "로그인 API 클라이언트 함수 구현" → "feature-core에서 로그인 성공 시 상태 전이 연결" → "린트/타입 체크".
- **나쁜 예**: "로그인 API 연동" (한 항목에 여러 단계가 섞임).

**순서·검증**
- **의존 순서**: 타입/인터페이스/설정 → 구현 → 연동 → 검증. 선행 완료 후에만 다음을 `in_progress`로.
- **검증 항목 포함**: "린트/타입 체크", "시뮬레이터 시나리오 실행", "관련 문서 반영" 등 구현 뒤 검증·정리 단계를 반드시 넣는다.
- **한 번에 한 항목만**: 여러 todo를 동시에 `in_progress`로 두지 않는다.

### 3. 실행 및 상태 갱신

**진행 방식**
- 첫 todo를 `in_progress`로 두고 시작. 항목이 끝나면 `completed`로 바꾸고, 다음 항목을 `in_progress`로 전환한 뒤 진행.

**수정 시 준수**
- **수정 전 읽기**: 건드릴 파일·함수·블록을 먼저 읽고, 현재 내용을 확인한 뒤에만 search_replace/write 적용. 추측 편집 금지.
- **작은 단위 편집**: 한 번에 한 목적(한 함수 시그니처, 한 블록 로직 등)만 수정. 여러 목적이면 여러 번에 나누어 적용.
- **편집 후**: 해당 파일에 린트가 있으면 수정 후 `ReadLints`로 확인하고 오류를 해소한 뒤 다음으로 넘긴다.

**완료 처리**
- 해당 todo의 **완료 기준**(어떤 코드/동작/문서로 검증하는지)을 만족했을 때만 `completed`로 표시. "다 했는데 확인은 안 함"으로 완료 처리하지 않는다.

### 4. 완료 후 요약·보고

작업을 마친 뒤 **반드시** 사용자에게 아래 형식으로 보고한다.

**문서 최신화 (개발 정상 완료 시)**  
코드·기능 변경이 정상적으로 완료되면 **관련 문서를 최신화**한 뒤 보고한다. **`docs/` 하위 문서는 개발 완료 시 모두 검토·최신화**한다. `docs/다음_개발_진행_사항.md`는 항상 갱신(완료 항목 반영, 남은 작업·다음 단계 반영). `docs/개발_이력_리포트.md`, `docs/테스트_가이드_비개발자.md`, `docs/로그인_테스트.md`, `docs/operations/logcode.md` 등 변경과 연관된 문서도 내용에 맞게 수정한다. 루트의 `README.md`와 PRD/TRD/API 등 설계 문서도 추가·변경된 모듈·엔드포인트·설정·실행 방법이 있으면 반영한다. 문서 업데이트도 변경 요약에 포함해 보고한다.

**커밋 메시지 (개발 정상 완료 시)**  
파일이 수정·추가·삭제된 작업이 정상 완료되면 **제안 커밋 메시지**를 **에이전트 창(채팅)에만** 적어 보고에 포함한다. **파일로 생성하지 않는다.** 두 가지를 모두 작성한다. (1) **커밋용**: 제목(50자 내외) + 필요 시 본문(변경 요약·영향 범위), `git commit`에 복사해 쓸 수 있는 형식. (2) **자연어 요약**: 같은 변경 내용을 읽기 쉬운 문장으로 정리한 버전(예: "이번에 로그인 API 연동과 잠금 화면 타이머를 추가했고, 관련 문서를 갱신했습니다.").

| 항목 | 필수 여부 | 내용 |
|------|-----------|------|
| **변경 요약** | 수정한 파일이 있으면 필수 | 파일 경로별로 무엇을 수정·추가·삭제했는지 한 줄씩. (예: `app/main/index.ts` — 업데이트 체크 주기 추가) |
| **문서 최신화** | 개발 정상 완료 시 필수 | **`docs/` 하위 문서 전체** 검토·갱신. `docs/다음_개발_진행_사항.md` 필수, 나머지는 변경과 연관된 문서만 반영해도 됨. 갱신한 문서와 반영한 내용을 한 줄씩 보고. |
| **커밋 메시지** | 개발 정상 완료 시 필수 | **에이전트 창에만** 작성. 파일 생성 금지. (1) 커밋용: 제목+본문. (2) 자연어 요약: 같은 내용을 읽기 쉬운 문장으로 정리. |
| **완료된 todo** | 체크리스트를 썼으면 필수 | 완료한 항목 목록을 나열. |
| **남은 이슈·권장** | 있으면 기재 | 미완료 부분, 수동 확인 필요, 다음에 할 작업. |
| **단순 요청** | 파일 수정 시 필수 | "변경된 파일: …, 변경 내용: …" 한 줄이라도 보고. |

## 필수 제약

- **기능 동등성**: 기존 MFC 시나리오와 결과(상태·로그·API 파라미터)가 동일해야 함. UI 표시가 아니라 시나리오 결과로 판단.
- **자동 업데이트**: 사용자 확인 다이얼로그 금지. 감지 시 백그라운드 다운로드 후 무확인 적용.
- **비밀번호 변경**: 확인 UI만 제공. 비밀번호 검증·재로그인 요구 금지.
- **크로스 플랫폼**: Windows·macOS 동일 수준 동작. OS별 회귀 테스트 유지.
- **시뮬레이터**: CLI로 시나리오 실행 가능, CI에서 자동 실행.
- **Agent Guard**: 삭제/우회 탐지, 무결성 체크, 자동 복구 트리거 필수.
- **Ops Observer**: heartbeat, 비정상 종료·통신 두절, 설치자 레지스트리 동기화.

## API·통신

- PCOFF 통신 규격은 `PC_OFF_AGENT_API.md`를 단일 소스로 사용.
- Lock On/Off, 이석, 임시연장, 긴급사용 여부는 **반드시** `/getPcOffWorkTime.do` 응답 기준으로 판단.
- 모든 API 호출은 타입이 명확한 클라이언트로 감싸고, 요청/응답을 구조화된 로그(JSONL)로 남김. 네트워크 장애 시 ops-observer에 보고.
- 출퇴근 산정: `callCmmPcOnOffLogPrc.do`의 IN/OUT 규칙 및 `docs/operations/logcode.md` 매핑 준수.

## 아키텍처·폴더

- **Process**: Main(생명주기·업데이트·OS·무결성), Renderer(UI·화면 전환), Preload(contextIsolation 유지).
- **모듈**: app-shell, update-manager, auth-policy, feature-core, simulator, telemetry-log, agent-guard, ops-observer. 역할은 TRD §2 참고.
- **폴더**: `app/main`, `app/renderer`, `app/preload`, `app/core` 분리. 시뮬레이터는 `simulator/`.
- **로컬 저장**: `config.json`, `state.json`, `logs/YYYY-MM-DD.json`, `guard/integrity.json`, `update/retry-queue.json`.
- **상태 머신**: INIT → LOGIN_REQUIRED → AUTHENTICATED → LOCKED / UNLOCK_PENDING_REASON / TIMER_RUNNING / ALERTING / UPDATE_* / ERROR_STATE. feature-core에서 구현.

## 로깅

- JSONL 형식. 필드: `timestamp`(ISO8601), `logCode`, `level`, `sessionId`, `deviceId`, `userId`, `payload`.
- 필수 이벤트: APP_START, LOGIN_SUCCESS/FAIL, LOCK_TRIGGERED/UNLOCK_TRIGGERED, UPDATE_*, PASSWORD_CHANGE_DETECTED/CONFIRM_DONE, AGENT_TAMPER_DETECTED/RECOVERED, CRASH_DETECTED, OFFLINE_DETECTED. logcode.md와 동기화.

## 업데이트·Guard

- 업데이트: 무결성(hash/signature) 검증. 실패 시 롤백 또는 재시도 큐. UI 프롬프트 없음.
- Agent Guard: Windows(서비스·ACL·Watchdog), macOS(LaunchDaemon·notarization/code signing). 바이너리 해시·중요 파일 모니터링.

새 기능 추가·API 변경 시 위 문서들을 먼저 반영하고, DoD(PRD §9)와 시뮬레이터 시나리오로 검증한다.
