# 개발 이력 리포트

5240 PcOff Electron 프로젝트의 주요 개발 이력을 기록합니다.

- **마지막 문서 업데이트**: 2026-02-24 (31차)

---

## 2026-02-24 (31차) 긴급사용 2단계 OTP·긴급해제 검증·잠금 해제 후 창 전환(macOS 풀스크린 대응)

**작업 요약**

| 구분 | 내용 |
|------|------|
| **긴급사용 2단계** | Step1: 사유만 전송(`pcoff:requestEmergencyUseStep1`) → 서버 1회 OTP 발급·응답에 인증번호 반환. Step2: 모달에서 인증번호·사유 입력 후 **클라이언트에서만** 서버 인증번호와 비교, 일치 시 `completeEmergencyUseWithReason`(API 재호출 없음). 실패 시 모달 유지. |
| **긴급해제** | 서버 응답 `code === 1`일 때만 성공 처리(api-client, Main IPC). 그 외는 실패·남은 횟수 표시. |
| **잠금 해제 후 창** | 임시연장·긴급사용·긴급해제·핫키·트레이·Dock 등 모든 경로에서 `showTrayInfoInCurrentWindow()`로 통일. **macOS**: 풀스크린 잠금창 재사용 시 크기 미적용 이슈로, 기존 창 destroy 후 `createTrayInfoWindow()`로 새 창(620×840) 생성해 표시. Windows: 기존대로 hide → load → show(620×840). |
| **문서** | `다음_개발_진행_사항.md`: 완료 항목에 긴급사용 2단계·긴급해제 code===1·잠금 해제 후 창 전환 반영. "긴급사용 인증번호 이슈" → "긴급사용 인증번호 — 앱 측 개발 완료"로 수정. |

**파일 변경**

- `app/main/index.ts`: showTrayInfoInCurrentWindow(macOS 시 darwin 분기에서 mainWindow destroy 후 createTrayInfoWindow), 긴급해제 성공 시 showTrayInfoInCurrentWindow, 트레이/메뉴/activate/오프라인 복귀/시작 시 showTrayInfoInCurrentWindow 호출로 통일. requestEmergencyUnlock 성공 시 showTrayInfoInCurrentWindow.
- `app/renderer/lock.js`: 긴급사용 2단계(Step1 사유 전송·serverPass 수신, 모달 인증번호 비교·completeEmergencyUseWithReason).
- `app/core/api-client.ts`: 긴급해제 응답 code===1일 때만 성공 처리.
- `app/preload/index.ts`: requestEmergencyUseStep1, completeEmergencyUseWithReason 노출.
- `docs/다음_개발_진행_사항.md`: 마지막 점검 일자·완료 항목·긴급사용 인증번호 문단 갱신.
- `docs/개발_이력_리포트.md`: 31차 추가.

---

## 2026-02-24 (30차) §7·§11 다중 디스플레이 — 디스플레이당 잠금창·핫플러그

**작업 요약**

| 구분 | 내용 |
|------|------|
| **다중 디스플레이** | 잠금 시 주 디스플레이(mainWindow) + 보조 디스플레이당 잠금 전용 창 1개. `lockWindowsByDisplayId`(display.id → BrowserWindow), `ensureLockWindowsForAllDisplays()` |
| **창 생성** | createLockWindow/showLockInWindow 후 보조 디스플레이마다 BrowserWindow 생성(같은 lock.html·전체 화면·alwaysOnTop·visibleOnAllWorkspaces). 주 디스플레이 창은 getPrimaryDisplay() 기준 bounds 적용 |
| **해제 시** | `closeAllLockWindows()` — showTrayInfoInCurrentWindow·createLoginWindow 시 보조 잠금창 전부 닫기 |
| **핫플러그** | `screen.on("display-added")` → ensureLockWindowsForAllDisplays(). `screen.on("display-removed")` → 해당 display.id 창 닫기·맵에서 제거 |
| **보조 창 동작** | `attachLockWindowBehavior(win)` — 닫기 차단·leave-full-screen 시 setFullScreen(true)·blur 시 재포커스 |

**파일 변경**

- `app/main/index.ts`: screen import, lockWindowsByDisplayId, closeAllLockWindows, attachLockWindowBehavior, ensureLockWindowsForAllDisplays, createLockWindow(primaryDisplay bounds·ensureLockWindowsForAllDisplays), showLockInWindow(ensureLockWindowsForAllDisplays), showTrayInfoInCurrentWindow/createLoginWindow(closeAllLockWindows), screen display-added/display-removed 리스너
- `docs/다중_디스플레이_QA.md`: §4 다중 모니터 구현 완료 반영, 체크리스트 4.x
- `docs/다음_개발_진행_사항.md`: §7·§11 완료, 권장 순서 7번 완료, 현재 완료 항목에 다중 디스플레이 추가
- `docs/개발_이력_리포트.md`: 30차 추가

---

## 2026-02-24 (29차) 임시연장 화면 로드 시 이석 감지 반영

**작업 요약**

| 구분 | 내용 |
|------|------|
| **문제** | 임시연장으로 에이전트(작동정보) 화면이 로드된 상태에서 서버 이석(screenType=empty) 또는 로컬 이석이 감지되지 않음 |
| **원인** | TEMP_EXTEND 시 getWorkTime/refreshMyAttendance가 서버 응답을 병합만 하고 lastWorkTimeData를 갱신하지 않음. isLockRequired는 시간만 검사하고 이석(screenType=empty) 시 잠금을 반환하지 않음 |
| **수정** | (1) getWorkTime·refreshMyAttendance의 TEMP_EXTEND 분기에서 병합 결과로 lastWorkTimeData 갱신(서버 이석 반영, pcOffYmdTime/pcExCount는 로컬 유지). (2) isLockRequired에서 로컬 이석(localLeaveSeatDetectedAt) 또는 lastWorkTimeData.screenType===empty이면 무조건 잠금 반환. (3) TEMP_EXTEND 주기 잠금 검사 시에도 API로 최신 근태 조회 후 병합·이석 여부 판단. (4) 일반 경로 fetch 후에도 screenType=empty이면 잠금 반환 |

**파일 변경**

- `app/main/index.ts`: getWorkTime TEMP_EXTEND 분기에서 lastWorkTimeData = { ...merged }. refreshMyAttendance TEMP_EXTEND 분기에서 lastWorkTimeData 갱신. isLockRequired 상단에 이석 시 true 반환, TEMP_EXTEND 분기 내 API 조회·병합·이석 시 true, 일반 경로에 screenType=empty 시 true 추가
- `docs/개발_이력_리포트.md`: 29차 추가

---

## 2026-02-24 (28차) 업데이트 적용 — '지금 재시작' 버튼 클릭 시에만 종료·적용

**작업 요약**

| 구분 | 내용 |
|------|------|
| **동작 변경** | 업데이트 확인 버튼을 눌러도 앱이 종료되지 않음. 다운로드 완료 시 버튼만 「지금 재시작」으로 바뀌고, **「지금 재시작」을 눌렀을 때만** 앱 종료·설치 적용 |
| **update-manager** | `autoInstallOnAppQuit: false` — 적용은 IPC `pcoff:quitAndInstallUpdate`(재시작 버튼)에서만 수행 |
| **main before-quit** | `quitAndInstallIfDownloaded()` 호출 제거 — 일반 종료(창 닫기·트레이 종료) 시에는 업데이트 미적용 |

**파일 변경**

- `app/core/update-manager.ts`: autoInstallOnAppQuit = false, 주석 정리
- `app/main/index.ts`: before-quit에서 quitAndInstallIfDownloaded 제거
- `docs/다음_개발_진행_사항.md`, `docs/업데이트_가이드_사용자.md`, `docs/업데이트_릴리즈_점검.md`: 적용 시점 문구(지금 재시작 클릭 시에만)
- `docs/개발_이력_리포트.md`: 28차 추가

---

## 2026-02-24 (27차) §8 인스톨/언인스톨 Phase 2 — 플로우·로그·격리 모드 실구현

**작업 요약**

| 구분 | 내용 |
|------|------|
| **설치 후 감사 로그** | `loadOrCreateInstallerRegistry` 반환 타입 `LoadInstallerRegistryResult`(registry, created). Main에서 created 시 `INSTALL_START`·`INSTALL_SUCCESS` JSONL 기록. 서버 동기화 실패(첫 설치) 시 `INSTALL_FAIL` 기록 |
| **삭제 시도·복구 로그** | AgentGuard `handleTamperEvent`: file_deleted 시 `UNINSTALL_ATTEMPT` 추가. 복구 성공 시 `SELF_HEAL_SUCCESS`, 실패 시 `SELF_HEAL_FAIL` 기록 |
| **격리 모드** | 복구 실패 시 `enterIsolationMode`: `guard/isolation-mode.json` 저장 + `ISOLATION_MODE_ENTERED` 로그. `readIsolationState(baseDir)` export. Main: 시작 시 격리 여부 확인, `isolationModeActive`이면 잠금 창만 표시·showTrayInfo/트레이 전환·ONLINE 시 전환 차단, Dock activate 시 잠금 창 |

**파일 변경**

- `app/core/constants.ts`: PATHS.isolationMode
- `app/core/installer-registry.ts`: LoadInstallerRegistryResult, created 반환
- `app/core/agent-guard.ts`: IsolationState, handleTamperEvent(UNINSTALL_ATTEMPT·SELF_HEAL_*·enterIsolationMode), readIsolationState export
- `app/main/index.ts`: readIsolationState, isolationModeActive, 설치 블록(INSTALL_*), 격리 시 잠금 유지·전환 차단
- `simulator/scenarios.ts`: loadOrCreateInstallerRegistry 반환 구조 분해
- `docs/다음_개발_진행_사항.md`: §8 Phase 2 완료, 현재 완료 항목·마지막 점검
- `docs/개발_이력_리포트.md`: 27차 추가

---

## 2026-02-24 (26차) §8 인스톨/언인스톨 로그 코드 Phase 1 — constants 반영

**작업 요약**

| 구분 | 내용 |
|------|------|
| **로그 코드 상수** | `app/core/constants.ts`에 인스톨/언인스톨·복구·격리 모드 코드 추가: `INSTALL_START`, `INSTALL_SUCCESS`, `INSTALL_FAIL`, `INSTALL_ROLLBACK`, `UNINSTALL_REQUEST`, `UNINSTALL_ATTEMPT`, `UNINSTALL_SUCCESS`, `UNINSTALL_FAIL`, `SELF_HEAL_SUCCESS`, `SELF_HEAL_FAIL`, `ISOLATION_MODE_ENTERED` |
| **문서** | `docs/다음_개발_진행_사항.md` §8에 Phase 1 완료(로그 코드 상수 반영) 명시, 인스톨/언인스톨·복구·격리 실구현은 미구현으로 정리 |

**파일 변경**

- `app/core/constants.ts`: LOG_CODES에 인스톨/언인스톨/복구/격리 코드 추가
- `docs/다음_개발_진행_사항.md`: §8 Phase 1 완료·미구현 항목 정리
- `docs/개발_이력_리포트.md`: 26차 추가

---

## 2026-02-24 (25차) §7 잠금화면 강제 전체화면·Cmd+Tab 복귀·에이전트 크기 복원

**작업 요약**

| 구분 | 내용 |
|------|------|
| **잠금 강제 전체 화면** | 잠금 시 `setFullScreen(true)`, 해제/로그인 전환 시 `setFullScreen(false)`. `leave-full-screen` 시 잠금이면 `setFullScreen(true)` 재호출(ESC 우회 방지). |
| **에이전트/로그인 크기 복원** | `showTrayInfoInCurrentWindow`·`createLoginWindow`에서 `setFullScreen(false)` 후 `setSize(620,840)`/`setSize(520,620)` 및 setImmediate로 크기·포커스 재적용. |
| **Cmd+Tab/Alt+Tab 복귀** | `blur` 시 `app.focus({ steal: true })`·`win.moveTop()`·`setAlwaysOnTop`·`setFullScreen(true)`·`win.focus()`로 잠금창 재진입(macOS·Windows 공통). |
| **setVisibleOnAllWorkspaces** | 잠금 시 `true`, 해제/로그인 시 `false`(macOS 모든 공간 표시). |

**파일 변경**

- `app/main/index.ts`: attachMainWindowCloseHandler(leave-full-screen·blur), createLockWindow/showLockInWindow(setFullScreen·setVisibleOnAllWorkspaces·setImmediate), showTrayInfoInCurrentWindow/createLoginWindow(setFullScreen(false)·setVisibleOnAllWorkspaces(false)·setSize·setImmediate)
- `docs/다음_개발_진행_사항.md`: §7 잠금 강제 전체 화면·Cmd+Tab 복귀·Windows 동일 적용 반영
- `docs/다중_디스플레이_QA.md`: §2.4 Cmd+Tab/Alt+Tab 복귀 시나리오, §3 OS별 설명, §6 representedObject 터미널 경고 참고
- `docs/개발_이력_리포트.md`: 25차 추가

---

## 2026-02-13 (24차) FR-14 고객사 설정 Phase 4 — Draft/Publish/Rollback·정책 캐시·30분 폴링

**작업 요약**

| 구분 | 내용 |
|------|------|
| **정책 캐시** | Main에 `lastCachedLockPolicy`, `lastCachedLockPolicyAt`, `LOCK_POLICY_CACHE_TTL_MS`(30분). `fetchWorkTimeWithLockScreen`에서 캐시 유효 시 병합에 캐시 사용, 만료 시 getLockPolicy 조회 후 캐시 갱신. `mergeLockPolicyIntoData` 헬퍼 분리 |
| **30분 주기 폴링** | `startLockPolicyPolling()` — 로그인 시 `startLockCheckInterval`과 함께 시작. `TenantLockPolicy.version` 비교 후 변경 시 캐시 갱신. 로그아웃 시 `invalidateRuntimeConfigCache`에서 캐시·`policyPollingIntervalId` 클리어 |
| **Draft/Publish/Rollback API** | `api-client.ts`에 `postJson`, `saveLockPolicyDraft(tenantId, draft)`, `publishLockPolicy(tenantId, options?)`, `rollbackLockPolicy(tenantId)` 추가. 관리 콘솔/외부 도구 호출용(에이전트 일반 플로우에서는 미호출) |

**파일 변경**

- `app/core/api-client.ts`: postJson, saveLockPolicyDraft, publishLockPolicy, rollbackLockPolicy
- `app/main/index.ts`: TenantLockPolicy import, 정책 캐시 변수·invalidate 시 클리어, mergeLockPolicyIntoData, fetchWorkTimeWithLockScreen 캐시 사용, startLockPolicyPolling
- `docs/다음_개발_진행_사항.md`: §6 Phase 4 완료·남은 작업 정리, §15 정책 배포·캐시 반영, 현재 완료 항목 Phase 4 추가
- `docs/개발_이력_리포트.md`: 24차 추가

---

## 2026-02-13 (23차) FR-14 고객사 설정 Phase 3 — 전용 정책 API·이석해제 비밀번호

**작업 요약**

| 구분 | 내용 |
|------|------|
| **전용 정책 API** | `api-client.ts`에 `TenantLockPolicy`, `getLockPolicy(tenantId)`(GET lock-policy), `verifyLeaveSeatUnlock(password, reason?)`(POST verifyLeaveSeatUnlock.do) 추가. `WorkTimeResponse`에 `leaveSeatUnlockRequirePassword` 반영 |
| **Main 병합** | `fetchWorkTimeWithLockScreen`에서 getPcOffWorkTime 직후 `getLockPolicy(cachedUserServareaId)` 호출, 성공 시 policy의 lockScreen.screens·leaveSeatUnlockRequirePassword를 data에 병합 |
| **이석해제 비밀번호** | IPC `pcoff:requestPcOnWithLeaveSeatUnlock` — 비밀번호 검증 후 PC-ON(IN, Lock Off) 실행, stillLocked·에러 처리. Preload `requestPcOnWithLeaveSeatUnlock(password, reason?)` 노출 |
| **잠금화면 UI** | lock.html 이석 해제 비밀번호 모달(#leave-seat-unlock-modal). lock.js `showLeaveSeatUnlockPasswordModal()`, PC-ON 클릭 시 `leaveSeatPolicy.isLeaveSeat && work.leaveSeatUnlockRequirePassword`이면 해당 모달 → 확인 시 requestPcOnWithLeaveSeatUnlock 호출 |

**파일 변경**

- `app/core/api-client.ts`: TenantLockPolicy, getLockPolicy, verifyLeaveSeatUnlock, WorkTimeResponse.leaveSeatUnlockRequirePassword
- `app/main/index.ts`: fetchWorkTimeWithLockScreen 내 getLockPolicy 호출·병합, ipcMain.handle("pcoff:requestPcOnWithLeaveSeatUnlock")
- `app/preload/index.ts`: requestPcOnWithLeaveSeatUnlock 노출
- `app/renderer/lock.html`: 이석 해제 비밀번호 모달 마크업
- `app/renderer/lock.js`: coerceWorkTimeFromApi·DEFAULT_WORK에 leaveSeatUnlockRequirePassword, showLeaveSeatUnlockPasswordModal, PC-ON 클릭 분기
- `docs/다음_개발_진행_사항.md`: §6 Phase 3 완료·권장 순서 6번 체크, §15 이석해제 비밀번호 구현 완료 반영
- `docs/개발_이력_리포트.md`: 23차 추가

---

## 2026-02-13 (22차) FR-14 고객사 설정 Phase 2 — 잠금화면 배경·로고 이미지

**작업 요약**

| 구분 | 내용 |
|------|------|
| **배경·로고 API·config** | `WorkTimeResponse`·getLockScreenInfo에 `lockScreen*Background`/`lockScreen*Logo`(before/off/leave) 6개 필드 추가. config `lockScreen.before/off/leave`에 `backgroundUrl`·`logoUrl` 지원, Main에서 병합 후 Renderer로 전달 |
| **잠금화면 적용** | `applyLockScreenImages(work)`로 `screenType`별 body 배경 이미지·헤더 로고 이미지 적용. URL 없으면 기본(배경 없음·5240 텍스트 로고) 유지 |
| **UI** | lock.html에 `#lock-logo-img` 추가. URL 있으면 표시, 없으면 기존 `.logo-mark` 표시 |

**파일 변경**

- `app/core/api-client.ts`: WorkTimeResponse·getLockScreenInfo에 lockScreen*Background/Logo 6필드
- `app/main/index.ts`: fetchLockScreenFromUrl·fetchWorkTimeWithLockScreen·config 병합 시 배경·로고 URL 반영, getWorkTime catch fallback 포함
- `app/renderer/lock.js`: coerceWorkTimeFromApi에 6필드, applyLockScreenImages() 추가, applyLockInfo 내 호출
- `app/renderer/lock.html`: `.logo-item` 내 `<img id="lock-logo-img">` 추가
- `config.example.json`: lockScreen.before/off/leave에 backgroundUrl·logoUrl 예시
- `docs/다음_개발_진행_사항.md`: §6 Phase 2 완료·남은 작업 정리, §15 Phase 2 한 줄 추가
- `docs/개발_이력_리포트.md`: 22차 추가

---

## 2026-02-23 (21차) PC-ON 설계 정합·임시연장 유지·업데이트 확인 버튼 복귀

**작업 요약**

| 구분 | 내용 |
|------|------|
| **잠금화면 PC-ON (Flow-11)** | PC-ON 성공 후 getPcOffWorkTime으로 근태 갱신. 잠금 해제 시 에이전트(작동정보) 화면으로 전환, 아직 잠금(시업 전)이면 stillLocked 반환 → 잠금화면 토스트 "현재 PC-ON이 불가능합니다. 시업 시간에만 가능합니다.". API 실패 시 실패/에러 토스트. lock.js runAction에서 stillLocked·success===false 분기 |
| **임시연장 60분 유지** | TEMP_EXTEND 시 **연장 만료 시각 전까지** isLockRequired에서 lastWorkTimeData만 사용(2분 제한 제거). state.json에 tempExtendUntil·lastWorkTimeSnapshot 저장, 재시작 시 restoreTempExtendState() 복원. clearLoginState에서 해당 필드 제거 |
| **임시연장 조회 시 재잠금 방지** | getWorkTime·refreshMyAttendance 호출 시 TEMP_EXTEND이고 연장 만료 시각이 미래이면 lastWorkTimeData 덮어쓰지 않고, 반환 데이터만 pcOffYmdTime·pcExCount 로컬 값으로 병합 → 에이전트 화면에서 새로고침/조회해도 잠금·카운트 0으로 돌아가지 않음 |
| **업데이트 확인 버튼** | 패키징되지 않은 환경에서 electron-updater가 검사 스킵 시 이벤트 미수신 → 상태가 checking에 머무름. 150ms 대기 후에도 checking이면 not-available로 설정해 버튼이 "확인 중..."에서 복귀(update-manager.ts) |

**파일 변경**

- `app/main/index.ts`: PC-ON 핸들러에서 IN 성공 시 근태 갱신·잠금 여부 계산 후 해제 시 showTrayInfoInCurrentWindow / 미해제 시 stillLocked 반환. ActionResult에 stillLocked 추가. isLockRequired TEMP_EXTEND 시 연장 만료 시각 전까지 lastWorkTimeData 사용(2분 제한 제거). restoreTempExtendState·startLockCheckInterval에서 복원. getWorkTime·refreshMyAttendance에 TEMP_EXTEND 덮어쓰기 방지. requestPcExtend 성공 시 saveTempExtendState 호출
- `app/core/runtime-config.ts`: AppState에 tempExtendUntil·lastWorkTimeSnapshot. saveTempExtendState·loadTempExtendState 추가. clearLoginState에서 해당 필드 제거
- `app/renderer/lock.js`: runAction에서 result.stillLocked 시 "현재 PC-ON이 불가능합니다…" 토스트, success===false 시 에러 토스트
- `app/core/update-manager.ts`: checkAndApplySilently 후 상태가 checking이면 not-available로 설정
- `docs/다음_개발_진행_사항.md`: PC-ON·임시연장·업데이트 확인 버튼 문단 갱신
- `docs/잠금_및_적용정책_설명.md`: 임시연장 중 로컬 데이터 신뢰·state.json 복원 문단 추가
- `docs/개발_이력_리포트.md`: 21차 추가

---

## 2026-02-23 (20차) 성능·업데이트·임시연장·핫키·긴급사용 정리

**작업 요약**

| 구분 | 내용 |
|------|------|
| **성능** | getApiClient 시 loadRuntimeConfig 반복 호출 제거 — RUNTIME_CONFIG_CACHE_MS(1분) 캐시, 로그아웃 시 invalidateRuntimeConfigCache(). 작동정보 창: getTrayOperationInfo 캐시 우선 표시 후 백그라운드 refreshAttendance. 새로고침·로그폴더 버튼 디바운스(refreshInProgress, openLogsPending) |
| **업데이트** | UpdateManager ESM import 보강(autoUpdater default fallback), 업데이트 검사 로깅([UpdateManager] current version/checking/available/not-available/error). package.json publish.repo·repository.url → 5240-PCOFF-TEST(GitHub 실제 저장소명). docs/업데이트_릴리즈_점검.md 신규 — 자동 업데이트 미동작·적용할 업데이트 없음 점검, latest.yml·비공개 저장소, 릴리즈 절차 |
| **임시연장** | showTrayInfoInCurrentWindow() 추가 — 잠금 검사 없이 현재 창만 main.html 전환. requestPcExtend 성공 시 pcExCount를 서버 응답과 관계없이 extCount로 반영, pcOffYmdTime이 과거면 로컬에서 현재+pcExTime(분)으로 보정. TEMP_EXTEND_TRUST_LOCAL_MS(2분) 도입 — 임시연장 직후 2분간 isLockRequired에서 API 대신 lastWorkTimeData로 잠금 판단(서버 반영 지연 시 1분 후 재잠금 방지). 임시연장·긴급사용·PC-ON 성공 시 createTrayInfoWindow 대신 showTrayInfoInCurrentWindow 호출 |
| **잠금화면** | checkLockAndShowLockWindow: 이미 currentScreen===lock 이면 showLockInWindow 호출하지 않음(주기 호출 시 lock.html 재로드로 팝업 사라짐 방지). 주기 잠금 검사 시 checkLockAndShowLockWindow(mainWindow) 인자 전달 |
| **핫키** | Cmd/Ctrl+Shift+I를 createTrayInfoWindow → showTrayInfoInCurrentWindow로 변경(잠금화면에서도 강제로 작동정보 열기). 전역 핫키 즉시 등록, Windows에서 500ms 후 재등록. 등록 전 globalShortcut.unregister(accel)로 충돌 해제 |
| **긴급사용 인증번호** | 잠금화면 모달 문구: "관리자 또는 시스템에서 발급받은 인증번호를 입력…". docs/잠금_및_적용정책_설명.md·다음_개발_진행_사항.md에 인증번호 발송은 서버·관리자 책임, 추후 점검 항목으로 기록 |

**파일 변경**

- `app/main/index.ts`: RuntimeConfig 캐시·invalidateRuntimeConfigCache, showTrayInfoInCurrentWindow, requestPcExtend/requestEmergencyUse/PC-ON 성공 시 해당 함수 사용, TEMP_EXTEND_TRUST_LOCAL_MS·isLockRequired 임시연장 2분 로컬 신뢰, checkLockAndShowLockWindow 이미 잠금 시 reload 생략·주기 시 mainWindow 전달, I 핫키 showTrayInfoInCurrentWindow·즉시+재등록
- `app/renderer/main-info.js`, `build/main-info.js`: loadTrayOperationInfo 캐시 우선 후 void refreshAttendance, refreshInProgress·openLogsPending 디바운스
- `app/core/update-manager.ts`: ESM autoUpdater fallback, [UpdateManager] 로깅
- `package.json`: publish.repo 5240-PCOFF-TEST, repository.url 5240-PCOFF-TEST.git
- `app/renderer/lock.html`, `build/lock.html`: 긴급사용 모달 인증번호 문구·autocomplete=off
- `docs/업데이트_릴리즈_점검.md`: 신규
- `docs/잠금_및_적용정책_설명.md`: 긴급사용 인증번호 발송 책임·추후 점검 참고
- `docs/다음_개발_진행_사항.md`: 추후 점검 항목(긴급사용 인증번호) 추가

---

## 2026-02-23 (19차) 오프라인 유예 모달 반복 표시 완화

**작업 요약**

| 구분 | 내용 |
|------|------|
| **문제** | 네트워크 불안정 시 "네트워크 연결이 끊어졌습니다" 모달이 1분마다(또는 잦게) 반복 표시됨 — flush/API 1회 성공 시 즉시 ONLINE 전환 후 다시 실패 시 OFFLINE_GRACE로 되돌아가는 현상 |
| **조치 1** | OfflineManager 복구 시 **히스테리시스** 적용: OFFLINE_GRACE/OFFLINE_LOCKED에서 ONLINE으로 자동 복귀하려면 **연속 성공 2회** 필요. 수동 "다시 시도" 성공 시에는 기존처럼 즉시 ONLINE |
| **조치 2** | **로직 수정**: 서버 HTTP 4xx/5xx를 "오프라인"으로 치지 않음. reportAgentEvents flush 실패 시 예전에는 모든 예외에서 onHeartbeatFail 호출 → 네트워크는 정상인데 서버가 401/404/500을 주면 오프라인 모달 표시됨. 이제 HTTP 응답 오류(ReportAgentEventsHttpError)는 onHeartbeatFail 미호출. getPcOffWorkTime 실패 시에도 에러 메시지가 "failed: 4xx/5xx" 형태면 reportApiFailure("api") 호출 안 함 |

**파일 변경**

- `app/core/offline-manager.ts`: CONSECUTIVE_SUCCESS_THRESHOLD(2), consecutiveSuccessCount, reportApiSuccess(forceRecover?) 추가. retryConnectivity 성공 시 reportApiSuccess(true) 호출
- `app/core/api-client.ts`: ReportAgentEventsHttpError 클래스 추가, reportAgentEvents에서 !res.ok 시 해당 예외 throw
- `app/core/ops-observer.ts`: flushToServer catch에서 ReportAgentEventsHttpError가 아닐 때만 onHeartbeatFail 호출
- `app/main/index.ts`: isLockRequired catch에서 HTTP 4xx/5xx 패턴이면 reportApiFailure("api") 미호출
- `docs/다음_개발_진행_사항.md`, `docs/개발_이력_리포트.md`: 복구 연속 성공 2회·히스테리시스 및 HTTP 오류 미집계 설명 반영

---

## 2026-02-23 (18차) 잠금화면 설정값 불러오기·업데이트 버튼 정리

**작업 요약**

| 구분 | 내용 |
|------|------|
| **잠금화면 설정 불러오기** | getPcOffWorkTime에 lockScreen* 없을 때 getLockScreenInfo.do 시도 → 실패 시 config `lockScreenApiUrl`(WebView getScreenInfo.php) 호출 → config.json `lockScreen` 보강. 핫키/잠금창 오픈 시 선로드로 문구 적용 보장 |
| **API·config** | api-client: getLockScreenInfo(), LockScreenInfoItem/GetLockScreenInfoResponse. Main: fetchLockScreenFromUrl(url, userServareaId), fetchWorkTimeWithLockScreen(). config: lockScreenApiUrl, lockScreen(before/off/leave title·message) |
| **잠금화면 안내 문구** | 종업(off) 상세 안내(임시연장 N분·M회, 긴급사용)는 화면에 표시하지 않음. **「나의 근태정보 불러오기」** 클릭 시 근태정보 패널에서 확인. docs/잠금_및_적용정책_설명.md에 방법 기록 |
| **업데이트 재시작 버튼** | 적용할 업데이트가 없을 때 '지금 재시작' 버튼 노출 방지: getUpdateStatus가 downloaded여도 hasDownloadedUpdate()로 Main 확인 후 true일 때만 '지금 재시작' 표시. quitAndInstallUpdate 반환 applied:false 시 버튼을 '업데이트 확인'으로 복원 |

**파일 변경**

- `app/core/api-client.ts`: getLockScreenInfo(), LockScreenInfoItem, GetLockScreenInfoResponse
- `app/main/index.ts`: fetchLockScreenFromUrl(), fetchWorkTimeWithLockScreen(), createLockWindow/showLockInWindow 선로드, pcoff:hasDownloadedUpdate, getWorkTime 캐시(2.5초)·config 병합
- `app/preload/index.ts`: hasDownloadedUpdate
- `app/renderer/lock.js`, `build/lock.js`: applyLockInfo 종업(off) 본문은 lockScreenOffMessage만, fallback message 빈 문자열·lockInfoEl 비었을 때 display:none
- `app/renderer/main-info.js`, `build/main-info.js`: updateCheckButton(downloaded 시 hasDownloadedUpdate 확인), applied:false 시 버튼 복원
- `docs/잠금_및_적용정책_설명.md`: 잠금화면 상세 안내는 '나의 근태정보 불러오기'에서 확인한다는 문단 추가
- `PC_OFF_AGENT_API.md`: getLockScreenInfo.do, lockScreenApiUrl(WebView 호환) 문서
- `config.example.json`: lockScreenApiUrl, lockScreen 예시

---

## 2026-02-13 (17차) FR-14 고객사 설정 반영 Phase 1 (잠금화면 문구 동적 렌더링)

**작업 요약**

| 구분 | 내용 |
|------|------|
| **목표** | 고객사 설정(FR-14) Phase 1 — 잠금화면 제목·안내 문구를 서버에서 내려준 값으로 동적 표시 |
| **WorkTimeResponse** | lockScreenBeforeTitle/Message, lockScreenOffTitle/Message, lockScreenLeaveTitle/Message 필드 추가 (선택). 서버에서 미제공 시 기존 기본 문구 유지 |
| **Renderer** | lock.js applyLockInfo()에서 screenType별(before/empty/off)로 서버 문구 우선 적용, 없으면 fallback |

**파일 변경**

- `app/core/api-client.ts`: WorkTimeResponse에 FR-14 잠금화면 문구 6개 필드 추가
- `app/renderer/lock.js`, `build/lock.js`: applyLockInfo에서 lockScreen* 필드 우선 사용, fallback 유지
- `docs/다음_개발_진행_사항.md`: 6. 고객사 설정 Phase 1 완료·남은 작업 정리, 구현 순서 문구 갱신

**남은 작업(FR-14)**: 이미지·로고, 전용 정책 API 연동, Draft/Publish/Rollback, 이석해제 비밀번호 옵션

---

## 2026-02-13 (16차) API v1.9 코드 정합성 반영

**작업 요약**

| 구분 | 내용 |
|------|------|
| **기준** | PC_OFF_AGENT_API.md v1.9(엑셀) 규격에 맞춰 클라이언트 코드·UI 정합성 확보 |
| **WorkTimeResponse** | staYmdTime, endYmdTime, checkTime, workTypeCd/Nm, freeTimeWorkTypeYn, pcOffTargetYn, pcMealSta/EndTime, workZoneQtyType, emergencyUsePass, emergencyReasonYesNo, emergencySta/EndDate, nextYmd, leaveSeatReasonTime, weekCreWorkTime 등 주간 근로시간 필드, apiCallLogYesNo, pcoffLoginYn 등 전체 필드 타입 추가 |
| **recoder** | callCmmPcOnOffLogPrc 전송 시 `"PC-OFF(Electron)"` → `"PC-OFF"`(고정값)로 변경 |
| **callPcOffTempDelay** | `extCount` 파라미터 추가. 호출 시 lastWorkTimeData.pcExCount+1로 차수 전달 |
| **callPcOffEmergencyUse** | `emergencyUsePass`(인증번호)·`clickIp`(선택) 파라미터 추가. EmergencyUseRequest에 emergencyUsePass 필수, reason·clickIp 옵션 |
| **LoginResponse** | userMobileNo, resNm, message1~message5 필드 추가 |
| **긴급사용 UI** | 잠금/작동정보 화면 긴급사용 모달에 인증번호 입력 필드(emergency-pass-input) 추가. 확인 시 reason·emergencyUsePass 전달 |

**파일 변경**

- `app/core/api-client.ts`: WorkTimeResponse v1.9 전체 필드, recoder "PC-OFF", callPcOffTempDelay(pcOffYmdTime, extCount), EmergencyUseRequest(emergencyUsePass, reason?, clickIp?), callPcOffEmergencyUse payload, LoginResponse 보강
- `app/main/index.ts`: requestPcExtend 시 extCount 계산·전달, requestEmergencyUse 페이로드에 emergencyUsePass
- `app/preload/index.ts`: requestEmergencyUse(reason, emergencyUsePass?)
- `app/renderer/lock.html`, `index.html`: 긴급사용 모달에 인증번호 input 추가
- `app/renderer/lock.js`, `renderer.js`: showEmergencyReasonModal → { reason, emergencyUsePass } 반환, 버튼 핸들러에서 requestEmergencyUse(reason, emergencyUsePass) 호출
- `build/`: 동일 내용 반영

---

## 2026-02-23 (15차) PC_OFF_AGENT_API.md 규격 v1.9 최신화

**작업 요약**

| 구분 | 내용 |
|------|------|
| **기준** | 5240_COMMON_PC_OFF_API v1.9 (엑셀) 반영 |
| **추가** | Base URL(`https://api.5240.cloud`), 공통 응답 코드(§0.4), 각 API 전체 URL 및 Request/Response 파라미터 정리 |
| **수정** | 로그인 API 요청 파라미터: `loginServareaId`, `loginUserId`, `loginPassword` 명시. 로그기록 API: `userServareaId`, `userStaffId`, `workYmd`, `recoder`, `emergencyYn`, 이석 비근무시간(`leaveSeatOffInputMath`) 규칙. 임시연장: `extCount`, 긴급사용: `clickIp` |

**문서 변경**

- `PC_OFF_AGENT_API.md`: 규격 기준·Base URL·에러코드(0.4), 2.1~2.6 요청/응답 파라미터 엑셀 v1.9 기준으로 보강. 2.7·2.8은 To‑Be 전용으로 Base URL 적용 명시.
- `docs/5240_COMMON_PC_OFF_API_v1.9_원본시트.md`: **신규** — 엑셀 `5240_COMMON_PC_OFF_API_v1.9.xlsx` 8개 워크시트를 그대로 문서화(API 리스트, Error Code, 각 API REQUEST/RESPONSE/NOTE). 구현 시에는 `PC_OFF_AGENT_API.md` 참고.

---

## 2026-02-23 (14차) FR-15 긴급해제(비밀번호 기반) 구현

**구현 요약**

| 구분 | 내용 |
|------|------|
| **목표** | 잠금 상태에서 비밀번호 검증 후 잠금 해제, 5회 초과 시 5분 차단, 성공 후 3시간 만료 시 재잠금 |
| **노출 조건** | emergencyUnlockUseYn=YES && emergencyUnlockPasswordSetYn=Y && 잠금 상태 |
| **상태 머신** | active(3시간 타이머), failureCount, lockedUntil(5분 차단), emergency-unlock-state.json 저장·복원 |

**파일 변경**

- `app/core/constants.ts`: PATHS.emergencyUnlockState, 로그코드 6종(EMERGENCY_UNLOCK_ATTEMPT/SUCCESS/FAILED/LOCKED/EXPIRED/EXPIRY_WARNING) 추가
- `app/core/api-client.ts`: EmergencyUnlockRequest/Response 인터페이스, PcOffApiClient.callPcOffEmergencyUnlock(), WorkTimeResponse에 emergencyUnlockUseYn/emergencyUnlockPasswordSetYn 필드 추가
- `app/core/emergency-unlock.ts`: **신규** — EmergencyUnlockManager(attempt/restore/deactivate/stop), 5회 초과 5분 lockout, 성공 시 3시간 만료 타이머·5분 전 예고, emergency-unlock-state.json 저장·복원
- `app/main/index.ts`: EmergencyUnlockManager 생성·restore(), setCallback(expired→잠금 복귀·모드 리셋, expiry_warning→IPC 전송), isLockRequired에서 긴급해제 활성 시 잠금 스킵, pcoff:requestEmergencyUnlock·pcoff:getEmergencyUnlockState·pcoff:getEmergencyUnlockEligibility IPC 추가, before-quit 시 stop()
- `app/preload/index.ts`: requestEmergencyUnlock, getEmergencyUnlockState, getEmergencyUnlockEligibility, onEmergencyUnlockExpiring, onEmergencyUnlockExpired 노출
- `app/renderer/lock.html`: 긴급해제 버튼(btn-emergency-unlock), 비밀번호 입력 모달(emergency-unlock-modal), 만료 예고 배너(emergency-unlock-expiry-banner) 추가
- `app/renderer/lock.js`: showEmergencyUnlockModal(비밀번호 입력·서버 검증·결과 표시), checkEmergencyUnlockEligibility(노출 조건 확인), setupEmergencyUnlockListeners(만료 예고·만료 이벤트 수신)

---

## 2026-02-20 (13차) FR-17 오프라인 복구·잠금 구현

**구현 요약**

| 구분 | 내용 |
|------|------|
| **목표** | 오프라인 감지 시 30분 유예(OFFLINE_GRACE) 후 미복구 시 잠금(OFFLINE_LOCKED), 복구 시 자동 해제 |
| **상태 머신** | ONLINE → OFFLINE_GRACE(30분) → OFFLINE_LOCKED. 감지: heartbeat 3회 연속 실패 또는 핵심 API 2회 연속 실패 |
| **복구** | reportApiSuccess()(오프라인 상태에서는 연속 성공 2회 필요) 또는 retryConnectivity()(즉시 ONLINE)로 복귀. 앱 재시작 시 offline-state.json 복원 |

**파일 변경**

- `app/core/constants.ts`: PATHS.offlineState, 로그코드 4종(OFFLINE_GRACE_STARTED, OFFLINE_RETRY, OFFLINE_TIMEOUT_LOCK, OFFLINE_RECOVERED) 추가
- `app/core/offline-manager.ts`: **신규** — 상태 머신, 30분 유예 타이머, offline-state.json 저장/복원, reportApiFailure/reportApiSuccess(복구 시 연속 성공 2회)/retryConnectivity
- `app/core/ops-observer.ts`: OpsObserverCallbacks(onHeartbeatFail/onHeartbeatSuccess), setCallbacks(), flushToServer 성공/실패 시 콜백 호출
- `app/main/index.ts`: OfflineManager 생성·restore(), observer.setCallbacks 연동, isLockRequired 성공/실패 시 offlineManager 보고, onStateChange 시 잠금화면 전환·IPC, pcoff:getConnectivityState·pcoff:retryConnectivity, before-quit 시 offlineManager.stop()
- `app/preload/index.ts`: getConnectivityState, retryConnectivity, onConnectivityChanged 노출
- `app/renderer/lock.html`: FR-17 오프라인 유예/잠금 오버레이(아이콘, 카운트다운, 다시 시도 버튼) 추가
- `app/renderer/lock.js`: showOfflineOverlay/hideOfflineOverlay, setupConnectivityListener, onConnectivityChanged·getConnectivityState 연동
- `docs/operations/logcode.md`: FR-17 로그코드 4종 이미 반영됨(추가 수정 없음)

---

## 2026-02-13 (12차) 맥 설치 앱 "Not allowed to load local resource" 수정

**수정 요약**

| 구분 | 내용 |
|------|------|
| **원인** | 맥에서 패키징된 앱 실행 시 `loadFile()`이 asar 내부 경로를 `file://` URL로 로드하려다 보안 정책에 의해 차단됨. 오류: `Not allowed to load local resource: file:///.../app.asar/app/renderer/main.html` |
| **조치** | 커스텀 프로토콜 `app://` 등록. 맥 + 패키징 시에만 `protocol.handle("app", ...)`로 asar 내 HTML/JS/CSS 등을 읽어 Response로 반환하고, 모든 창 로드는 `loadRendererInWindow(win, htmlFile)`로 통일 — 이때 `app://./app/renderer/xxx.html`로 loadURL |
| **적용 범위** | `index.html`, `lock.html`, `main.html` 모두 `loadRendererInWindow` 경유. 개발·Windows는 기존대로 `loadFile(getRendererPath(...))` 사용 |

**파일 변경**

- `app/main/index.ts`: `protocol` import, `registerSchemesAsPrivileged("app")`, `getRendererUrl`/`loadRendererInWindow` 추가, whenReady 시 맥·패키징일 때만 `protocol.handle("app", ...)` 등록, 모든 renderer 로드를 `loadRendererInWindow`로 변경

---

## 2026-02-13 (11차) Windows 트레이 아이콘 표시 개선

**수정 요약**

| 구분 | 내용 |
|------|------|
| **Fallback 아이콘** | 기존 base64 fallback이 검은색이라 어두운 작업표시줄에서 안 보이던 문제 해결. `createTrayFallbackIcon()`로 16×16 밝은 회색(RGB 0xC0) 버퍼 생성 후 `nativeImage.createFromBuffer` 사용 — 칸은 있으나 비어 보이던 현상 완화 |
| **Windows ICO 후보** | Electron 문서 권장대로 Windows에서 트레이용 `icon.ico` 경로를 후보에 추가(resourcesPath/appPath/__dirname 기준). ICO는 다중 해상도 지원 시 트레이 표시가 안정적 |
| **extraResources** | icon.ico는 현재 프로젝트에 없어 extraResources에는 넣지 않음. 나중에 `assets/icon.ico`를 추가한 뒤 extraResources에 포함하면 Windows 트레이에서 ICO 우선 사용 가능 |

**파일 변경**

- `app/main/index.ts`: `createTrayFallbackIcon()` 추가, 트레이 후보에 Windows용 icon.ico 경로 추가, fallback 시 data URL 대신 위 함수 사용

---

## 2026-02-20 (10차) 잠금·적용정책 문서화·Windows 트레이 아이콘 보완

**수정 요약**

| 구분 | 내용 |
|------|------|
| **잠금·적용정책 문서** | `docs/잠금_및_적용정책_설명.md` 신규. 「적용 정책」= 표시용 screenType(before/off/empty). 실제 잠금 트리거는 서버 `pcOnYn === "N"`만. pcOnYn 확인 주기 1분(LOCK_CHECK_INTERVAL_MS), 즉시 확인 시점(로그인 직후·작동정보 열 때) 명시 |
| **Windows 트레이 아이콘** | `assets/tray-icon.png`가 비어 있거나 asar 경로에서 안 보이던 문제 대응. `package.json` extraResources에 `assets/tray-icon.png` 추가. createTray에서 `process.resourcesPath` 우선 후보로 로드. 5240 로고 스타일 16×16 트레이 아이콘으로 교체 |

**파일 변경**

- `docs/잠금_및_적용정책_설명.md`: 신규
- `README.md`: 문서 목록에 잠금_및_적용정책_설명 링크 추가
- `package.json`: extraResources에 tray-icon.png 추가
- `app/main/index.ts`: 트레이 아이콘 후보에 resourcesPath 우선
- `assets/tray-icon.png`: 5240 두 톤 스타일 16×16 PNG로 교체

---

## 2026-02-20 (9차) 자동 업데이트·버전정보·로그 폴더 보완

**수정 요약**

| 구분 | 내용 |
|------|------|
| **자동 업데이트** | GitHub Release 자산명을 electron-updater 규격에 맞게 수정. `win-x64/latest.yml` → `latest.yml` 등 경로 없이 업로드되도록 release 워크플로우에서 `release-assets/` 플랫 업로드 단계 추가. `package.json` publish에 `owner`, `repo` 명시 |
| **버전정보 UI** | "마지막 업데이트" 라벨을 "조회 시각"으로 변경(의미: 정보 조회 시각). App Version은 설치된 빌드 기준(`app.getVersion()`)이라 릴리즈만 올려도 바뀌지 않음 — 새 버전 설치·재시작 후 반영 |
| **업데이트 확인 버튼** | 작동정보 화면(main.html)에 "업데이트 확인" 버튼 추가. 기존에는 로그인 화면(index.html)에만 있어 작동정보에서 동작 없음. main-info.js에서 `requestUpdateCheck()`·`onUpdateProgress` 연동, 상태별 버튼 문구·토스트 표시 |
| **로그 폴더** | 앱 시작 시 `userData/logs` 폴더 생성. IPC `pcoff:getLogsPath`, `pcoff:openLogsFolder` 추가. 작동정보 화면 버전정보에 "로그 폴더 열기" 버튼 — 클릭 시 해당 폴더 생성 후 탐색기/Finder로 열기 |

**파일 변경**

- `.github/workflows/release.yml`: Flatten release assets 단계, `cd release-assets` 후 업로드
- `package.json`: publish.owner, publish.repo
- `build/main.html`: 버전정보에 "업데이트 확인" 버튼, "조회 시각" 라벨, "로그 폴더 열기" 버튼
- `app/renderer/main-info.js`: checkUpdateEl, updateCheckButton(), 업데이트 확인 클릭·onUpdateProgress, openLogsFolder 클릭
- `app/main/index.ts`: PATHS import, 앱 시작 시 `mkdirSync(logsDir)`, ipcMain getLogsPath·openLogsFolder
- `app/preload/index.ts`: getLogsPath, openLogsFolder

**로그 폴더 경로 (참고)**  
- Windows: `%APPDATA%\5240 PcOff Agent\logs\`  
- Mac: `~/Library/Application Support/5240 PcOff Agent/logs/`

---

## 2026-02-13 (8차) 이석정보 서버 전송 (FR-12)

**구현 내용**

| 항목 | 상세 |
|------|------|
| **leave-seat-reporter** | `app/core/leave-seat-reporter.ts` — `LeaveSeatReporter` 클래스. 세션 기반(`leaveSeatSessionId`) START/END 전송, 중복 START 방지·START 없이 END 금지. reason 200자·제어문자 제거 |
| **API** | `app/core/api-client.ts` — `reportLeaveSeatEvent(baseUrl, payload)` 추가. `POST /reportLeaveSeatEvent.do`. 요청/응답 타입 `LeaveSeatReportRequest`, `LeaveSeatReportResponse` |
| **재시도 큐** | `leave-seat-queue.jsonl` — 전송 실패 시 JSONL 적재, 지수 백오프(10s→30s→60s→5m→15m), 최대 10회, 30초 주기 플러시 |
| **Main 연동** | 이석 감지(Idle/Sleep) 시 `reportStart(reason, workSessionType, detectedAt)`, PC-ON 해제 시 `reportEnd(reason)`. 로그인 시 `start()`, 로그아웃·앱 종료 시 `stop()`. `pcoff:checkLockAndShow`·로그인 성공 시 캐시 갱신·reporter 시작 |
| **로그 코드** | `LEAVE_SEAT_START`, `LEAVE_SEAT_END`, `LEAVE_SEAT_REPORT_FAILED`, `LEAVE_SEAT_REPORT_RETRY` (`constants.ts`·`logcode.md`) |

**파일 변경**

- `app/core/leave-seat-reporter.ts`: 신규
- `app/core/api-client.ts`: reportLeaveSeatEvent, LeaveSeatReportRequest/Response
- `app/core/constants.ts`: LEAVE_SEAT_START/END/REPORT_FAILED/REPORT_RETRY, PATHS.leaveSeatQueue
- `app/main/index.ts`: LeaveSeatReporter import·초기화·연동, 캐시(cachedApiBaseUrl 등), 로그인/로그아웃/quit 시 start/stop
- `PC_OFF_AGENT_API.md`: 2.8 이석정보 서버 전송, 시나리오-API 매핑에 reportLeaveSeatEvent.do 추가
- `docs/다음_개발_진행_사항.md`: 3번 이석정보 서버 전송 완료 표시, 현재 완료 항목에 FR-12 추가

---

## 2026-02-20 (7차) 시업/종업 화면 표시 로직 (FR-13)

**구현 내용**

| 항목 | 상세 |
|------|------|
| **screen-display-logic** | `app/core/screen-display-logic.ts` — `resolveScreenType(work, now, isLeaveSeat)`. 옵션 1227(`exCountRenewal`) YYYYMMDDHH24MI 파싱, now < exCountRenewal → 종업(off), now ≥ exCountRenewal → 시업(before). 이석(empty)은 서버/로컬 유지 |
| **API 타입** | `WorkTimeResponse`에 `screenType`, `exCountRenewal` 추가. `ScreenType` 타입 export |
| **Main 연동** | `applyResolvedScreenType()` — 근태 캐시·getWorkTime·getTrayOperationInfo·refreshMyAttendance·requestPcExtend 시 resolved screenType 적용. 잠금화면 표시 시 SCREEN_TYPE_BEFORE/SCREEN_TYPE_OFF 로그 |
| **로그 코드** | `SCREEN_TYPE_BEFORE`, `SCREEN_TYPE_OFF`, `SCREEN_TYPE_USABLE`, `SCREEN_TRANSITION` (constants.ts·logcode.md) |

**파일 변경**
- `app/core/screen-display-logic.ts`: 신규
- `app/core/api-client.ts`: WorkTimeResponse에 screenType, exCountRenewal, ScreenType 타입
- `app/core/constants.ts`: SCREEN_TYPE_* 4종 추가
- `app/main/index.ts`: resolveScreenType import, applyResolvedScreenType, 캐시/IPC 반환 시 적용, 잠금화면 표시 시 로그
- `PC_OFF_AGENT_API.md`: getPcOffWorkTime 응답에 screenType·exCountRenewal 문서화
- `docs/다음_개발_진행_사항.md`: 시업/종업 화면 표시 로직 완료 표시

---

## 2026-02-20 (6차) 설치·로그인 흐름 정리·창 크기·문서

**구현 내용**

| 항목 | 상세 |
|------|------|
| **로그인 판단** | 로그인 정보는 **state.json에서만** 읽도록 변경. config.json fallback 제거 → 신규/재설치 시 로그인 정보 없으면 반드시 로그인 화면 표시. |
| **번들 config** | 설치 앱 첫 실행 시 userData config는 **apiBaseUrl만** 복사. 기존 설치의 config.json에 남은 로그인 필드는 시작 시 자동 제거(마이그레이션). |
| **로그아웃** | clearLoginState에서 state + config 양쪽 로그인 정보 제거. 로그아웃 시 잠금 체크 타이머 중지·캐시 초기화 → 로그인 화면으로 확실히 전환. |
| **창 크기** | 로그인 480×560 → 520×620, 작동정보 560×760 → 620×840, 잠금화면 960×640 → 1040×720. |
| **문서** | 다음_개발_진행_사항: 패키징 검증(코드 서명·notarization)은 마지막에 진행으로 명시. 맥_설치_가이드·테스트_가이드_비개발자 로그인/로그아웃 안내 보강. |
| **로그 코드 전수 반영** | `constants.ts`에 누락 로그 코드 8종(LOGIN_SUCCESS/FAIL, LOGOUT, LOCK/UNLOCK_TRIGGERED, TRAY_INFO_OPENED, TRAY_ATTENDANCE_REFRESHED, TRAY_MODE_CHANGED) 추가. 코드 전체에서 문자열 리터럴 → `LOG_CODES` 상수로 교체. `logcode.md`에 `INSTALLER_REGISTRY_FAIL` 추가. 현재 구현 34개 동기화 완료. |

**파일 변경**
- `app/core/constants.ts`: LOG_CODES에 LOGIN_SUCCESS/FAIL, LOGOUT, LOCK/UNLOCK_TRIGGERED, TRAY_* 8종 추가, 카테고리 주석 정리
- `app/main/index.ts`: 문자열 리터럴 logger.write 12건 → LOG_CODES 상수로 교체, 번들 config apiBaseUrl만 저장, config 마이그레이션, 로그아웃 타이머 중지·캐시 초기화, 창 크기 조정
- `app/core/ops-observer.ts`: 문자열 리터럴 "INSTALLER_REGISTRY_SYNC" → LOG_CODES 상수로 교체
- `app/core/runtime-config.ts`: loadRuntimeConfig에서 userServareaId/userStaffId를 state만 참조, clearLoginState에서 config.json 정리
- `config.example.json`: 로그인 정보 제거(apiBaseUrl만 유지)
- `docs/operations/logcode.md`: INSTALLER_REGISTRY_FAIL 추가, Last Updated 갱신
- `docs/다음_개발_진행_사항.md`: 로그 코드 전수 반영 완료 표시, 맥_설치_가이드·테스트_가이드_비개발자 반영

---

## 2026-02-20 (5차) CI·릴리스·GitHub 자동 업데이트·패키징

**구현 내용**

| 항목 | 상세 |
|------|------|
| **release 워크플로우** | `.github/workflows/release.yml` — 태그 푸시(v*) 시 Windows x64·Mac 빌드 후 GitHub Release에 업로드. Windows: windows-latest, Mac: macos-latest. Mac 빌드 실패 시에도 Windows 릴리스 진행(continue-on-error). |
| **자동 업데이트** | package.json `publish.provider: "github"`, `repository` 추가. 설치된 앱이 GitHub Release에서 새 버전 확인·자동 적용. |
| **Mac 빌드** | entitlements.mac.plist 신규(Hardened Runtime). Mac 아티팩트 다운로드 optional(continue-on-error). |
| **사용자별 설치 파일** | README에 Windows → .exe, Mac → .dmg/.zip 안내. 사용자별 설치 파일(배포 시) 섹션 추가. |
| **푸시 용량 초과** | docs/깃_푸시_용량초과_해결.md 신규. release/ .gitignore 유지, 히스토리에서 release/ 제거 방법(filter-branch) 및 force push 안내. |

**파일 변경**
- `.github/workflows/release.yml`: Windows·Mac 빌드, release job, Mac continue-on-error
- `package.json`: publish provider github, repository
- `entitlements.mac.plist`: 신규
- `README.md`: Windows 설치 파일 빌드, CI·릴리스, 사용자별 설치 파일, 자동 업데이트 연동
- `docs/깃_푸시_용량초과_해결.md`: 신규

---

## 2026-02-19 (4차) 이석 API 정규화·설정값 로그

**구현 내용**

| 항목 | 상세 |
|------|------|
| **leaveSeatUseYn 정규화** | 서버가 `"YES"`/`"NO"`로 내려줘도 이석 감지가 동작하도록 `normalizeLeaveSeatUseYn()` 도입. `"Y"`/`"YES"` → `"Y"`, 그 외 → `"N"`. `isLockRequired`, `getWorkTime`, 기동 시 detector 정책 등 정책을 넘기는 모든 경로에서 사용. (1분 유휴 미동작 원인 수정) |
| **터미널 설정값 로그** | 앱 기동 시·로그인 시·근태 로드 시 로드된 설정·근태정보를 `[PCOFF] 설정값:` 접두사로 터미널에 출력. 런타임 설정, 로그인 사용자, getPcOffWorkTime/getWorkTime 응답 요약. |

**파일 변경**
- `app/main/index.ts`: `normalizeLeaveSeatUseYn()`, `logLoadedConfig()` 호출, detector 정책 전달 시 정규화 적용

---

## 2026-02-19 (3차) 로컬 이석/절전 감지 구현 (FR-11)

**구현 내용**

| 항목 | 상세 |
|------|------|
| **LeaveSeatDetector** | `app/core/leave-seat-detector.ts` — Idle: `powerMonitor.getSystemIdleTime()` 5초 폴링, 정책(leaveSeatUseYn, leaveSeatTime 분) 초과 시 이석 감지. 절전: suspend 시각 기록, resume 시 경과 >= leaveSeatTime 이면 이석 감지(leaveDetectedAt=절전 시작 시각). |
| **정책** | `getPcOffWorkTime` 응답의 `leaveSeatUseYn`, `leaveSeatTime`으로 갱신. `WorkTimeResponse.leaveSeatTime` 추가(api-client). |
| **로컬 상태 병합** | `localLeaveSeatDetectedAt` 설정 시 `getWorkTime` 응답에 `screenType=empty`, `leaveSeatOffInputMath` 병합 → 기존 이석 화면·사유 입력 흐름 재사용. |
| **잠금 표시** | 이석 감지 시 `showLockForLocalLeaveSeat()` → 잠금화면 표시. PC-ON 성공 시 로컬 상태 클리어, `LEAVE_SEAT_RELEASED` 로그. |
| **로그 코드** | `LEAVE_SEAT_IDLE_DETECTED`, `LEAVE_SEAT_SLEEP_DETECTED`, `LEAVE_SEAT_RELEASED`, `SLEEP_ENTERED`, `SLEEP_RESUMED` (constants.ts). |

**파일 변경**
- `app/core/leave-seat-detector.ts`: 신규
- `app/core/api-client.ts`: WorkTimeResponse에 leaveSeatTime 추가
- `app/core/constants.ts`: 로그 코드 6종 추가
- `app/main/index.ts`: detector 시작/정책/병합/해제, formatYmdHm, showLockForLocalLeaveSeat
- `app/renderer/lock.js`: leaveSeatTime in DEFAULT_WORK·coerceWorkTimeFromApi

---

## 2026-02-19 (2차) 이석 감지·해제 플로우 구현 (Flow-02, FR-11)

**구현 내용**

| 항목 | 상세 |
|------|------|
| **leave-seat.ts 신규** | `app/core/leave-seat.ts` — `calcLeaveSeatPolicy()` 함수. `screenType=empty` 여부, 사유 입력 필수(`leaveSeatReasonYn=YES && leaveSeatReasonManYn=YES`) 여부, 휴게시간 면제(`breakStartTime~breakEndTime`) 여부를 하나의 정책 객체로 반환. |
| **이석 사유 입력 모달** | `lock.html`에 `#leave-seat-modal` 추가. 이석 감지 시각(`leaveDetectedAt`) 안내 + 사유 텍스트 입력 + PC-ON 확인 버튼. |
| **PC-ON 버튼 분기** | `lock.js`: 버튼 클릭 시 `leaveSeatPolicy.requireReason`이면 모달 → 사유 입력 후 `requestPcOnOffLog("IN", …, reason, true)` 호출. 휴게시간이면 모달 없이 바로 PC-ON. 일반이면 기존 동작. |
| **이석 로그** | `lock.js`: 화면 로드 시 이석 상태이면 `LEAVE_SEAT_DETECTED` 로그. PC-ON 성공 시 main에서 `LEAVE_SEAT_UNLOCK`, 사유 있으면 `LEAVE_SEAT_REASON_SUBMITTED` 추가 기록. |
| **로그 코드 추가** | `constants.ts`: `LEAVE_SEAT_DETECTED`, `LEAVE_SEAT_UNLOCK`, `LEAVE_SEAT_REASON_SUBMITTED`, `LEAVE_SEAT_BREAK_EXEMPT` |
| **preload 업데이트** | `requestPcOnOffLog`에 `isLeaveSeat` 파라미터 추가. |
| **시뮬레이터** | `leave_seat_reason_required`(Flow-02), `leave_seat_break_exempt`(Flow-02b) 두 시나리오 추가. 전체 10개 PASS. |

**파일 변경**
- `app/core/leave-seat.ts`: 신규 (이석 정책 모듈)
- `app/core/constants.ts`: LEAVE_SEAT_* 로그 코드 4종 추가
- `app/renderer/lock.html`: `#leave-seat-modal` 추가
- `app/renderer/lock.js`: 이석 정책 계산, 모달, PC-ON 분기, 로그
- `app/main/index.ts`: `requestPcOnOffLog` IPC에 `isLeaveSeat` 분기, LEAVE_SEAT 로그
- `app/preload/index.ts`: `requestPcOnOffLog` 시그니처에 `isLeaveSeat` 파라미터
- `simulator/scenarios.ts`: `leave_seat_reason_required`, `leave_seat_break_exempt` 시나리오 추가
- `simulator/cli.ts`: `ALL_SCENARIOS`에 두 시나리오 추가

---

## 2026-02-19 잠금화면 닫기 방지 확인 + 설치자 레지스트리(FR-09) 구현

**구현 내용**

| 항목 | 상세 |
|------|------|
| **잠금화면 닫기 방지** | `currentScreen` 상태 변수(`"login" \| "lock" \| "tray-info"`)로 분기. `lock` 시 `event.preventDefault()`로 X 버튼 완전 차단. `tray-info` 시 `hide()`로 트레이 숨김. `login` 시 일반 닫기 허용. 사용자 직접 확인 완료. |
| **로그아웃 핫키(잠금 중)** | `doGlobalLogout()`에서 `mainWindow.close()` 대신 `createLoginWindow()` 직접 호출. close 이벤트 차단 우회. |
| **설치자 레지스트리** | `app/core/installer-registry.ts` 신규. `deviceId`(UUID), `installedAt`, `platform`, `osRelease`, `hostname`, `appVersion`, `installerStaffId` 수집·저장(`installer-registry.json`). 앱 시작 시 `syncStatus !== "synced"`이면 서버 동기화 재시도. |
| **서버 동기화 API** | `POST /registerInstallerInfo.do` 호출. 실패 시 `syncStatus="failed"` 기록 후 다음 실행 시 재시도. |
| **로그 코드 추가** | `INSTALLER_REGISTRY_SYNC`, `INSTALLER_REGISTRY_FAIL` 추가(`constants.ts`). |
| **시뮬레이터** | `installer_registry_sync` 시나리오 실제 모듈 연동. `--scenario` CLI 파싱 버그 수정(`indexOf` → `lastIndexOf`). |

**파일 변경**
- `app/main/index.ts`: `currentScreen` 상태, `attachMainWindowCloseHandler`, `doGlobalLogout` 수정, installer-registry 초기화/동기화 코드 추가
- `app/core/installer-registry.ts`: 신규 (InstallerRegistry 인터페이스, `loadOrCreateInstallerRegistry`, `syncInstallerRegistry`)
- `app/core/constants.ts`: `PATHS.installerRegistry`, `LOG_CODES.INSTALLER_REGISTRY_SYNC/FAIL` 추가
- `simulator/scenarios.ts`: `installer_registry_sync` 시나리오 실제 모듈 실행
- `simulator/cli.ts`: `lastIndexOf("--scenario")` 적용

---

## 2026-02-13 (추가) 단일 창 통합·버튼 전환·Enter 키·전역 핫키·트레이 아이콘

**구현 내용**

| 항목 | 상세 |
|------|------|
| **단일 창(mainWindow)** | 작동정보·로그인·잠금화면을 하나의 `mainWindow`에서 전환. 새 창 없이 동일 창에서 `main.html` / `index.html` / `lock.html` 로드. |
| **PC-ON** | `callCmmPcOnOffLogPrc` IN 성공 시 `createTrayInfoWindow()` 호출 → 같은 창에서 **작동정보 화면**으로 전환. |
| **긴급사용** | `callPcOffEmergencyUse` 성공 시 `createTrayInfoWindow()` 호출 → 같은 창에서 **작동정보 화면**으로 전환. |
| **로그인 → 잠금** | 로그인 성공 후 `checkLockAndShow` 시 기존 로그인 창에 `lock.html` 로드(`showLockInWindow`), `closeCurrentWindow` 호출하지 않음. |
| **로그인 Enter 키** | 전화번호 입력 후 Enter → 다음 버튼 동작. 서비스 영역·ID·비밀번호 입력 후 Enter → 로그인 버튼 동작. (`renderer.js`) |
| **전역 단축키** | Cmd/Ctrl+Shift+L(로그아웃), I(작동정보), K(잠금화면), Ctrl+Shift+Q(강제 종료·맥은 Control(⌃)만 사용). `globalShortcut` 등록, `before-quit`에서 `unregisterAll`. |
| **트레이 아이콘** | `scripts/create-tray-icon.mjs`로 16×16 PNG 생성(postbuild). `assets/tray-icon.png` 없을 때 Base64 fallback. macOS에서 `setTemplateImage(true)` 적용. |

**파일 변경**
- `app/main/index.ts`: `trayWindow`/`lockWindow` → `mainWindow` 통합, PC-ON/긴급사용 시 `createTrayInfoWindow()`, 전역 핫키 I/K
- `app/renderer/renderer.js`: 로그인 단계별 Enter 키 리스너, 로그인 성공 시 `lockOpened`면 `closeCurrentWindow()` 미호출
- `package.json`: postbuild에 `create-tray-icon.mjs` 추가
- `scripts/create-tray-icon.mjs`: 신규 (Node 내장 zlib/fs로 PNG 생성)

---

## 2026-02-13

### 에이전트 UI·잠금화면 UI 분리 구현

**요구사항**
- 트레이에서 에이전트 정보를 조회할 수 있는 전용 화면 필요
- 잠금화면과 에이전트 정보 화면을 분리하여 각각의 역할에 맞게 UI 제공
- 액션 버튼(임시연장/긴급사용 등)은 잠금화면에만 배치

**구현 내용**

| 항목 | 상세 |
|------|------|
| 에이전트 정보 화면 | `app/renderer/main.html` + `main-info.js` |
| 잠금화면 | `app/renderer/lock.html` + `lock.js` |
| 로그인 화면 | `app/renderer/index.html` + `renderer.js` (기존 유지) |
| 시스템 트레이 | `createTray()`, `updateTrayMenu()` - 메뉴 및 클릭 이벤트 |
| 창 관리 | **현재**: `mainWindow` 단일 창에서 세 화면 전환 (위 2026-02-13 추가 참고). 당시에는 `trayWindow`/`lockWindow` 분리였음. |

**에이전트 정보 화면 (main.html)**
- 트레이 클릭 또는 메뉴에서 "PCOFF 작동정보" 선택 시 표시
- 액션 버튼 없음, 정보 조회 전용
- 표시 항목: 현재 반영 근태정보, 나의 근태정보, 버전정보, 현재 모드
- 새로고침 버튼으로 근태정보 갱신 가능

**잠금화면 (lock.html)**
- PC 사용 제한 시 표시
- 기존 main-view의 모든 기능 유지 (임시연장/긴급사용/PC-ON/PC-OFF)
- 비밀번호 변경 모달, 긴급사용 사유 모달 포함

**시스템 트레이**
- 메뉴 항목: PCOFF 작동정보, 잠금화면 열기, 로그 폴더 열기, 현재 모드 표시, 종료
- 트레이 클릭 시 작동정보 화면 열기
- 창이 모두 닫혀도 트레이에서 앱 유지 (트레이 앱 모드)

**운영 모드 관리**
- `NORMAL`, `TEMP_EXTEND`, `EMERGENCY_USE`, `EMERGENCY_RELEASE` 상태 추적
- 모드 변경 시 모든 창에 `pcoff:mode-changed` 이벤트 전송
- 트레이 메뉴에 현재 모드 표시

**신규 IPC 채널**
- `pcoff:getTrayOperationInfo` - 작동정보 조회
- `pcoff:refreshMyAttendance` - 근태정보 새로고침
- `pcoff:getOperationMode`, `pcoff:setOperationMode` - 모드 조회/설정
- `pcoff:mode-changed` - 모드 변경 이벤트 (Main → Renderer)
- `pcoff:openLockWindow`, `pcoff:closeCurrentWindow` - 창 제어
- `pcoff:logEvent` - Renderer에서 로그 이벤트 기록

**로그 코드**
- `TRAY_INFO_OPENED` - 트레이 정보 화면 열림
- `TRAY_ATTENDANCE_REFRESHED` - 근태정보 갱신
- `TRAY_MODE_CHANGED` - 모드 변경

**파일 변경**
- `app/renderer/main.html` - 신규 (에이전트 정보 화면)
- `app/renderer/main-info.js` - 신규 (에이전트 정보 스크립트)
- `app/renderer/lock.html` - 신규 (잠금화면)
- `app/renderer/lock.js` - 신규 (잠금화면 스크립트)
- `app/main/index.ts` - 트레이, 윈도우 분리 로직, IPC 핸들러 추가
- `app/preload/index.ts` - 트레이 정보 API 노출
- `app/renderer/renderer.js` - 로그인 후 잠금화면 전환 로직

---

## 2026-02-17

### 12개 설계 리포트 기반 문서 보완

**작업 내용**

12개 설계 리포트를 점검하여 `docs/다음_개발_진행_사항.md` 및 관련 문서에 누락된 세부 사항을 보완했습니다.

**점검한 리포트**
1. 일반모드/임시연장/긴급사용 중 이석정보 서버 전송 설계 보고서
2. 절전모드-이석감지 연계 설계 반영 보고서
3. 시업/종업 화면 표시 로직 설계서
4. 고객사 설정 반영 점검 및 보완 설계안
5. 긴급해제(비밀번호 기반) 설계 추가 리포트
6. PCOFF 트레이 에이전트 작동정보 조회 기능 반영 계획서
7. Windows Defender/SmartScreen 경고 최소화 방안 리포트
8. 이석/절전 감지 구현 방안 리포트
9. PCOFF 인스톨/언인스톨 정책 및 프로그램 작성방안 리포트
10. PCOFF 프로세스 Kill 통제 + 관리자 OTP 승인 방안 보고서
11. PCOFF 오프라인 복구 잠금 동작 설계안
12. 보조모니터(다중 디스플레이) 감지/처리 현황 보고서

**추가된 주요 내용**

| 영역 | 추가된 세부 사항 |
|------|------------------|
| 이석정보 서버 전송 | `workSessionId`, `reasonRequired`, `clientVersion` 필드, Phase 2/3 계획, reason 보안/마스킹 |
| 고객사 설정 | 비밀번호 정책 필드(minLength, maxFailures, lockoutSeconds 등), Draft/Publish/Rollback 워크플로우, 하이브리드 정책 배포 |
| 긴급해제 | 긴급사용 vs 긴급해제 비교표, API 응답 상세, EXPIRY_WARNING 로그 |
| 프로세스 Kill 통제 | Linux 지원(systemd), Process Fingerprint 상세, OTP/Token TTL, mTLS |
| 인스톨/언인스톨 | 최소 권한 설치기, INSTALL_ROLLBACK, 격리 모드, SELF_HEAL 로그 |
| 트레이 작동정보 | TrayOperationInfo 상세 모델, 로그 코드 |
| 시업/종업 화면 | 상태머신 연계, SCREEN_TRANSITION 로그 |
| 오프라인 복구 | UI 상세 문구, OFFLINE_GRACE_STARTED 로그 |
| SmartScreen | 타임스탬프 서버, 오탐 대응 URL, 릴리즈 체크리스트 상세 |

**업데이트된 문서**
- `docs/다음_개발_진행_사항.md`: 9개 섹션 세부 내용 보완
- `PRD_5240_PcOff_Electron.md`: FR-12, FR-14, FR-18, FR-19 세부 보완, 로그 코드 확장
- `TRD_5240_PcOff_Electron.md`: §12, §14 확장, §15~§18 신규 섹션 추가
- `docs/operations/logcode.md`: 15개 로그 코드 추가 (화면 전환, 업데이트 무결성 등)

---

## 2026-02-15

### Electron 시작 문제 해결

**문제 현상**
- `npm start` 또는 `electron .` 실행 시 앱이 시작되지 않음
- 에러 메시지: `TypeError: Cannot read properties of undefined (reading 'whenReady')`
- `require("electron")`이 Electron API 객체가 아닌 바이너리 경로 문자열을 반환

**원인 분석**
- 쉘 환경에 `ELECTRON_RUN_AS_NODE=1` 환경 변수가 설정되어 있었음
- 이 변수가 설정되면 Electron이 일반 Node.js로 실행되어 Electron 내부 API를 제공하지 않음
- `require("electron")`이 `node_modules/electron/index.js`를 로드하여 실행 파일 경로 문자열만 반환

**해결 방법**
```bash
unset ELECTRON_RUN_AS_NODE
npm start
```

**검증**
- Electron 앱 정상 실행 확인
- Main/Renderer/Helper 프로세스 모두 정상 동작

**참고 이슈**
- [electron/electron#49034](https://github.com/electron/electron/issues/49034)
- [electron/electron#49018](https://github.com/electron/electron/issues/49018)

---

### 자동 업데이트 실구현 (FR-03, Flow-03/04)

**구현 내용**

| 항목 | 상세 |
|------|------|
| 패키지 | `electron-updater` v6.7.3 |
| 위치 | `app/core/update-manager.ts` |
| 모드 | 무확인 자동 다운로드 및 설치 |

**주요 기능**
- `autoUpdater` 이벤트 리스너 설정 (checking, available, downloading, downloaded, error)
- 다운로드 완료 후 적용은 「지금 재시작」 버튼 클릭 시에만 수행 (28차에서 `autoInstallOnAppQuit: false`로 변경)
- Renderer에 실시간 진행률 전송 (`pcoff:update-progress` IPC)
- 재시도 큐: 네트워크 오류/무결성 실패 시 `update/retry-queue.json`에 저장, 1분 후 재시도, 최대 3회

**IPC 채널**
- `pcoff:requestUpdateCheck` - 업데이트 확인 요청
- `pcoff:getUpdateStatus` - 현재 업데이트 상태 조회
- `pcoff:getAppVersion` - 앱 버전 조회
- `pcoff:update-progress` - 진행률 이벤트 (Main → Renderer)

**로그 코드**
- `UPDATE_FOUND` - 업데이트 발견
- `UPDATE_DOWNLOADED` - 다운로드 완료
- `UPDATE_APPLIED` - 적용 완료
- `UPDATE_FAILED` - 실패

**Electron 환경 감지**
- `isElectronRuntime()` 함수로 Electron 런타임 여부 확인
- 비-Electron 환경(시뮬레이터)에서는 모의 동작 수행

---

### 비밀번호 변경 확인 UI 구현 (FR-04, Flow-05)

**요구사항 (PRD)**
- 비밀번호 변경 이벤트 감지 시 확인 UI만 표시
- 비밀번호 검증/재로그인 요구 없음 (Confirm-Only 정책)

**구현 내용**

| 항목 | 상세 |
|------|------|
| 감지 방식 | `/getPcOffWorkTime.do` 응답의 `pwdChgYn=Y` 플래그 |
| 정책 클래스 | `app/core/auth-policy.ts` - `AuthPolicy` |
| UI | 모달 다이얼로그 (확인 버튼만, 비밀번호 입력 없음) |

**AuthPolicy 클래스**
```typescript
interface PasswordChangeEvent {
  detected: boolean;
  message?: string;
  confirmedAt?: string;
}

class AuthPolicy {
  onPasswordChangeDetected(source: string, message?: string): Promise<void>
  confirmPasswordChange(userId: string): Promise<void>
  getPasswordChangeState(): PasswordChangeEvent
  isPasswordChangeRequired(): boolean
}
```

**IPC 채널**
- `pcoff:password-change-detected` - 비밀번호 변경 감지 이벤트 (Main → Renderer)
- `pcoff:getPasswordChangeState` - 현재 상태 조회
- `pcoff:confirmPasswordChange` - 확인 처리 (검증 없음)

**Renderer UI**
- `password-change-modal` 모달 오버레이
- 메시지 표시 + 확인 버튼
- Enter/Escape 키로도 확인 가능
- 외부 클릭 시에도 확인 처리

**로그 코드**
- `PASSWORD_CHANGE_DETECTED` - 변경 감지
- `PASSWORD_CONFIRM_DONE` - 확인 완료 (validation: "skipped")

---

### WorkTimeResponse 타입 확장

`app/core/api-client.ts`에 비밀번호 변경 관련 필드 추가:

```typescript
interface WorkTimeResponse {
  // 기존 필드...
  pwdChgYn?: "Y" | "N";      // 비밀번호 변경 필요 여부
  pwdChgMsg?: string;        // 비밀번호 변경 메시지
}
```

---

### 시뮬레이터 검증

```bash
npx tsx simulator/cli.ts run --scenario password_change_confirm
```

**결과**
```json
{
  "scenario": "password_change_confirm",
  "flowId": "Flow-05",
  "requirementIds": ["FR-04"],
  "expectedLogCodes": ["PASSWORD_CHANGE_DETECTED", "PASSWORD_CONFIRM_DONE"],
  "success": true,
  "details": "password confirm-only policy simulated"
}
```

---

## 파일 변경 요약

| 파일 | 변경 내용 |
|------|----------|
| `app/core/update-manager.ts` | electron-updater 연동, 재시도 큐, Renderer 이벤트 전송 |
| `app/core/auth-policy.ts` | PasswordChangeEvent 인터페이스, 감지/확인 메서드 |
| `app/core/api-client.ts` | WorkTimeResponse에 pwdChgYn, pwdChgMsg 추가 |
| `app/main/index.ts` | AuthPolicy 통합, 비밀번호 변경 감지 로직, IPC 핸들러 추가 |
| `app/preload/index.ts` | 비밀번호 변경 관련 IPC 메서드 노출 |
| `app/renderer/index.html` | 비밀번호 변경 확인 모달 추가 |
| `app/renderer/renderer.js` | 모달 로직, 이벤트 리스너 추가 |
| `app/renderer/styles.css` | .modal-hint 스타일 추가 |
| `docs/다음_개발_진행_사항.md` | 완료 항목 업데이트, 다음 진행 사항 번호 재정렬 |

---

### ESM 환경 `__dirname` 미정의 문제 해결

**문제 현상**
```
ReferenceError: __dirname is not defined
    at createMainWindow (file:///.../dist/app/main/index.js:51:14)
```
- ESM 모듈(`"type": "module"`)에서는 CommonJS의 `__dirname`, `__filename`이 존재하지 않음

**해결 방법**

`app/main/index.ts` 상단에 ESM 호환 코드 추가:
```typescript
import { dirname } from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
```

---

### `electron-updater` 초기화 에러 해결

**문제 현상**
```
TypeError: Cannot set properties of undefined (setting 'autoDownload')
    at UpdateManager.initAutoUpdater
```
- dynamic import 후 `{ autoUpdater }` destructuring이 제대로 동작하지 않음

**해결 방법**

`app/core/update-manager.ts` 수정:
```typescript
// Before (문제)
const { autoUpdater } = await import("electron-updater");

// After (해결)
const updaterModule = await import("electron-updater");
const autoUpdater = updaterModule.autoUpdater;
if (!autoUpdater) {
  console.warn("[UpdateManager] autoUpdater not found");
  return;
}
```

**참고**: 개발 환경(비패키징 상태)에서는 autoUpdater가 완전히 초기화되지 않을 수 있음. 이는 정상 동작이며, 패키징된 앱에서는 정상 작동함.

---

### Agent Guard 실구현 (FR-07, Flow-06)

**목표**: 삭제/우회 탐지, 무결성 체크, 자동 복구 트리거

**구현 내용**

| 항목 | 상세 |
|------|------|
| 위치 | `app/core/agent-guard.ts` |
| 무결성 체크 | SHA-256 해시 기반 파일 검증 |
| 파일 감시 | `fs.watch` 기반 실시간 모니터링 |
| 복구 전략 | 플랫폼별 stub (Windows: 서비스·ACL, macOS: LaunchDaemon) |

**주요 기능**
- `capture()` - 기준선 무결성 캡처 (파일 해시, 크기, 수정시간)
- `verify()` - 무결성 검증 (해시 비교)
- `start()` - Guard 시작 (파일 감시 + 주기적 체크)
- `stop()` - Guard 중지

**탐지 이벤트 타입**
- `file_deleted` - 파일 삭제됨
- `file_modified` - 파일 변경됨
- `hash_mismatch` - 해시 불일치
- `permission_changed` - 권한 변경됨
- `process_kill_attempt` - 프로세스 Kill 시도

**IPC 채널**
- `pcoff:getGuardStatus` - Guard 상태 조회
- `pcoff:getGuardTamperEvents` - 탐지 이벤트 히스토리
- `pcoff:verifyIntegrity` - 수동 무결성 검증
- `pcoff:tamper-detected` - 탐지 이벤트 (Main → Renderer)

**로그 코드**
- `AGENT_TAMPER_DETECTED` - 탬퍼 탐지
- `AGENT_TAMPER_ATTEMPT` - 탬퍼 시도
- `AGENT_RECOVERED` - 복구 완료
- `AGENT_RECOVERY_FAILED` - 복구 실패
- `AGENT_STOP_ATTEMPT` - 프로세스 종료 시도

**시뮬레이터 검증**
```bash
npx tsx simulator/cli.ts run --scenario tamper_attempt
```

**결과**
```json
{
  "scenario": "tamper_attempt",
  "flowId": "Flow-06",
  "requirementIds": ["FR-07"],
  "expectedLogCodes": ["AGENT_TAMPER_DETECTED", "AGENT_RECOVERED"],
  "success": true,
  "details": "tamper detection simulated, guard active: false, integrity valid: true"
}
```

---

### Ops Observer 실구현 (FR-08, Flow-07)

**목표**: 비정상 종료·통신 두절·중지 상태를 중앙 서버에 보고

**구현 내용**

| 항목 | 상세 |
|------|------|
| 위치 | `app/core/ops-observer.ts`, `app/core/telemetry-log.ts`, `app/core/api-client.ts` |
| heartbeat | 주기적 HEARTBEAT 로그 + transport로 큐 적재 |
| 배치 전송 | 1분 주기 flush, 실패 시 지수 백오프 (최대 5분), BATCH_SIZE 50 |
| 서버 API | `POST /reportAgentEvents.do` (events, deviceId, sessionId) |
| 크래시 감지 | process.on("uncaughtException", "unhandledRejection") → reportCrash() → flush → exit(1) |
| 오프라인 보고 | reportOffline(reason) → OFFLINE_DETECTED 로그 + 즉시 전송 시도 |

**TelemetryLogger**
- `addTransport(fn)` / `removeTransport()` — 로그 기록 시 서버 전송 큐 적재

**시뮬레이터**
```bash
npx tsx simulator/cli.ts run --scenario offline_detected
```

**결과**: success true, OFFLINE_DETECTED·CRASH_DETECTED 로그 기록

---

---

## 2026-02-16

### 추가 요청사항 문서 통합

**작업 내용**
- 11개 리포트 문서의 요구사항을 `docs/다음_개발_진행_사항.md`에 통합 정리
- PRD/TRD/README 문서 최신화

**통합된 리포트 목록**
1. 인스톨/언인스톨 정책 및 프로그램 작성방안 리포트
2. 프로세스 Kill 통제 + 관리자 OTP 승인 방안 보고서
3. 오프라인 복구 잠금 동작 설계안
4. 다중 디스플레이(보조모니터) 감지 처리 현황 보고서
5. Windows Defender/SmartScreen 경고 최소화 방안 리포트
6. 이석/절전 감지 구현 방안 리포트
7. 일반모드/임시연장/긴급사용 중 이석정보 서버 전송 설계 보고서
8. 절전모드-이석감지 연계 설계 반영 보고서
9. 시업/종업 화면 표시 로직 설계서
10. 고객사 설정 반영 점검 및 보완 설계안
11. 긴급해제(비밀번호 기반) 설계 추가 리포트
12. PCOFF 트레이 에이전트 작동정보 조회 기능 반영 계획서

**신규 FR 추가 (PRD)**
- FR-11: 이석 감지 (Idle/절전)
- FR-12: 이석정보 서버 전송
- FR-13: 시업/종업 화면 로직
- FR-14: 고객사 설정 반영
- FR-15: 긴급해제 (비밀번호)
- FR-16: 트레이 작동정보 조회
- FR-17: 오프라인 복구·잠금
- FR-18: 프로세스 Kill 통제
- FR-19: 인스톨/언인스톨 정책

**신규 Flow 추가 (PRD)**
- Flow-09: 이석 감지
- Flow-10: 이석 이벤트 전송
- Flow-11: 시업/종업 화면 로직
- Flow-12: 긴급해제
- Flow-13: 오프라인 복구·잠금
- Flow-14: 트레이 작동정보

**TRD 업데이트**
- 신규 모듈 7개 추가 (leave-seat-detector, offline-manager, emergency-unlock, tray-manager, tenant-policy, kill-controller, installer-registry)
- IPC 채널 확장 (이석, 오프라인, 긴급해제, 트레이, Kill 통제 관련)
- 상태 머신 확장 (OFFLINE_GRACE, OFFLINE_LOCKED, LEAVE_SEAT_DETECTED, EMERGENCY_UNLOCK_ACTIVE)
- 로컬 저장소 확장 (offline-state.json, leave-seat-queue.jsonl, tenant-policy-cache.json, emergency-unlock-state.json)
- 아키텍처 섹션 추가 (§9~§14)

**README 업데이트**
- 구현 해야 할 것 목록 13개로 확장
- 테스트 시나리오 Flow-09~14 추가

**휴게시간 중 이석해제 사유입력 예외처리**
- `getPcOffWorkTime` 응답의 휴게시간 정보(breakStartTime, breakEndTime) 활용
- 휴게시간 중에는 사유입력 면제 정책 적용

---

## 다음 개발 예정

1. 설치자 레지스트리 (FR-09, Flow-08)
2. 이석 감지·해제 플로우 (FR-11, Flow-09)
3. 이석정보 서버 전송 (FR-12, Flow-10)
4. 오프라인 복구·잠금 (FR-17, Flow-13)
5. 긴급해제 (FR-15, Flow-12)
6. ~~시업/종업 화면 로직 (FR-13, Flow-11)~~ ✅ 완료
7. 고객사 설정 반영 (FR-14)
8. ~~트레이 작동정보 (FR-16, Flow-14)~~ ✅ 완료
9. 프로세스 Kill 통제 (FR-18)
10. 인스톨/언인스톨 정책 (FR-19)
11. ~~로그 코드 전수 반영 (PRD §7)~~ ✅ 완료
12. Windows Defender/SmartScreen 대응
13. 패키징 및 플랫폼 검증 (NFR-01)

---

## 참고

- **환경**: macOS 25.2.0 (darwin), Node.js v20.20.0, Electron v40.4.0
- **빌드**: `npm run build` (TypeScript → ESM)
- **실행**: `unset ELECTRON_RUN_AS_NODE && npm start`
