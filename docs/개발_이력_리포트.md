# 개발 이력 리포트

5240 PcOff Electron 프로젝트의 주요 개발 이력을 기록합니다.

- **마지막 문서 업데이트**: 2026-02-20 (5차)

---

## 2026-02-20 (5차) CI·릴리스·GitHub 자동 업데이트·패키징

**구현 내용**

| 항목 | 상세 |
|------|------|
| **release 워크플로우** | `.github/workflows/release.yml` — 태그 푸시(v*) 시 Windows x64·Mac 빌드 후 GitHub Release에 업로드. Windows: windows-latest, Mac: macos-latest. Mac 빌드 실패 시에도 Windows 릴리스 진행(continue-on-error). |
| **자동 업데이트** | package.json `publish.provider: "github"`, `repository` 추가. 설치된 앱이 GitHub Release에서 새 버전 확인·자동 적용. |
| **Mac 빌드** | entitlements.mac.plist 신규(Hardened Runtime). Mac 아티팩트 다운로드 optional(continue-on-error). |
| **사용자별 설치 파일** | README에 Windows → .exe, Mac → .dmg/.zip 안내. 사용자별 설치 파일(배포 시) 섹션 추가. |
| **푸시 용량 초과** | docs/깃_푸시_용량초과_해결.md 신규. release/ .gitignore 유지, 히스토리에서 release/ 제거 방법(filter-branch) 및 force push 안내. |

**파일 변경**
- `.github/workflows/release.yml`: Windows·Mac 빌드, release job, Mac continue-on-error
- `package.json`: publish provider github, repository
- `entitlements.mac.plist`: 신규
- `README.md`: Windows 설치 파일 빌드, CI·릴리스, 사용자별 설치 파일, 자동 업데이트 연동
- `docs/깃_푸시_용량초과_해결.md`: 신규

---

## 2026-02-19 (4차) 이석 API 정규화·설정값 로그

**구현 내용**

| 항목 | 상세 |
|------|------|
| **leaveSeatUseYn 정규화** | 서버가 `"YES"`/`"NO"`로 내려줘도 이석 감지가 동작하도록 `normalizeLeaveSeatUseYn()` 도입. `"Y"`/`"YES"` → `"Y"`, 그 외 → `"N"`. `isLockRequired`, `getWorkTime`, 기동 시 detector 정책 등 정책을 넘기는 모든 경로에서 사용. (1분 유휴 미동작 원인 수정) |
| **터미널 설정값 로그** | 앱 기동 시·로그인 시·근태 로드 시 로드된 설정·근태정보를 `[PCOFF] 설정값:` 접두사로 터미널에 출력. 런타임 설정, 로그인 사용자, getPcOffWorkTime/getWorkTime 응답 요약. |

**파일 변경**
- `app/main/index.ts`: `normalizeLeaveSeatUseYn()`, `logLoadedConfig()` 호출, detector 정책 전달 시 정규화 적용

---

## 2026-02-19 (3차) 로컬 이석/절전 감지 구현 (FR-11)

**구현 내용**

| 항목 | 상세 |
|------|------|
| **LeaveSeatDetector** | `app/core/leave-seat-detector.ts` — Idle: `powerMonitor.getSystemIdleTime()` 5초 폴링, 정책(leaveSeatUseYn, leaveSeatTime 분) 초과 시 이석 감지. 절전: suspend 시각 기록, resume 시 경과 >= leaveSeatTime 이면 이석 감지(leaveDetectedAt=절전 시작 시각). |
| **정책** | `getPcOffWorkTime` 응답의 `leaveSeatUseYn`, `leaveSeatTime`으로 갱신. `WorkTimeResponse.leaveSeatTime` 추가(api-client). |
| **로컬 상태 병합** | `localLeaveSeatDetectedAt` 설정 시 `getWorkTime` 응답에 `screenType=empty`, `leaveSeatOffInputMath` 병합 → 기존 이석 화면·사유 입력 흐름 재사용. |
| **잠금 표시** | 이석 감지 시 `showLockForLocalLeaveSeat()` → 잠금화면 표시. PC-ON 성공 시 로컬 상태 클리어, `LEAVE_SEAT_RELEASED` 로그. |
| **로그 코드** | `LEAVE_SEAT_IDLE_DETECTED`, `LEAVE_SEAT_SLEEP_DETECTED`, `LEAVE_SEAT_RELEASED`, `SLEEP_ENTERED`, `SLEEP_RESUMED` (constants.ts). |

**파일 변경**
- `app/core/leave-seat-detector.ts`: 신규
- `app/core/api-client.ts`: WorkTimeResponse에 leaveSeatTime 추가
- `app/core/constants.ts`: 로그 코드 6종 추가
- `app/main/index.ts`: detector 시작/정책/병합/해제, formatYmdHm, showLockForLocalLeaveSeat
- `app/renderer/lock.js`: leaveSeatTime in DEFAULT_WORK·coerceWorkTimeFromApi

---

## 2026-02-19 (2차) 이석 감지·해제 플로우 구현 (Flow-02, FR-11)

**구현 내용**

| 항목 | 상세 |
|------|------|
| **leave-seat.ts 신규** | `app/core/leave-seat.ts` — `calcLeaveSeatPolicy()` 함수. `screenType=empty` 여부, 사유 입력 필수(`leaveSeatReasonYn=YES && leaveSeatReasonManYn=YES`) 여부, 휴게시간 면제(`breakStartTime~breakEndTime`) 여부를 하나의 정책 객체로 반환. |
| **이석 사유 입력 모달** | `lock.html`에 `#leave-seat-modal` 추가. 이석 감지 시각(`leaveDetectedAt`) 안내 + 사유 텍스트 입력 + PC-ON 확인 버튼. |
| **PC-ON 버튼 분기** | `lock.js`: 버튼 클릭 시 `leaveSeatPolicy.requireReason`이면 모달 → 사유 입력 후 `requestPcOnOffLog("IN", …, reason, true)` 호출. 휴게시간이면 모달 없이 바로 PC-ON. 일반이면 기존 동작. |
| **이석 로그** | `lock.js`: 화면 로드 시 이석 상태이면 `LEAVE_SEAT_DETECTED` 로그. PC-ON 성공 시 main에서 `LEAVE_SEAT_UNLOCK`, 사유 있으면 `LEAVE_SEAT_REASON_SUBMITTED` 추가 기록. |
| **로그 코드 추가** | `constants.ts`: `LEAVE_SEAT_DETECTED`, `LEAVE_SEAT_UNLOCK`, `LEAVE_SEAT_REASON_SUBMITTED`, `LEAVE_SEAT_BREAK_EXEMPT` |
| **preload 업데이트** | `requestPcOnOffLog`에 `isLeaveSeat` 파라미터 추가. |
| **시뮬레이터** | `leave_seat_reason_required`(Flow-02), `leave_seat_break_exempt`(Flow-02b) 두 시나리오 추가. 전체 10개 PASS. |

**파일 변경**
- `app/core/leave-seat.ts`: 신규 (이석 정책 모듈)
- `app/core/constants.ts`: LEAVE_SEAT_* 로그 코드 4종 추가
- `app/renderer/lock.html`: `#leave-seat-modal` 추가
- `app/renderer/lock.js`: 이석 정책 계산, 모달, PC-ON 분기, 로그
- `app/main/index.ts`: `requestPcOnOffLog` IPC에 `isLeaveSeat` 분기, LEAVE_SEAT 로그
- `app/preload/index.ts`: `requestPcOnOffLog` 시그니처에 `isLeaveSeat` 파라미터
- `simulator/scenarios.ts`: `leave_seat_reason_required`, `leave_seat_break_exempt` 시나리오 추가
- `simulator/cli.ts`: `ALL_SCENARIOS`에 두 시나리오 추가

---

## 2026-02-19 잠금화면 닫기 방지 확인 + 설치자 레지스트리(FR-09) 구현

**구현 내용**

| 항목 | 상세 |
|------|------|
| **잠금화면 닫기 방지** | `currentScreen` 상태 변수(`"login" \| "lock" \| "tray-info"`)로 분기. `lock` 시 `event.preventDefault()`로 X 버튼 완전 차단. `tray-info` 시 `hide()`로 트레이 숨김. `login` 시 일반 닫기 허용. 사용자 직접 확인 완료. |
| **로그아웃 핫키(잠금 중)** | `doGlobalLogout()`에서 `mainWindow.close()` 대신 `createLoginWindow()` 직접 호출. close 이벤트 차단 우회. |
| **설치자 레지스트리** | `app/core/installer-registry.ts` 신규. `deviceId`(UUID), `installedAt`, `platform`, `osRelease`, `hostname`, `appVersion`, `installerStaffId` 수집·저장(`installer-registry.json`). 앱 시작 시 `syncStatus !== "synced"`이면 서버 동기화 재시도. |
| **서버 동기화 API** | `POST /registerInstallerInfo.do` 호출. 실패 시 `syncStatus="failed"` 기록 후 다음 실행 시 재시도. |
| **로그 코드 추가** | `INSTALLER_REGISTRY_SYNC`, `INSTALLER_REGISTRY_FAIL` 추가(`constants.ts`). |
| **시뮬레이터** | `installer_registry_sync` 시나리오 실제 모듈 연동. `--scenario` CLI 파싱 버그 수정(`indexOf` → `lastIndexOf`). |

**파일 변경**
- `app/main/index.ts`: `currentScreen` 상태, `attachMainWindowCloseHandler`, `doGlobalLogout` 수정, installer-registry 초기화/동기화 코드 추가
- `app/core/installer-registry.ts`: 신규 (InstallerRegistry 인터페이스, `loadOrCreateInstallerRegistry`, `syncInstallerRegistry`)
- `app/core/constants.ts`: `PATHS.installerRegistry`, `LOG_CODES.INSTALLER_REGISTRY_SYNC/FAIL` 추가
- `simulator/scenarios.ts`: `installer_registry_sync` 시나리오 실제 모듈 실행
- `simulator/cli.ts`: `lastIndexOf("--scenario")` 적용

---

## 2026-02-13 (추가) 단일 창 통합·버튼 전환·Enter 키·전역 핫키·트레이 아이콘

**구현 내용**

| 항목 | 상세 |
|------|------|
| **단일 창(mainWindow)** | 작동정보·로그인·잠금화면을 하나의 `mainWindow`에서 전환. 새 창 없이 동일 창에서 `main.html` / `index.html` / `lock.html` 로드. |
| **PC-ON** | `callCmmPcOnOffLogPrc` IN 성공 시 `createTrayInfoWindow()` 호출 → 같은 창에서 **작동정보 화면**으로 전환. |
| **긴급사용** | `callPcOffEmergencyUse` 성공 시 `createTrayInfoWindow()` 호출 → 같은 창에서 **작동정보 화면**으로 전환. |
| **로그인 → 잠금** | 로그인 성공 후 `checkLockAndShow` 시 기존 로그인 창에 `lock.html` 로드(`showLockInWindow`), `closeCurrentWindow` 호출하지 않음. |
| **로그인 Enter 키** | 전화번호 입력 후 Enter → 다음 버튼 동작. 서비스 영역·ID·비밀번호 입력 후 Enter → 로그인 버튼 동작. (`renderer.js`) |
| **전역 단축키** | Cmd/Ctrl+Shift+L(로그아웃), Cmd/Ctrl+Shift+I(작동정보), Cmd/Ctrl+Shift+K(잠금화면). `globalShortcut` 등록, `before-quit`에서 `unregisterAll`. |
| **트레이 아이콘** | `scripts/create-tray-icon.mjs`로 16×16 PNG 생성(postbuild). `assets/tray-icon.png` 없을 때 Base64 fallback. macOS에서 `setTemplateImage(true)` 적용. |

**파일 변경**
- `app/main/index.ts`: `trayWindow`/`lockWindow` → `mainWindow` 통합, PC-ON/긴급사용 시 `createTrayInfoWindow()`, 전역 핫키 I/K
- `app/renderer/renderer.js`: 로그인 단계별 Enter 키 리스너, 로그인 성공 시 `lockOpened`면 `closeCurrentWindow()` 미호출
- `package.json`: postbuild에 `create-tray-icon.mjs` 추가
- `scripts/create-tray-icon.mjs`: 신규 (Node 내장 zlib/fs로 PNG 생성)

---

## 2026-02-13

### 에이전트 UI·잠금화면 UI 분리 구현

**요구사항**
- 트레이에서 에이전트 정보를 조회할 수 있는 전용 화면 필요
- 잠금화면과 에이전트 정보 화면을 분리하여 각각의 역할에 맞게 UI 제공
- 액션 버튼(임시연장/긴급사용 등)은 잠금화면에만 배치

**구현 내용**

| 항목 | 상세 |
|------|------|
| 에이전트 정보 화면 | `app/renderer/main.html` + `main-info.js` |
| 잠금화면 | `app/renderer/lock.html` + `lock.js` |
| 로그인 화면 | `app/renderer/index.html` + `renderer.js` (기존 유지) |
| 시스템 트레이 | `createTray()`, `updateTrayMenu()` - 메뉴 및 클릭 이벤트 |
| 창 관리 | **현재**: `mainWindow` 단일 창에서 세 화면 전환 (위 2026-02-13 추가 참고). 당시에는 `trayWindow`/`lockWindow` 분리였음. |

**에이전트 정보 화면 (main.html)**
- 트레이 클릭 또는 메뉴에서 "PCOFF 작동정보" 선택 시 표시
- 액션 버튼 없음, 정보 조회 전용
- 표시 항목: 현재 반영 근태정보, 나의 근태정보, 버전정보, 현재 모드
- 새로고침 버튼으로 근태정보 갱신 가능

**잠금화면 (lock.html)**
- PC 사용 제한 시 표시
- 기존 main-view의 모든 기능 유지 (임시연장/긴급사용/PC-ON/PC-OFF)
- 비밀번호 변경 모달, 긴급사용 사유 모달 포함

**시스템 트레이**
- 메뉴 항목: PCOFF 작동정보, 잠금화면 열기, 로그 폴더 열기, 현재 모드 표시, 종료
- 트레이 클릭 시 작동정보 화면 열기
- 창이 모두 닫혀도 트레이에서 앱 유지 (트레이 앱 모드)

**운영 모드 관리**
- `NORMAL`, `TEMP_EXTEND`, `EMERGENCY_USE`, `EMERGENCY_RELEASE` 상태 추적
- 모드 변경 시 모든 창에 `pcoff:mode-changed` 이벤트 전송
- 트레이 메뉴에 현재 모드 표시

**신규 IPC 채널**
- `pcoff:getTrayOperationInfo` - 작동정보 조회
- `pcoff:refreshMyAttendance` - 근태정보 새로고침
- `pcoff:getOperationMode`, `pcoff:setOperationMode` - 모드 조회/설정
- `pcoff:mode-changed` - 모드 변경 이벤트 (Main → Renderer)
- `pcoff:openLockWindow`, `pcoff:closeCurrentWindow` - 창 제어
- `pcoff:logEvent` - Renderer에서 로그 이벤트 기록

**로그 코드**
- `TRAY_INFO_OPENED` - 트레이 정보 화면 열림
- `TRAY_ATTENDANCE_REFRESHED` - 근태정보 갱신
- `TRAY_MODE_CHANGED` - 모드 변경

**파일 변경**
- `app/renderer/main.html` - 신규 (에이전트 정보 화면)
- `app/renderer/main-info.js` - 신규 (에이전트 정보 스크립트)
- `app/renderer/lock.html` - 신규 (잠금화면)
- `app/renderer/lock.js` - 신규 (잠금화면 스크립트)
- `app/main/index.ts` - 트레이, 윈도우 분리 로직, IPC 핸들러 추가
- `app/preload/index.ts` - 트레이 정보 API 노출
- `app/renderer/renderer.js` - 로그인 후 잠금화면 전환 로직

---

## 2026-02-17

### 12개 설계 리포트 기반 문서 보완

**작업 내용**

12개 설계 리포트를 점검하여 `docs/다음_개발_진행_사항.md` 및 관련 문서에 누락된 세부 사항을 보완했습니다.

**점검한 리포트**
1. 일반모드/임시연장/긴급사용 중 이석정보 서버 전송 설계 보고서
2. 절전모드-이석감지 연계 설계 반영 보고서
3. 시업/종업 화면 표시 로직 설계서
4. 고객사 설정 반영 점검 및 보완 설계안
5. 긴급해제(비밀번호 기반) 설계 추가 리포트
6. PCOFF 트레이 에이전트 작동정보 조회 기능 반영 계획서
7. Windows Defender/SmartScreen 경고 최소화 방안 리포트
8. 이석/절전 감지 구현 방안 리포트
9. PCOFF 인스톨/언인스톨 정책 및 프로그램 작성방안 리포트
10. PCOFF 프로세스 Kill 통제 + 관리자 OTP 승인 방안 보고서
11. PCOFF 오프라인 복구 잠금 동작 설계안
12. 보조모니터(다중 디스플레이) 감지/처리 현황 보고서

**추가된 주요 내용**

| 영역 | 추가된 세부 사항 |
|------|------------------|
| 이석정보 서버 전송 | `workSessionId`, `reasonRequired`, `clientVersion` 필드, Phase 2/3 계획, reason 보안/마스킹 |
| 고객사 설정 | 비밀번호 정책 필드(minLength, maxFailures, lockoutSeconds 등), Draft/Publish/Rollback 워크플로우, 하이브리드 정책 배포 |
| 긴급해제 | 긴급사용 vs 긴급해제 비교표, API 응답 상세, EXPIRY_WARNING 로그 |
| 프로세스 Kill 통제 | Linux 지원(systemd), Process Fingerprint 상세, OTP/Token TTL, mTLS |
| 인스톨/언인스톨 | 최소 권한 설치기, INSTALL_ROLLBACK, 격리 모드, SELF_HEAL 로그 |
| 트레이 작동정보 | TrayOperationInfo 상세 모델, 로그 코드 |
| 시업/종업 화면 | 상태머신 연계, SCREEN_TRANSITION 로그 |
| 오프라인 복구 | UI 상세 문구, OFFLINE_GRACE_STARTED 로그 |
| SmartScreen | 타임스탬프 서버, 오탐 대응 URL, 릴리즈 체크리스트 상세 |

**업데이트된 문서**
- `docs/다음_개발_진행_사항.md`: 9개 섹션 세부 내용 보완
- `PRD_5240_PcOff_Electron.md`: FR-12, FR-14, FR-18, FR-19 세부 보완, 로그 코드 확장
- `TRD_5240_PcOff_Electron.md`: §12, §14 확장, §15~§18 신규 섹션 추가
- `docs/operations/logcode.md`: 15개 로그 코드 추가 (화면 전환, 업데이트 무결성 등)

---

## 2026-02-15

### Electron 시작 문제 해결

**문제 현상**
- `npm start` 또는 `electron .` 실행 시 앱이 시작되지 않음
- 에러 메시지: `TypeError: Cannot read properties of undefined (reading 'whenReady')`
- `require("electron")`이 Electron API 객체가 아닌 바이너리 경로 문자열을 반환

**원인 분석**
- 쉘 환경에 `ELECTRON_RUN_AS_NODE=1` 환경 변수가 설정되어 있었음
- 이 변수가 설정되면 Electron이 일반 Node.js로 실행되어 Electron 내부 API를 제공하지 않음
- `require("electron")`이 `node_modules/electron/index.js`를 로드하여 실행 파일 경로 문자열만 반환

**해결 방법**
```bash
unset ELECTRON_RUN_AS_NODE
npm start
```

**검증**
- Electron 앱 정상 실행 확인
- Main/Renderer/Helper 프로세스 모두 정상 동작

**참고 이슈**
- [electron/electron#49034](https://github.com/electron/electron/issues/49034)
- [electron/electron#49018](https://github.com/electron/electron/issues/49018)

---

### 자동 업데이트 실구현 (FR-03, Flow-03/04)

**구현 내용**

| 항목 | 상세 |
|------|------|
| 패키지 | `electron-updater` v6.7.3 |
| 위치 | `app/core/update-manager.ts` |
| 모드 | 무확인 자동 다운로드 및 설치 |

**주요 기능**
- `autoUpdater` 이벤트 리스너 설정 (checking, available, downloading, downloaded, error)
- 다운로드 완료 시 자동 설치 (`autoInstallOnAppQuit: true`)
- Renderer에 실시간 진행률 전송 (`pcoff:update-progress` IPC)
- 재시도 큐: 네트워크 오류/무결성 실패 시 `update/retry-queue.json`에 저장, 1분 후 재시도, 최대 3회

**IPC 채널**
- `pcoff:requestUpdateCheck` - 업데이트 확인 요청
- `pcoff:getUpdateStatus` - 현재 업데이트 상태 조회
- `pcoff:getAppVersion` - 앱 버전 조회
- `pcoff:update-progress` - 진행률 이벤트 (Main → Renderer)

**로그 코드**
- `UPDATE_FOUND` - 업데이트 발견
- `UPDATE_DOWNLOADED` - 다운로드 완료
- `UPDATE_APPLIED` - 적용 완료
- `UPDATE_FAILED` - 실패

**Electron 환경 감지**
- `isElectronRuntime()` 함수로 Electron 런타임 여부 확인
- 비-Electron 환경(시뮬레이터)에서는 모의 동작 수행

---

### 비밀번호 변경 확인 UI 구현 (FR-04, Flow-05)

**요구사항 (PRD)**
- 비밀번호 변경 이벤트 감지 시 확인 UI만 표시
- 비밀번호 검증/재로그인 요구 없음 (Confirm-Only 정책)

**구현 내용**

| 항목 | 상세 |
|------|------|
| 감지 방식 | `/getPcOffWorkTime.do` 응답의 `pwdChgYn=Y` 플래그 |
| 정책 클래스 | `app/core/auth-policy.ts` - `AuthPolicy` |
| UI | 모달 다이얼로그 (확인 버튼만, 비밀번호 입력 없음) |

**AuthPolicy 클래스**
```typescript
interface PasswordChangeEvent {
  detected: boolean;
  message?: string;
  confirmedAt?: string;
}

class AuthPolicy {
  onPasswordChangeDetected(source: string, message?: string): Promise<void>
  confirmPasswordChange(userId: string): Promise<void>
  getPasswordChangeState(): PasswordChangeEvent
  isPasswordChangeRequired(): boolean
}
```

**IPC 채널**
- `pcoff:password-change-detected` - 비밀번호 변경 감지 이벤트 (Main → Renderer)
- `pcoff:getPasswordChangeState` - 현재 상태 조회
- `pcoff:confirmPasswordChange` - 확인 처리 (검증 없음)

**Renderer UI**
- `password-change-modal` 모달 오버레이
- 메시지 표시 + 확인 버튼
- Enter/Escape 키로도 확인 가능
- 외부 클릭 시에도 확인 처리

**로그 코드**
- `PASSWORD_CHANGE_DETECTED` - 변경 감지
- `PASSWORD_CONFIRM_DONE` - 확인 완료 (validation: "skipped")

---

### WorkTimeResponse 타입 확장

`app/core/api-client.ts`에 비밀번호 변경 관련 필드 추가:

```typescript
interface WorkTimeResponse {
  // 기존 필드...
  pwdChgYn?: "Y" | "N";      // 비밀번호 변경 필요 여부
  pwdChgMsg?: string;        // 비밀번호 변경 메시지
}
```

---

### 시뮬레이터 검증

```bash
npx tsx simulator/cli.ts run --scenario password_change_confirm
```

**결과**
```json
{
  "scenario": "password_change_confirm",
  "flowId": "Flow-05",
  "requirementIds": ["FR-04"],
  "expectedLogCodes": ["PASSWORD_CHANGE_DETECTED", "PASSWORD_CONFIRM_DONE"],
  "success": true,
  "details": "password confirm-only policy simulated"
}
```

---

## 파일 변경 요약

| 파일 | 변경 내용 |
|------|----------|
| `app/core/update-manager.ts` | electron-updater 연동, 재시도 큐, Renderer 이벤트 전송 |
| `app/core/auth-policy.ts` | PasswordChangeEvent 인터페이스, 감지/확인 메서드 |
| `app/core/api-client.ts` | WorkTimeResponse에 pwdChgYn, pwdChgMsg 추가 |
| `app/main/index.ts` | AuthPolicy 통합, 비밀번호 변경 감지 로직, IPC 핸들러 추가 |
| `app/preload/index.ts` | 비밀번호 변경 관련 IPC 메서드 노출 |
| `app/renderer/index.html` | 비밀번호 변경 확인 모달 추가 |
| `app/renderer/renderer.js` | 모달 로직, 이벤트 리스너 추가 |
| `app/renderer/styles.css` | .modal-hint 스타일 추가 |
| `docs/다음_개발_진행_사항.md` | 완료 항목 업데이트, 다음 진행 사항 번호 재정렬 |

---

### ESM 환경 `__dirname` 미정의 문제 해결

**문제 현상**
```
ReferenceError: __dirname is not defined
    at createMainWindow (file:///.../dist/app/main/index.js:51:14)
```
- ESM 모듈(`"type": "module"`)에서는 CommonJS의 `__dirname`, `__filename`이 존재하지 않음

**해결 방법**

`app/main/index.ts` 상단에 ESM 호환 코드 추가:
```typescript
import { dirname } from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
```

---

### `electron-updater` 초기화 에러 해결

**문제 현상**
```
TypeError: Cannot set properties of undefined (setting 'autoDownload')
    at UpdateManager.initAutoUpdater
```
- dynamic import 후 `{ autoUpdater }` destructuring이 제대로 동작하지 않음

**해결 방법**

`app/core/update-manager.ts` 수정:
```typescript
// Before (문제)
const { autoUpdater } = await import("electron-updater");

// After (해결)
const updaterModule = await import("electron-updater");
const autoUpdater = updaterModule.autoUpdater;
if (!autoUpdater) {
  console.warn("[UpdateManager] autoUpdater not found");
  return;
}
```

**참고**: 개발 환경(비패키징 상태)에서는 autoUpdater가 완전히 초기화되지 않을 수 있음. 이는 정상 동작이며, 패키징된 앱에서는 정상 작동함.

---

### Agent Guard 실구현 (FR-07, Flow-06)

**목표**: 삭제/우회 탐지, 무결성 체크, 자동 복구 트리거

**구현 내용**

| 항목 | 상세 |
|------|------|
| 위치 | `app/core/agent-guard.ts` |
| 무결성 체크 | SHA-256 해시 기반 파일 검증 |
| 파일 감시 | `fs.watch` 기반 실시간 모니터링 |
| 복구 전략 | 플랫폼별 stub (Windows: 서비스·ACL, macOS: LaunchDaemon) |

**주요 기능**
- `capture()` - 기준선 무결성 캡처 (파일 해시, 크기, 수정시간)
- `verify()` - 무결성 검증 (해시 비교)
- `start()` - Guard 시작 (파일 감시 + 주기적 체크)
- `stop()` - Guard 중지

**탐지 이벤트 타입**
- `file_deleted` - 파일 삭제됨
- `file_modified` - 파일 변경됨
- `hash_mismatch` - 해시 불일치
- `permission_changed` - 권한 변경됨
- `process_kill_attempt` - 프로세스 Kill 시도

**IPC 채널**
- `pcoff:getGuardStatus` - Guard 상태 조회
- `pcoff:getGuardTamperEvents` - 탐지 이벤트 히스토리
- `pcoff:verifyIntegrity` - 수동 무결성 검증
- `pcoff:tamper-detected` - 탐지 이벤트 (Main → Renderer)

**로그 코드**
- `AGENT_TAMPER_DETECTED` - 탬퍼 탐지
- `AGENT_TAMPER_ATTEMPT` - 탬퍼 시도
- `AGENT_RECOVERED` - 복구 완료
- `AGENT_RECOVERY_FAILED` - 복구 실패
- `AGENT_STOP_ATTEMPT` - 프로세스 종료 시도

**시뮬레이터 검증**
```bash
npx tsx simulator/cli.ts run --scenario tamper_attempt
```

**결과**
```json
{
  "scenario": "tamper_attempt",
  "flowId": "Flow-06",
  "requirementIds": ["FR-07"],
  "expectedLogCodes": ["AGENT_TAMPER_DETECTED", "AGENT_RECOVERED"],
  "success": true,
  "details": "tamper detection simulated, guard active: false, integrity valid: true"
}
```

---

### Ops Observer 실구현 (FR-08, Flow-07)

**목표**: 비정상 종료·통신 두절·중지 상태를 중앙 서버에 보고

**구현 내용**

| 항목 | 상세 |
|------|------|
| 위치 | `app/core/ops-observer.ts`, `app/core/telemetry-log.ts`, `app/core/api-client.ts` |
| heartbeat | 주기적 HEARTBEAT 로그 + transport로 큐 적재 |
| 배치 전송 | 1분 주기 flush, 실패 시 지수 백오프 (최대 5분), BATCH_SIZE 50 |
| 서버 API | `POST /reportAgentEvents.do` (events, deviceId, sessionId) |
| 크래시 감지 | process.on("uncaughtException", "unhandledRejection") → reportCrash() → flush → exit(1) |
| 오프라인 보고 | reportOffline(reason) → OFFLINE_DETECTED 로그 + 즉시 전송 시도 |

**TelemetryLogger**
- `addTransport(fn)` / `removeTransport()` — 로그 기록 시 서버 전송 큐 적재

**시뮬레이터**
```bash
npx tsx simulator/cli.ts run --scenario offline_detected
```

**결과**: success true, OFFLINE_DETECTED·CRASH_DETECTED 로그 기록

---

---

## 2026-02-16

### 추가 요청사항 문서 통합

**작업 내용**
- 11개 리포트 문서의 요구사항을 `docs/다음_개발_진행_사항.md`에 통합 정리
- PRD/TRD/README 문서 최신화

**통합된 리포트 목록**
1. 인스톨/언인스톨 정책 및 프로그램 작성방안 리포트
2. 프로세스 Kill 통제 + 관리자 OTP 승인 방안 보고서
3. 오프라인 복구 잠금 동작 설계안
4. 다중 디스플레이(보조모니터) 감지 처리 현황 보고서
5. Windows Defender/SmartScreen 경고 최소화 방안 리포트
6. 이석/절전 감지 구현 방안 리포트
7. 일반모드/임시연장/긴급사용 중 이석정보 서버 전송 설계 보고서
8. 절전모드-이석감지 연계 설계 반영 보고서
9. 시업/종업 화면 표시 로직 설계서
10. 고객사 설정 반영 점검 및 보완 설계안
11. 긴급해제(비밀번호 기반) 설계 추가 리포트
12. PCOFF 트레이 에이전트 작동정보 조회 기능 반영 계획서

**신규 FR 추가 (PRD)**
- FR-11: 이석 감지 (Idle/절전)
- FR-12: 이석정보 서버 전송
- FR-13: 시업/종업 화면 로직
- FR-14: 고객사 설정 반영
- FR-15: 긴급해제 (비밀번호)
- FR-16: 트레이 작동정보 조회
- FR-17: 오프라인 복구·잠금
- FR-18: 프로세스 Kill 통제
- FR-19: 인스톨/언인스톨 정책

**신규 Flow 추가 (PRD)**
- Flow-09: 이석 감지
- Flow-10: 이석 이벤트 전송
- Flow-11: 시업/종업 화면 로직
- Flow-12: 긴급해제
- Flow-13: 오프라인 복구·잠금
- Flow-14: 트레이 작동정보

**TRD 업데이트**
- 신규 모듈 7개 추가 (leave-seat-detector, offline-manager, emergency-unlock, tray-manager, tenant-policy, kill-controller, installer-registry)
- IPC 채널 확장 (이석, 오프라인, 긴급해제, 트레이, Kill 통제 관련)
- 상태 머신 확장 (OFFLINE_GRACE, OFFLINE_LOCKED, LEAVE_SEAT_DETECTED, EMERGENCY_UNLOCK_ACTIVE)
- 로컬 저장소 확장 (offline-state.json, leave-seat-queue.jsonl, tenant-policy-cache.json, emergency-unlock-state.json)
- 아키텍처 섹션 추가 (§9~§14)

**README 업데이트**
- 구현 해야 할 것 목록 13개로 확장
- 테스트 시나리오 Flow-09~14 추가

**휴게시간 중 이석해제 사유입력 예외처리**
- `getPcOffWorkTime` 응답의 휴게시간 정보(breakStartTime, breakEndTime) 활용
- 휴게시간 중에는 사유입력 면제 정책 적용

---

## 다음 개발 예정

1. 설치자 레지스트리 (FR-09, Flow-08)
2. 이석 감지·해제 플로우 (FR-11, Flow-09)
3. 이석정보 서버 전송 (FR-12, Flow-10)
4. 오프라인 복구·잠금 (FR-17, Flow-13)
5. 긴급해제 (FR-15, Flow-12)
6. 시업/종업 화면 로직 (FR-13, Flow-11)
7. 고객사 설정 반영 (FR-14)
8. ~~트레이 작동정보 (FR-16, Flow-14)~~ ✅ 완료
9. 프로세스 Kill 통제 (FR-18)
10. 인스톨/언인스톨 정책 (FR-19)
11. 로그 코드 전수 반영 (PRD §7)
12. Windows Defender/SmartScreen 대응
13. 패키징 및 플랫폼 검증 (NFR-01)

---

## 참고

- **환경**: macOS 25.2.0 (darwin), Node.js v20.20.0, Electron v40.4.0
- **빌드**: `npm run build` (TypeScript → ESM)
- **실행**: `unset ELECTRON_RUN_AS_NODE && npm start`
