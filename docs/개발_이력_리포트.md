# 개발 이력 리포트

5240 PcOff Electron 프로젝트의 주요 개발 이력을 기록합니다.

- **마지막 문서 업데이트**: 2026-02-15

---

## 2026-02-15

### Electron 시작 문제 해결

**문제 현상**
- `npm start` 또는 `electron .` 실행 시 앱이 시작되지 않음
- 에러 메시지: `TypeError: Cannot read properties of undefined (reading 'whenReady')`
- `require("electron")`이 Electron API 객체가 아닌 바이너리 경로 문자열을 반환

**원인 분석**
- 쉘 환경에 `ELECTRON_RUN_AS_NODE=1` 환경 변수가 설정되어 있었음
- 이 변수가 설정되면 Electron이 일반 Node.js로 실행되어 Electron 내부 API를 제공하지 않음
- `require("electron")`이 `node_modules/electron/index.js`를 로드하여 실행 파일 경로 문자열만 반환

**해결 방법**
```bash
unset ELECTRON_RUN_AS_NODE
npm start
```

**검증**
- Electron 앱 정상 실행 확인
- Main/Renderer/Helper 프로세스 모두 정상 동작

**참고 이슈**
- [electron/electron#49034](https://github.com/electron/electron/issues/49034)
- [electron/electron#49018](https://github.com/electron/electron/issues/49018)

---

### 자동 업데이트 실구현 (FR-03, Flow-03/04)

**구현 내용**

| 항목 | 상세 |
|------|------|
| 패키지 | `electron-updater` v6.7.3 |
| 위치 | `app/core/update-manager.ts` |
| 모드 | 무확인 자동 다운로드 및 설치 |

**주요 기능**
- `autoUpdater` 이벤트 리스너 설정 (checking, available, downloading, downloaded, error)
- 다운로드 완료 시 자동 설치 (`autoInstallOnAppQuit: true`)
- Renderer에 실시간 진행률 전송 (`pcoff:update-progress` IPC)
- 재시도 큐: 네트워크 오류/무결성 실패 시 `update/retry-queue.json`에 저장, 1분 후 재시도, 최대 3회

**IPC 채널**
- `pcoff:requestUpdateCheck` - 업데이트 확인 요청
- `pcoff:getUpdateStatus` - 현재 업데이트 상태 조회
- `pcoff:getAppVersion` - 앱 버전 조회
- `pcoff:update-progress` - 진행률 이벤트 (Main → Renderer)

**로그 코드**
- `UPDATE_FOUND` - 업데이트 발견
- `UPDATE_DOWNLOADED` - 다운로드 완료
- `UPDATE_APPLIED` - 적용 완료
- `UPDATE_FAILED` - 실패

**Electron 환경 감지**
- `isElectronRuntime()` 함수로 Electron 런타임 여부 확인
- 비-Electron 환경(시뮬레이터)에서는 모의 동작 수행

---

### 비밀번호 변경 확인 UI 구현 (FR-04, Flow-05)

**요구사항 (PRD)**
- 비밀번호 변경 이벤트 감지 시 확인 UI만 표시
- 비밀번호 검증/재로그인 요구 없음 (Confirm-Only 정책)

**구현 내용**

| 항목 | 상세 |
|------|------|
| 감지 방식 | `/getPcOffWorkTime.do` 응답의 `pwdChgYn=Y` 플래그 |
| 정책 클래스 | `app/core/auth-policy.ts` - `AuthPolicy` |
| UI | 모달 다이얼로그 (확인 버튼만, 비밀번호 입력 없음) |

**AuthPolicy 클래스**
```typescript
interface PasswordChangeEvent {
  detected: boolean;
  message?: string;
  confirmedAt?: string;
}

class AuthPolicy {
  onPasswordChangeDetected(source: string, message?: string): Promise<void>
  confirmPasswordChange(userId: string): Promise<void>
  getPasswordChangeState(): PasswordChangeEvent
  isPasswordChangeRequired(): boolean
}
```

**IPC 채널**
- `pcoff:password-change-detected` - 비밀번호 변경 감지 이벤트 (Main → Renderer)
- `pcoff:getPasswordChangeState` - 현재 상태 조회
- `pcoff:confirmPasswordChange` - 확인 처리 (검증 없음)

**Renderer UI**
- `password-change-modal` 모달 오버레이
- 메시지 표시 + 확인 버튼
- Enter/Escape 키로도 확인 가능
- 외부 클릭 시에도 확인 처리

**로그 코드**
- `PASSWORD_CHANGE_DETECTED` - 변경 감지
- `PASSWORD_CONFIRM_DONE` - 확인 완료 (validation: "skipped")

---

### WorkTimeResponse 타입 확장

`app/core/api-client.ts`에 비밀번호 변경 관련 필드 추가:

```typescript
interface WorkTimeResponse {
  // 기존 필드...
  pwdChgYn?: "Y" | "N";      // 비밀번호 변경 필요 여부
  pwdChgMsg?: string;        // 비밀번호 변경 메시지
}
```

---

### 시뮬레이터 검증

```bash
npx tsx simulator/cli.ts run --scenario password_change_confirm
```

**결과**
```json
{
  "scenario": "password_change_confirm",
  "flowId": "Flow-05",
  "requirementIds": ["FR-04"],
  "expectedLogCodes": ["PASSWORD_CHANGE_DETECTED", "PASSWORD_CONFIRM_DONE"],
  "success": true,
  "details": "password confirm-only policy simulated"
}
```

---

## 파일 변경 요약

| 파일 | 변경 내용 |
|------|----------|
| `app/core/update-manager.ts` | electron-updater 연동, 재시도 큐, Renderer 이벤트 전송 |
| `app/core/auth-policy.ts` | PasswordChangeEvent 인터페이스, 감지/확인 메서드 |
| `app/core/api-client.ts` | WorkTimeResponse에 pwdChgYn, pwdChgMsg 추가 |
| `app/main/index.ts` | AuthPolicy 통합, 비밀번호 변경 감지 로직, IPC 핸들러 추가 |
| `app/preload/index.ts` | 비밀번호 변경 관련 IPC 메서드 노출 |
| `app/renderer/index.html` | 비밀번호 변경 확인 모달 추가 |
| `app/renderer/renderer.js` | 모달 로직, 이벤트 리스너 추가 |
| `app/renderer/styles.css` | .modal-hint 스타일 추가 |
| `docs/다음_개발_진행_사항.md` | 완료 항목 업데이트, 다음 진행 사항 번호 재정렬 |

---

### ESM 환경 `__dirname` 미정의 문제 해결

**문제 현상**
```
ReferenceError: __dirname is not defined
    at createMainWindow (file:///.../dist/app/main/index.js:51:14)
```
- ESM 모듈(`"type": "module"`)에서는 CommonJS의 `__dirname`, `__filename`이 존재하지 않음

**해결 방법**

`app/main/index.ts` 상단에 ESM 호환 코드 추가:
```typescript
import { dirname } from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
```

---

### `electron-updater` 초기화 에러 해결

**문제 현상**
```
TypeError: Cannot set properties of undefined (setting 'autoDownload')
    at UpdateManager.initAutoUpdater
```
- dynamic import 후 `{ autoUpdater }` destructuring이 제대로 동작하지 않음

**해결 방법**

`app/core/update-manager.ts` 수정:
```typescript
// Before (문제)
const { autoUpdater } = await import("electron-updater");

// After (해결)
const updaterModule = await import("electron-updater");
const autoUpdater = updaterModule.autoUpdater;
if (!autoUpdater) {
  console.warn("[UpdateManager] autoUpdater not found");
  return;
}
```

**참고**: 개발 환경(비패키징 상태)에서는 autoUpdater가 완전히 초기화되지 않을 수 있음. 이는 정상 동작이며, 패키징된 앱에서는 정상 작동함.

---

### Agent Guard 실구현 (FR-07, Flow-06)

**목표**: 삭제/우회 탐지, 무결성 체크, 자동 복구 트리거

**구현 내용**

| 항목 | 상세 |
|------|------|
| 위치 | `app/core/agent-guard.ts` |
| 무결성 체크 | SHA-256 해시 기반 파일 검증 |
| 파일 감시 | `fs.watch` 기반 실시간 모니터링 |
| 복구 전략 | 플랫폼별 stub (Windows: 서비스·ACL, macOS: LaunchDaemon) |

**주요 기능**
- `capture()` - 기준선 무결성 캡처 (파일 해시, 크기, 수정시간)
- `verify()` - 무결성 검증 (해시 비교)
- `start()` - Guard 시작 (파일 감시 + 주기적 체크)
- `stop()` - Guard 중지

**탐지 이벤트 타입**
- `file_deleted` - 파일 삭제됨
- `file_modified` - 파일 변경됨
- `hash_mismatch` - 해시 불일치
- `permission_changed` - 권한 변경됨
- `process_kill_attempt` - 프로세스 Kill 시도

**IPC 채널**
- `pcoff:getGuardStatus` - Guard 상태 조회
- `pcoff:getGuardTamperEvents` - 탐지 이벤트 히스토리
- `pcoff:verifyIntegrity` - 수동 무결성 검증
- `pcoff:tamper-detected` - 탐지 이벤트 (Main → Renderer)

**로그 코드**
- `AGENT_TAMPER_DETECTED` - 탬퍼 탐지
- `AGENT_TAMPER_ATTEMPT` - 탬퍼 시도
- `AGENT_RECOVERED` - 복구 완료
- `AGENT_RECOVERY_FAILED` - 복구 실패
- `AGENT_STOP_ATTEMPT` - 프로세스 종료 시도

**시뮬레이터 검증**
```bash
npx tsx simulator/cli.ts run --scenario tamper_attempt
```

**결과**
```json
{
  "scenario": "tamper_attempt",
  "flowId": "Flow-06",
  "requirementIds": ["FR-07"],
  "expectedLogCodes": ["AGENT_TAMPER_DETECTED", "AGENT_RECOVERED"],
  "success": true,
  "details": "tamper detection simulated, guard active: false, integrity valid: true"
}
```

---

### Ops Observer 실구현 (FR-08, Flow-07)

**목표**: 비정상 종료·통신 두절·중지 상태를 중앙 서버에 보고

**구현 내용**

| 항목 | 상세 |
|------|------|
| 위치 | `app/core/ops-observer.ts`, `app/core/telemetry-log.ts`, `app/core/api-client.ts` |
| heartbeat | 주기적 HEARTBEAT 로그 + transport로 큐 적재 |
| 배치 전송 | 1분 주기 flush, 실패 시 지수 백오프 (최대 5분), BATCH_SIZE 50 |
| 서버 API | `POST /reportAgentEvents.do` (events, deviceId, sessionId) |
| 크래시 감지 | process.on("uncaughtException", "unhandledRejection") → reportCrash() → flush → exit(1) |
| 오프라인 보고 | reportOffline(reason) → OFFLINE_DETECTED 로그 + 즉시 전송 시도 |

**TelemetryLogger**
- `addTransport(fn)` / `removeTransport()` — 로그 기록 시 서버 전송 큐 적재

**시뮬레이터**
```bash
npx tsx simulator/cli.ts run --scenario offline_detected
```

**결과**: success true, OFFLINE_DETECTED·CRASH_DETECTED 로그 기록

---

## 다음 개발 예정

1. 설치자 레지스트리 (FR-09, Flow-08)
2. 이석 해제 플로우 (Flow-02 연계)
3. 로그 코드 전수 반영 (PRD §7)
4. 패키징 및 플랫폼 검증 (NFR-01)

---

## 참고

- **환경**: macOS 25.2.0 (darwin), Node.js v20.20.0, Electron v40.4.0
- **빌드**: `npm run build` (TypeScript → ESM)
- **실행**: `unset ELECTRON_RUN_AS_NODE && npm start`
