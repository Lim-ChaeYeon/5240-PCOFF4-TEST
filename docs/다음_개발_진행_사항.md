# 다음 개발 진행 사항

PRD/TRD 및 현재 코드 기준으로, 완료된 항목과 남은 작업을 정리한 문서입니다.  
(마지막 점검: 2026-02-15, 코드 기준 재검토 반영)

---

## 현재 완료된 항목

### 로그인·로그아웃

- **로그인 2단계**: 전화번호 입력 → 서비스영역 조회(getPcOffServareaInfo) → 서비스영역 선택·ID·비밀번호 → getPcOffLoginUserInfo 호출
- **서비스영역 응답 파싱**: 배열 래핑·`servareaList` 추출, `servareaId`/`servareaNm` 등 필드 매핑
- **state.json 저장**: userServareaId, userStaffId, loginUserId, loginUserNm, posNm, corpNm, lastLoginAt
- **에러 메시지**: 서버 응답 msg URL 디코딩 후 표시
- **로그아웃**: 개발자용 핫키(Cmd+Shift+L / Ctrl+Shift+L), clearLoginState, `docs/로그인_테스트.md` §7 기록

### 메인(잠금) 화면

- **근태정보 조회**: getPcOffWorkTime 호출, 근태정보 패널에 screenType·pcOnYn·시업/종업·임시연장·긴급사용 표시
- **버튼 4종**: 임시연장(callPcOffTempDelay), 긴급사용(callPcOffEmergencyUse), PC-ON(callCmmPcOnOffLogPrc IN), PC-OFF(callCmmPcOnOffLogPrc OUT)
- **정책 반영**: applyButtonDisp / applyLockInfo — screenType(before/off/empty), pcOnYn, pcoffEmergencyYesNo, 시업/종업 시간에 따른 문구·버튼 노출
- **사용자 표시**: 헤더에 로그인 사용자 이름·직급·회사(getCurrentUser → loginUserNm, posNm, corpNm)
- **긴급사용 사유**: window.prompt 미지원 대체 — 모달 입력(showEmergencyReasonModal), 확인/취소/Escape
- **PC-ON 동작**: API IN 전송 성공 시 메인 창 최소화(잠금 해제 후 PC 사용 가능)

### API 연동

- getPcOffWorkTime, getPcOffServareaInfo, getPcOffLoginUserInfo, callPcOffTempDelay, callPcOffEmergencyUse, callCmmPcOnOffLogPrc — 6종 모두 Main IPC·Preload·Renderer 연동

### 빌드·실행

- **Preload**: CommonJS 별도 빌드(tsconfig.preload.json)로 Electron에서 정상 로드
- **창 경로**: main 기준 __dirname으로 preload·renderer HTML 경로 해결

### 시뮬레이터·CI

- Flow-01~08 시나리오(login_success, lock_reason_input, update_success, update_failure_retry, password_change_confirm, tamper_attempt, offline_detected, installer_registry_sync)
- parity-report.json, parity-summary.md, CI 아티팩트

### 로깅

- JSONL, TelemetryLogger, PATHS.logsDir
- 사용 중 로그 코드: APP_START, LOGIN_SUCCESS, LOGIN_FAIL, LOGOUT, LOCK_TRIGGERED, UNLOCK_TRIGGERED, UPDATE_*, OFFLINE_DETECTED, PASSWORD_CHANGE_DETECTED, PASSWORD_CONFIRM_DONE, AGENT_TAMPER_DETECTED, AGENT_RECOVERED 등(constants.ts·logcode.md 참고)

### 자동 업데이트 (FR-03, Flow-03/04) ✅

- **electron-updater 연동**: `autoUpdater` 기반 실제 업데이트 검사·다운로드·적용
- **무확인 자동 적용**: `autoDownload: true`, `autoInstallOnAppQuit: true`, 다운로드 완료 시 `quitAndInstall()` 자동 호출
- **재시도 큐**: 네트워크 오류·무결성 실패 시 `update/retry-queue.json`에 저장, 1분 후 재시도, 최대 3회
- **Renderer 연동**: 진행률 실시간 표시(`onUpdateProgress`), 상태별 버튼 텍스트 갱신, 앱 버전 표시
- **electron-builder 설정**: `package.json`에 Windows NSIS / macOS DMG 빌드·publish 설정 추가
- **로그**: UPDATE_FOUND, UPDATE_DOWNLOADED, UPDATE_APPLIED, UPDATE_FAILED 기록

### 비밀번호 변경 확인 (FR-04, Flow-05) ✅

- **서버 응답 감지**: `/getPcOffWorkTime.do` 응답의 `pwdChgYn=Y` 플래그로 비밀번호 변경 감지
- **확인-only 정책**: 확인 UI만 표시, 비밀번호 검증/재로그인 요구 없음 (FR-04 준수)
- **AuthPolicy 연동**: `onPasswordChangeDetected`, `confirmPasswordChange` 메서드 구현
- **Renderer 모달**: 비밀번호 변경 알림 모달 + 확인 버튼
- **IPC 채널**: `pcoff:password-change-detected`, `pcoff:getPasswordChangeState`, `pcoff:confirmPasswordChange`
- **로그 코드**: `PASSWORD_CHANGE_DETECTED`, `PASSWORD_CONFIRM_DONE`

### Agent Guard (FR-07, Flow-06) ✅

- **무결성 체크**: SHA-256 해시 기반 파일 무결성 검증, 기준선 캡처/검증
- **파일 모니터링**: `fs.watch` 기반 실시간 파일 변경/삭제 감시
- **탐지 이벤트**: file_deleted, file_modified, hash_mismatch, permission_changed, process_kill_attempt
- **자동 복구 트리거**: 플랫폼별 복구 전략 (Windows: 서비스·ACL, macOS: LaunchDaemon)
- **IPC 연동**: `pcoff:getGuardStatus`, `pcoff:getGuardTamperEvents`, `pcoff:verifyIntegrity`
- **로그 코드**: `AGENT_TAMPER_DETECTED`, `AGENT_TAMPER_ATTEMPT`, `AGENT_RECOVERED`, `AGENT_RECOVERY_FAILED`, `AGENT_STOP_ATTEMPT`
- **시뮬레이터**: `tamper_attempt` 시나리오 검증 완료

### Ops Observer (FR-08, Flow-07) ✅

- **heartbeat**: 주기적 HEARTBEAT 로그 기록 + 서버 전송 큐 적재
- **로그 배치 전송**: 1분 주기 flush, 실패 시 지수 백오프 재시도 (최대 5분)
- **서버 API**: `POST /reportAgentEvents.do` (events, deviceId, sessionId)
- **크래시 감지**: uncaughtException/unhandledRejection 시 CRASH_DETECTED 기록 후 전송 시도, process.exit(1)
- **오프라인 보고**: reportOffline(reason) → OFFLINE_DETECTED 로그 + 즉시 전송 시도
- **TelemetryLogger transport**: 로그 기록 시 큐 적재 → 주기/즉시 서버 전송
- **시뮬레이터**: offline_detected 시나리오 검증 완료

---

## 다음 진행 사항 (우선순위 참고)

### 1. 설치자 레지스트리 (FR-09, Flow-08)

- **목표**: 설치 수행자 계정·사번·기기·설치 시각을 서버에 등록·조회
- **작업**: 설치 시 수집 로직, 서버 API 호출, (선택) 조회 UI/시뮬레이터
- **DoD**: 설치자 정보가 서버에서 조회 가능해야 함


### 2. 이석 해제 플로우 (Flow-02 연계)

- **목표**: 이석 화면에서 사유 입력 후 PC-ON(잠금 해제) 가능
- **작업**: 사유 입력 UI·필수 여부, 타이머 규칙, `callCmmPcOnOffLogPrc` 또는 관련 API와 연동
- **DoD**: 사유 입력·타이머 규칙이 기존(MFC)과 동일

### 3. 로그 코드 전수 반영 (PRD §7)

- **목표**: `docs/operations/logcode.md`와 매핑, 필수 이벤트 전부 로깅
- **작업**: LOGIN_SUCCESS/FAIL, LOCK_TRIGGERED/UNLOCK_TRIGGERED, UPDATE_*, PASSWORD_CHANGE_DETECTED/CONFIRM_DONE, AGENT_TAMPER_DETECTED/RECOVERED, CRASH_DETECTED, OFFLINE_DETECTED 등 누락 이벤트 추가
- **DoD**: 제품 요구사항의 필수 이벤트가 모두 기록·조회 가능

### 4. 패키징 및 플랫폼 검증 (NFR-01, DoD)

- **목표**: Windows installer, macOS pkg/dmg 빌드, 두 OS에서 설치·실행 검증
- **작업**: electron-builder 또는 동등 도구 설정, 코드 서명/notarization 정책 반영
- **DoD**: Windows·macOS 설치 및 실행 검증 완료

---

## 추가 요청사항 (리포트 반영)

아래는 인스톨/언인스톨, 프로세스 Kill 통제, 오프라인 복구, 다중 디스플레이 관련 리포트에서 정리한 추가 요구사항이다.

### 9. 인스톨/언인스톨 정책 실구현 (인스톨·언인스톨 정책 리포트)

- **인스톨 정책**
  - 설치 전: 환경 점검(OS/디스크/네트워크/권한), 중복 설치 탐지, 설치자 인증(사번·계정·기기)
  - 설치 중: 파일 배치, Windows(서비스/작업스케줄러/ACL)·macOS(LaunchAgent/LaunchDaemon), 해시 기준선(SHA-256) 생성, 설치자 레지스트리 API 호출
  - 설치 후: 초기 heartbeat, 실패 시 롤백/제한 모드, 감사 로그(`INSTALL_START`, `INSTALL_SUCCESS`, `INSTALL_FAIL`, `INSTALLER_REGISTRY_SYNC`)
- **언인스톨 정책**
  - 일반 사용자 임의 삭제 금지; 삭제는 관리자 승인 또는 정책 토큰(1회용)으로만 허용
  - 삭제 시도 탐지 시 즉시 보고(`TAMPER_ATTEMPT`, `AGENT_STOP_ATTEMPT`) → 자동 복구 → 실패 시 격리 모드 + 운영 알림
  - 정상 언인스톨: 관리자 인증 → 정책 검증 → 서버 승인 → 실행 후 `UNINSTALL_SUCCESS` 보고
- **모듈**: `installer-registry`(신규), `agent-guard`/`ops-observer` 확장, 이벤트 코드 전수 반영(`UNINSTALL_*`, `TAMPER_ATTEMPT`, `SELF_HEAL_*` 등)

### 10. 프로세스 Kill 통제 + 관리자 OTP 승인 (Kill 통제·OTP 보고서)

- **원칙**: 사용자 임의 종료 차단(표준 권한에서 kill/taskkill 불가), Kill은 관리자 OTP 검증 후에만 허용, 감사 로그 100% 기록, Windows/Linux/macOS 동일 모델
- **OS별 보호**
  - Windows: LocalSystem 서비스, DACL로 `PROCESS_TERMINATE` 미부여, Recovery + Watchdog
  - Linux: root/systemd, `ProtectSystem`/`NoNewPrivileges` 등, Restart=always + watchdog
  - macOS: LaunchDaemon(root), root:wheel 소유·일반 사용자 write 금지, KeepAlive, (선택) EndpointSecurity
- **Kill 시퀀스**: `KillRequest` 등록 → OTP 발송 → 관리자 OTP 입력 → `KillToken`(JWT/PASETO) 발급 → `kill-execute` + 토큰 검증 후 종료
- **API**: `POST /kill-requests`, `POST /kill-requests/{id}/verify-otp`, `POST /kill-execute`(Bearer KillToken), process fingerprint로 PID 재사용 공격 방지
- **Phase 1**: Service/Daemon 권한 분리 + 사용자 kill 차단, KillRequest/OTP/KillExecute 최소 구현, 감사 로그, macOS plist 확정

### 11. 오프라인 복구·잠금 동작 (오프라인 설계안)

- **목표**: 오프라인 시 전용 안내 화면, 재시도 버튼, 30분 유예 후 미복구 시 화면 잠금(PC 사용 불가), 전 과정 heartbeat/이벤트 보고
- **상태**: `OFFLINE_GRACE`(30분 복구 대기), `OFFLINE_LOCKED`(잠금)
- **감지**: heartbeat 3회 연속 실패 또는 핵심 API 네트워크 오류 2회 연속 → `OFFLINE_DETECTED` → `OFFLINE_GRACE`
- **UI**: 지정 문구 고정, 경과 시간(mm:ss/30:00), 버튼(다시 시도, 네트워크 설정 안내, 관리자 문의)
- **IPC**: `pcoff:getConnectivityState`, `pcoff:retryConnectivity`; `OFFLINE_LOCKED` 시 PC-ON/임시연장/긴급사용 차단
- **저장**: `offline-state.json`(offlineSince, deadline, locked 등), 앱 재시작 시에도 잠금 유지
- **이벤트**: `OFFLINE_DETECTED`, `OFFLINE_RETRY`, `OFFLINE_RECOVERED`, `OFFLINE_TIMEOUT_LOCK` 로그·heartbeat 보고

### 12. 다중 디스플레이(보조모니터) 감지·처리 (다중 디스플레이 보고서)

- **현황**: 메인 프로세스에 다중 모니터 동기화 반영 완료 — `screen.getAllDisplays()`, 디스플레이당 잠금 창 1개, `display-added`/`display-removed`/`display-metrics-changed` 핫플러그 대응
- **추가 권고**
  - 잠금 강화 시 `alwaysOnTop`, 포커스 정책, OS별 우회(Alt+Tab, Mission Control) 테스트
  - QA 시나리오에 "다중 모니터 연결/해제 반복" 케이스 포함

---

## 참고

- **단일 소스**: `PRD_5240_PcOff_Electron.md`, `TRD_5240_PcOff_Electron.md`, `PC_OFF_AGENT_API.md`, `VIBE_PROMPT_IMPLEMENTATION.md`
- **시뮬레이터**: `simulator/`, `artifacts/parity-report.json` — 새 플로우 추가 시 시나리오·parity 반영 권장
- **정의 완료(DoD)**: PRD §9 참고
