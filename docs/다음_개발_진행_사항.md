# 다음 개발 진행 사항

PRD/TRD 및 현재 코드 기준으로, 완료된 항목과 남은 작업을 정리한 문서입니다.  
(마지막 점검: 2026-02-13, 단일 창 통합·PC-ON/긴급사용→작동정보 전환·Enter 키·전역 핫키·트레이 아이콘 반영)

---

## 현재 완료된 항목

### 로그인·로그아웃

- **로그인 2단계**: 전화번호 입력 → 서비스영역 조회(getPcOffServareaInfo) → 서비스영역 선택·ID·비밀번호 → getPcOffLoginUserInfo 호출
- **서비스영역 응답 파싱**: 배열 래핑·`servareaList` 추출, `servareaId`/`servareaNm` 등 필드 매핑
- **state.json 저장**: userServareaId, userStaffId, loginUserId, loginUserNm, posNm, corpNm, lastLoginAt
- **에러 메시지**: 서버 응답 msg URL 디코딩 후 표시
- **로그아웃**: 전역 핫키(Cmd+Shift+L / Ctrl+Shift+L), clearLoginState, `docs/로그인_테스트.md` §7 기록
- **로그인 Enter 키**: 전화번호 입력 후 Enter → 다음, 서비스 영역·ID·비밀번호 입력 후 Enter → 로그인

### 메인(잠금) 화면

- **근태정보 조회**: getPcOffWorkTime 호출, 근태정보 패널에 screenType·pcOnYn·시업/종업·임시연장·긴급사용 표시
- **버튼 4종**: 임시연장(callPcOffTempDelay), 긴급사용(callPcOffEmergencyUse), PC-ON(callCmmPcOnOffLogPrc IN), PC-OFF(callCmmPcOnOffLogPrc OUT)
- **정책 반영**: applyButtonDisp / applyLockInfo — screenType(before/off/empty), pcOnYn, pcoffEmergencyYesNo, 시업/종업 시간에 따른 문구·버튼 노출
- **사용자 표시**: 헤더에 로그인 사용자 이름·직급·회사(getCurrentUser → loginUserNm, posNm, corpNm)
- **긴급사용 사유**: window.prompt 미지원 대체 — 모달 입력(showEmergencyReasonModal), 확인/취소/Escape
- **PC-ON 동작**: API IN 전송 성공 시 **같은 창에서 작동정보 화면으로 전환**(잠금 해제)
- **긴급사용 동작**: API 성공 시 **같은 창에서 작동정보 화면으로 전환**(잠금 해제)
- **창 관리**: `mainWindow` 단일 창 — 작동정보(main.html)·로그인(index.html)·잠금(lock.html) 동일 창에서 전환, 새 창 미사용

### API 연동

- getPcOffWorkTime, getPcOffServareaInfo, getPcOffLoginUserInfo, callPcOffTempDelay, callPcOffEmergencyUse, callCmmPcOnOffLogPrc — 6종 모두 Main IPC·Preload·Renderer 연동

### 빌드·실행

- **Preload**: CommonJS 별도 빌드(tsconfig.preload.json)로 Electron에서 정상 로드
- **창 경로**: main 기준 __dirname으로 preload·renderer HTML 경로 해결

### 시뮬레이터·CI

- Flow-01~08 시나리오(login_success, lock_reason_input, update_success, update_failure_retry, password_change_confirm, tamper_attempt, offline_detected, installer_registry_sync)
- parity-report.json, parity-summary.md, CI 아티팩트

### 로깅

- JSONL, TelemetryLogger, PATHS.logsDir
- 사용 중 로그 코드: APP_START, LOGIN_SUCCESS, LOGIN_FAIL, LOGOUT, LOCK_TRIGGERED, UNLOCK_TRIGGERED, UPDATE_*, OFFLINE_DETECTED, PASSWORD_CHANGE_DETECTED, PASSWORD_CONFIRM_DONE, AGENT_TAMPER_DETECTED, AGENT_RECOVERED 등(constants.ts·logcode.md 참고)

### 자동 업데이트 (FR-03, Flow-03/04) ✅

- **electron-updater 연동**: `autoUpdater` 기반 실제 업데이트 검사·다운로드·적용
- **무확인 자동 적용**: `autoDownload: true`, `autoInstallOnAppQuit: true`, 다운로드 완료 시 `quitAndInstall()` 자동 호출
- **재시도 큐**: 네트워크 오류·무결성 실패 시 `update/retry-queue.json`에 저장, 1분 후 재시도, 최대 3회
- **Renderer 연동**: 진행률 실시간 표시(`onUpdateProgress`), 상태별 버튼 텍스트 갱신, 앱 버전 표시
- **electron-builder 설정**: `package.json`에 Windows NSIS / macOS DMG 빌드·publish 설정 추가
- **로그**: UPDATE_FOUND, UPDATE_DOWNLOADED, UPDATE_APPLIED, UPDATE_FAILED 기록

### 비밀번호 변경 확인 (FR-04, Flow-05) ✅

- **서버 응답 감지**: `/getPcOffWorkTime.do` 응답의 `pwdChgYn=Y` 플래그로 비밀번호 변경 감지
- **확인-only 정책**: 확인 UI만 표시, 비밀번호 검증/재로그인 요구 없음 (FR-04 준수)
- **AuthPolicy 연동**: `onPasswordChangeDetected`, `confirmPasswordChange` 메서드 구현
- **Renderer 모달**: 비밀번호 변경 알림 모달 + 확인 버튼
- **IPC 채널**: `pcoff:password-change-detected`, `pcoff:getPasswordChangeState`, `pcoff:confirmPasswordChange`
- **로그 코드**: `PASSWORD_CHANGE_DETECTED`, `PASSWORD_CONFIRM_DONE`

### Agent Guard (FR-07, Flow-06) ✅

- **무결성 체크**: SHA-256 해시 기반 파일 무결성 검증, 기준선 캡처/검증
- **파일 모니터링**: `fs.watch` 기반 실시간 파일 변경/삭제 감시
- **탐지 이벤트**: file_deleted, file_modified, hash_mismatch, permission_changed, process_kill_attempt
- **자동 복구 트리거**: 플랫폼별 복구 전략 (Windows: 서비스·ACL, macOS: LaunchDaemon)
- **IPC 연동**: `pcoff:getGuardStatus`, `pcoff:getGuardTamperEvents`, `pcoff:verifyIntegrity`
- **로그 코드**: `AGENT_TAMPER_DETECTED`, `AGENT_TAMPER_ATTEMPT`, `AGENT_RECOVERED`, `AGENT_RECOVERY_FAILED`, `AGENT_STOP_ATTEMPT`
- **시뮬레이터**: `tamper_attempt` 시나리오 검증 완료

### Ops Observer (FR-08, Flow-07) ✅

- **heartbeat**: 주기적 HEARTBEAT 로그 기록 + 서버 전송 큐 적재
- **로그 배치 전송**: 1분 주기 flush, 실패 시 지수 백오프 재시도 (최대 5분)
- **서버 API**: `POST /reportAgentEvents.do` (events, deviceId, sessionId)
- **크래시 감지**: uncaughtException/unhandledRejection 시 CRASH_DETECTED 기록 후 전송 시도, process.exit(1)
- **오프라인 보고**: reportOffline(reason) → OFFLINE_DETECTED 로그 + 즉시 전송 시도
- **TelemetryLogger transport**: 로그 기록 시 큐 적재 → 주기/즉시 서버 전송
- **시뮬레이터**: offline_detected 시나리오 검증 완료

### 에이전트 UI·잠금화면 UI 분리 (트레이 작동정보) ✅

- **화면 분리 + 단일 창 전환**:
  - `main.html` + `main-info.js`: **에이전트 작동정보 조회 화면** (액션 버튼 없음)
  - `lock.html` + `lock.js`: **잠금화면** (임시연장/긴급사용/PC-ON/PC-OFF). PC-ON·긴급사용 성공 시 같은 창에서 작동정보로 전환
  - `index.html` + `renderer.js`: **로그인 화면**. 로그인 성공 시 잠금 필요하면 **같은 창**에서 잠금화면으로 전환
  - 모든 화면이 **하나의 mainWindow**에서 전환되며 새 창을 띄우지 않음
- **시스템 트레이 구현**:
  - 트레이 아이콘(`assets/tray-icon.png`, postbuild에서 `scripts/create-tray-icon.mjs`로 생성, 없으면 Base64 fallback, macOS setTemplateImage) + 컨텍스트 메뉴
  - 전역 단축키: Cmd/Ctrl+Shift+L(로그아웃), I(작동정보), K(잠금화면). 트레이 미노출 시에도 사용 가능
  - 트레이 클릭 시 작동정보 화면 열기. 창이 모두 닫혀도 트레이에서 앱 유지
- **운영 모드 관리**: `NORMAL`, `TEMP_EXTEND`, `EMERGENCY_USE`, `EMERGENCY_RELEASE` 상태 추적 및 실시간 갱신
- **IPC 채널 추가**:
  - `pcoff:getTrayOperationInfo`: 작동정보 조회 (반영 근태, 버전, 모드)
  - `pcoff:refreshMyAttendance`: 근태정보 새로고침
  - `pcoff:getOperationMode`, `pcoff:setOperationMode`: 모드 조회/설정
  - `pcoff:mode-changed`: 모드 변경 이벤트 (Renderer로 전송)
  - `pcoff:openLockWindow`, `pcoff:closeCurrentWindow`: 창 제어
  - `pcoff:logEvent`: Renderer에서 로그 이벤트 기록
- **로그 코드**: `TRAY_INFO_OPENED`, `TRAY_ATTENDANCE_REFRESHED`, `TRAY_MODE_CHANGED`

---

## 다음 진행 사항 (우선순위 참고)

### 1. 설치자 레지스트리 (FR-09, Flow-08)

- **목표**: 설치 수행자 계정·사번·기기·설치 시각을 서버에 등록·조회
- **작업**: 설치 시 수집 로직, 서버 API 호출, (선택) 조회 UI/시뮬레이터
- **DoD**: 설치자 정보가 서버에서 조회 가능해야 함

### 2. 이석 감지·해제 플로우 (Flow-02 연계, 이석·절전 감지 리포트)

- **목표**: 이석 화면에서 사유 입력 후 PC-ON(잠금 해제) 가능, **휴게시간 중 이석해제 시 사유입력 예외처리**
- **사유입력 정책**
  - `leaveSeatReasonYn=YES` && `leaveSeatReasonManYn=YES` → 사유 필수
  - **단, 휴게시간 중에는 사유입력을 면제** (정책 필드 예: `isBreakTime=true` 또는 시업/종업 사이 휴게 구간 판별)
  - 휴게시간 판별: `getPcOffWorkTime` 응답의 휴게시간 정보(예: `breakStartTime`, `breakEndTime`) 활용
- **작업**
  - 사유 입력 UI·필수 여부, 타이머 규칙
  - 휴게시간 판별 로직 + 예외 분기 추가
  - `callCmmPcOnOffLogPrc` 또는 관련 API와 연동
- **DoD**: 사유 입력·타이머 규칙이 기존(MFC)과 동일, 휴게시간 중 사유 면제 동작

### 3. 로그 코드 전수 반영 (PRD §7)

- **목표**: `docs/operations/logcode.md`와 매핑, 필수 이벤트 전부 로깅
- **작업**: LOGIN_SUCCESS/FAIL, LOCK_TRIGGERED/UNLOCK_TRIGGERED, UPDATE_*, PASSWORD_CHANGE_DETECTED/CONFIRM_DONE, AGENT_TAMPER_DETECTED/RECOVERED, CRASH_DETECTED, OFFLINE_DETECTED, LEAVE_SEAT_* 등 누락 이벤트 추가
- **DoD**: 제품 요구사항의 필수 이벤트가 모두 기록·조회 가능

### 4. 패키징 및 플랫폼 검증 (NFR-01, DoD)

- **목표**: Windows installer, macOS pkg/dmg 빌드, 두 OS에서 설치·실행 검증
- **작업**: electron-builder 또는 동등 도구 설정, 코드 서명/notarization 정책 반영
- **DoD**: Windows·macOS 설치 및 실행 검증 완료

---

## 추가 요청사항 (리포트 반영)

### 5. 인스톨/언인스톨 정책 실구현 (인스톨·언인스톨 정책 리포트)

- **인스톨 정책**
  - 설치 전: 환경 점검(OS 버전/디스크 여유/네트워크 연결/관리자 권한), 중복 설치 탐지(기존 프로세스·서비스 존재 시 중단 또는 업그레이드), 설치자 인증(사번·계정·기기)
  - 설치 중: 파일 배치, Windows(서비스/작업스케줄러/ACL)·macOS(LaunchAgent/LaunchDaemon), 해시 기준선(SHA-256) 생성, 설치자 레지스트리 API 호출
  - 설치 후: 초기 heartbeat, 실패 시 롤백/제한 모드, 감사 로그(`INSTALL_START`, `INSTALL_SUCCESS`, `INSTALL_FAIL`, `INSTALL_ROLLBACK`, `INSTALLER_REGISTRY_SYNC`)
  - **최소 권한 설치기**: 설치 시 불필요한 시스템 변경 최소화, 관리자 권한 요청 범위 명확히 문서화
- **언인스톨 정책**
  - 일반 사용자 임의 삭제 금지; 삭제는 관리자 승인 또는 정책 토큰(1회용)으로만 허용
  - 삭제 시도 탐지 시 즉시 보고(`TAMPER_ATTEMPT`, `AGENT_STOP_ATTEMPT`, `UNINSTALL_ATTEMPT`) → 자동 복구 → 실패 시 격리 모드 + 운영 알림
  - 정상 언인스톨: 관리자 인증 → 정책 검증 → 서버 승인 → 실행 후 `UNINSTALL_SUCCESS` 보고
  - 언인스톨 시 잔여 파일/레지스트리 정리, 로컬 로그 아카이브 또는 서버 업로드 후 삭제
- **복구 전략**
  - 탐지 → 자동 복구(재설치/파일 복원) → 복구 실패 시 격리 모드 + 운영팀 알림(`SELF_HEAL_SUCCESS`, `SELF_HEAL_FAIL`, `ISOLATION_MODE_ENTERED`)
  - 격리 모드: 잠금화면 유지, 핵심 기능만 동작, 운영팀 원격 조치 대기
- **모듈**: `installer-registry`(신규), `agent-guard`/`ops-observer` 확장, 이벤트 코드 전수 반영(`UNINSTALL_*`, `TAMPER_ATTEMPT`, `SELF_HEAL_*`, `ISOLATION_MODE_*` 등)

### 6. 잠금화면·에이전트 창 닫기 방지 (추가 요청, FR-07·FR-18 보완)

- **목적**: 사용자가 **에이전트 창** 또는 **잠금화면 창**을 **창 닫기(X 버튼)** 로 종료·숨기지 못하게 한다. 프로세스 Kill 통제(FR-18)와 Agent Guard(FR-07)가 프로세스·파일 단위 보호를 담당하는 반면, 본 항목은 **UI/창 단위**에서의 종료 방지를 명시한다.
- **요구사항**
  - **잠금화면 표시 중**: 창의 닫기 버튼 비활성화 또는 `close` 이벤트 차단. 사용자가 창을 닫아 잠금을 우회할 수 없어야 한다.
  - **에이전트(작동정보) 창 표시 중**: 정책에 따라 닫기 시 최소화만 허용하거나, 닫기 버튼 비활성화. (트레이로만 최소화 가능하게 할지 여부는 정책 결정.)
  - **로그인 창**: 로그인 전/후 모두 앱 종료는 트레이 메뉴 "종료" 등 관리된 경로로만 허용할 수 있음(선택).
- **구현 방향**
  - Electron `BrowserWindow`: `setClosable(false)` 또는 `close` 이벤트에서 `event.preventDefault()` 후 `window.hide()`(최소화) 적용.
  - 잠금화면 창: `setClosable(false)` 권장. 다중 디스플레이 시 모든 잠금 창에 동일 적용.
- **연계**: FR-07(Agent Guard), FR-18(프로세스 Kill 통제)와 함께 "사용자가 에이전트·잠금화면을 종료시키지 못하게 한다"는 요구를 **프로세스 + 창** 단위로 완결한다.

### 7. 프로세스 Kill 통제 + 관리자 OTP 승인 (Kill 통제·OTP 보고서)

- **원칙**: 사용자 임의 종료 차단(표준 권한에서 kill/taskkill 불가), Kill은 관리자 OTP 검증 후에만 허용, 감사 로그 100% 기록, Windows/Linux/macOS 동일 모델
- **OS별 보호**
  - Windows: LocalSystem 서비스, DACL로 `PROCESS_TERMINATE` 미부여, Recovery + Watchdog
  - Linux: root/systemd, `ProtectSystem=strict`, `ProtectHome=yes`, `NoNewPrivileges=yes`, `CapabilityBoundingSet=`, `Restart=always`, systemd watchdog(`WatchdogSec=30`)
  - macOS: LaunchDaemon(root), root:wheel 소유·일반 사용자 write 금지, KeepAlive, (선택) EndpointSecurity
- **Kill 시퀀스**: `KillRequest` 등록 → OTP 발송 → 관리자 OTP 입력 → `KillToken`(JWT/PASETO, TTL 2분) 발급 → `kill-execute` + 토큰 검증 후 종료
- **API**
  - `POST /kill-requests`: KillRequest 등록, 관리자 OTP 발송 트리거
  - `POST /kill-requests/{id}/verify-otp`: OTP 검증, 성공 시 KillToken 발급 (TTL 2분)
  - `POST /kill-execute`: Bearer KillToken 헤더, process fingerprint 검증 후 종료 실행
  - OTP 재시도 제한: 3회, 초과 시 30분 차단
- **관리자 인가**: `admin:kill` 권한 보유 사용자만 OTP 발급 가능, 요청 내역 대시보드 노출
- **통신 보안**: mTLS(터미널 인증서 pinning), API Gateway rate-limit
- **Process Fingerprint**: `{ pid, createdAt, exePath, cmdLine, hash(exePath) }` — PID 재사용 공격 방지
- **로그 코드**: `KILL_REQUEST_CREATED`, `KILL_OTP_SENT`, `KILL_OTP_VERIFIED`, `KILL_OTP_FAILED`, `KILL_TOKEN_ISSUED`, `KILL_EXECUTED`, `KILL_REJECTED`, `KILL_ATTEMPT_BLOCKED`
- **Phase 1**: Service/Daemon 권한 분리 + 사용자 kill 차단, KillRequest/OTP/KillExecute 최소 구현, 감사 로그, macOS plist 확정, Linux systemd 유닛 템플릿

### 8. 오프라인 복구·잠금 동작 (오프라인 설계안)

- **목표**: 오프라인 시 전용 안내 화면, 재시도 버튼, 30분 유예 후 미복구 시 화면 잠금(PC 사용 불가), 전 과정 heartbeat/이벤트 보고
- **상태**: `OFFLINE_GRACE`(30분 복구 대기), `OFFLINE_LOCKED`(잠금)
- **감지**: heartbeat 3회 연속 실패 또는 핵심 API 네트워크 오류 2회 연속 → `OFFLINE_DETECTED` → `OFFLINE_GRACE`
- **UI**
  - 지정 문구: "네트워크 연결이 끊어졌습니다. 30분 이내에 복구되지 않으면 화면이 잠깁니다."
  - 경과 시간: `mm:ss / 30:00` 형식 카운트다운
  - 버튼: `다시 시도`, `네트워크 설정`, `관리자 문의`
  - `OFFLINE_LOCKED` 시: "네트워크 복구 후 자동 해제됩니다" + 다시 시도 버튼만 활성화
- **IPC**: `pcoff:getConnectivityState`, `pcoff:retryConnectivity`, `pcoff:onConnectivityChanged`
- **동작 제한**: `OFFLINE_LOCKED` 시 PC-ON/임시연장/긴급사용 차단, 긴급해제만 허용(정책에 따라)
- **저장**: `offline-state.json`(`offlineSince`, `deadline`, `locked`, `lastRetryAt`, `retryCount` 등), 앱 재시작 시에도 잠금 유지
- **복구**: 네트워크 복구 감지 → heartbeat 성공 → `OFFLINE_RECOVERED` → 잠금 해제 → 정상 화면 복귀
- **이벤트**: `OFFLINE_DETECTED`, `OFFLINE_RETRY`, `OFFLINE_RECOVERED`, `OFFLINE_TIMEOUT_LOCK`, `OFFLINE_GRACE_STARTED` 로그·heartbeat 보고

### 9. 다중 디스플레이(보조모니터) 감지·처리 (다중 디스플레이 보고서)

- **현황**: 메인 프로세스에 다중 모니터 동기화 반영 완료 — `screen.getAllDisplays()`, 디스플레이당 잠금 창 1개, `display-added`/`display-removed`/`display-metrics-changed` 핫플러그 대응
- **추가 권고**
  - 잠금 강화 시 `alwaysOnTop`, 포커스 정책, OS별 우회(Alt+Tab, Mission Control) 테스트
  - QA 시나리오에 "다중 모니터 연결/해제 반복" 케이스 포함

### 10. Windows Defender/SmartScreen 경고 최소화 (SmartScreen 리포트)

- **목표**: 설치/업데이트 시 Defender·SmartScreen 경고 가능성 축소, 원인 추적·소명용 증적 확보, 표준 릴리즈 체크리스트 확보
- **A. 코드 서명 (최우선)**
  - Authenticode 적용(가능 시 EV Code Signing), 설치 EXE·언인스톨러·업데이트 바이너리 전부 서명
  - 타임스탬프 서버 적용(만료 후에도 서명 유효): `http://timestamp.digicert.com` 등
  - CI: 빌드 후 서명 → `signtool verify /pa /v <file>` 필수 게이트
  - macOS: notarization 필수, `codesign --verify --deep --strict`
- **B. SmartScreen 평판**: 제품명/회사명/서명자·배포 URL·파일명 일관 유지, 릴리즈 단위 배포, 서명자 평판 축적(동일 인증서 지속 사용)
- **C. 업데이트 무결성**
  - 아티팩트 서명 + SHA-256, 검증 실패 시 설치 중단·상세 로그
  - 매니페스트: 버전·해시·배포 시각·서명자 정보 보관
  - 실패 원인 구분 로깅: `UPDATE_SIGNATURE_INVALID`, `UPDATE_HASH_MISMATCH`, `UPDATE_NETWORK_ERROR`
- **D. 설치기 최소권한·투명화**: 불필요한 시스템 변경 최소화, 관리자 작업 분리/문서화, INSTALL_* 이벤트 일관 기록
- **E. 오탐 대응**
  - Microsoft: https://www.microsoft.com/wdsi/filesubmission
  - VirusTotal: 벤더별 오탐 신고 링크 참조
  - 릴리즈마다 해시·서명·탐지 로그 아카이빙, 고객사 가이드에 배포 URL·해시 검증·서명 확인 방법 포함
- **체크리스트**
  - 릴리즈 전: 인증서 유효성, 빌드 재현성, 보안 점검, 이전 버전 오탐 여부 확인
  - 릴리즈 중: 서명 → 검증 → SHA-256 생성 → 매니페스트 업로드
  - 릴리즈 후: SmartScreen 경고 모니터링, 오탐 발생 시 즉시 제출, 회고 기록
- **저장소 적용**: 코드 서명/notarization을 실제 작업 티켓으로 분해, README/운영문서에 Windows 서명·검증 절차(signtool 등) 추가, 업데이트 실패 원인(서명/해시/네트워크) 구분 로깅, CI/CD 게이트와 체크리스트 연동

### 11. 이석/절전 감지 구현 (이석·절전 감지 방안 리포트 + 절전모드-이석감지 연계 리포트)

- **목표**
  - API 기준 이석시간(마우스/키보드 미사용) 초과 시 이석 화면 표시
  - 절전 진입 후 복귀 시 `절전 경과시간 >= API 이석시간`이면 이석 화면 표시
  - 이석 화면에 **이석감지시각** 표시 (절전 초과 시 절전 시작시각으로 표기)
- **정책 소스**: `getPcOffWorkTime` — `leaveSeatUseYn`, `leaveSeatTime`(분), `leaveSeatReasonYn`, `leaveSeatReasonManYn`; `WorkTimeResponse`에 `leaveSeatTime` 추가·정책 캐시 유지
- **아키텍처**
  - Main: `LeaveSeatDetector`(신규) — `powerMonitor.getSystemIdleTime()` 5초 폴링, `powerMonitor.on("suspend"|"resume")`, 정책 갱신, 상태 전이 `LOCK(reason=leave-seat)`, `webContents.send("pcoff:leaveSeatDetected", payload)`
  - Renderer: 이석 화면(screenType=empty 동등) 표시, **이석감지시각 UI 추가**, 사유 입력 정책에 따른 해제 UI
- **알고리즘**
  - **Idle**: `leaveSeatUseYn===Y` && `leaveSeatTime>0` 시, `idleSec >= leaveSeatTime*60`이면 이석 감지 → LOCK(idle-timeout) → 이석 화면, `leaveDetectedAt=감지시점`
  - **절전**: suspend 시 `sleepStartedAt` 기록, resume 시 `sleepElapsedSec >= leaveSeatTime*60`이면 이석 감지 → LOCK(sleep-timeout) → 이석 화면, **`leaveDetectedAt=sleepStartedAt`** (절전 시작시각으로 표기)
- **상태 변수**: `powerState.suspendAt`, `leaveState.detectedAt`, `leaveState.detectedReason`(`INACTIVITY`|`SLEEP_EXCEEDED`)
- **IPC**: Main→Renderer `pcoff:leaveSeatDetected`(reason, detectedAt, leaveSeatTimeSec, observedSec), Renderer→Main `pcoff:releaseLeaveSeat`(reasonText), 해제 시 LOCK 해제 + PC-ON 로그 API 연동
- **로그**: `LEAVE_SEAT_IDLE_DETECTED`, `LEAVE_SEAT_SLEEP_DETECTED`, `LEAVE_SEAT_RESUME_CHECKED`, `LEAVE_SEAT_RELEASED`, `SLEEP_ENTERED`, `SLEEP_RESUMED`
- **예외**: 정책 조회 실패 시 마지막 정책 임시 사용/없으면 비활성, 음수 경과시간 보정, 중복 이벤트 방지, 긴급사용/예외근무 시 bypass
- **적용 순서**: WorkTimeResponse·정책 캐시 → LeaveSeatDetector(idle+suspend/resume) → 상태머신/IPC·Renderer 이석 화면 → 이석 해제 API/사유 정책 → 로그·시뮬레이터 확장

### 12. 일반모드/임시연장/긴급사용 중 이석정보 서버 전송 (이석정보 서버 전송 리포트)

- **목표**: 이석 시작(START)/종료(END) 정보를 세션 기반으로 서버에 전송, 장애 내성 보장
- **상태 모델**: `ACTIVE` → `LEAVE_SEAT` → `RESUMED`, 동일 `leaveSeatSessionId`로 START/END 매핑
- **모드 매핑**: 일반모드(`NORMAL`), 임시연장(`TEMP_EXTEND`), 긴급사용(`EMERGENCY_USE`)
- **API**: `POST /reportLeaveSeatEvent.do`
  - 요청: `eventType`(LEAVE_SEAT_START/END), `workSessionType`, `leaveSeatSessionId`, `workSessionId`(선택), `reason`, `reasonRequired`, `occurredAt`, `clientVersion`
  - 응답: `code`, `message`, `accepted`, `eventId`, `serverReceivedAt`
- **데이터 모델**: `LeaveSeatEvent`(eventId, leaveSeatSessionId, eventType, occurredAt, workYmd, userServareaId, userStaffId, deviceId, workSessionType, workSessionId, reason, transmitStatus, retryCount)
- **IPC**: `pcoff:leaveSeatStart`, `pcoff:leaveSeatEnd`
- **재시도**: 네트워크 실패 시 로컬 큐(JSONL) 적재 + 지수 백오프(10s → 30s → 60s → 5m → 15m), 최대 재시도 초과 시 `FAILED` + Ops Observer 경고
- **정합성**: START 없이 END 금지, 중복 START 방지, idempotent 처리(eventId 기반)
- **보안/개인정보**: reason 길이 제한(200자), 제어문자 제거, 로그 출력 시 reason 원문 마스킹 옵션, HTTPS/TLS 필수
- **로그**: `LEAVE_SEAT_START`, `LEAVE_SEAT_END`, 전송 실패 시 경고
- **운영/관제 포인트**: START/END 수, START 대비 END 누락 비율, 평균 이석 시간, 전송 실패율/재시도 성공률, 특정 단말 반복 실패 알람
- **Phase 1(MVP)**: 전용 API + Renderer 버튼 + Main IPC + 기본 재시도 큐
- **Phase 2**: END 누락 탐지 배치, 관제 대시보드/알람, reason 마스킹 고도화
- **Phase 3**: 정책 기반 자동 이석 종료(강제 로그아웃/세션 종료 연동), 통계 리포트 자동 생성

### 13. 시업/종업 화면 표시 로직 (시업·종업 화면 설계서)

- **목표**: 종업화면 / 시업화면 / 일반 PC 사용화면을 일관된 로직으로 결정. **옵션설정 1227**에 따른 일자변경 시각 이후에 시업↔종업 화면이 전환되어야 하며, 이 기준으로 종업화면과 시업화면을 구분해야 사용자의 **출근 체크 여부를 시각적으로 명확히** 할 수 있다.
- **일자변경 시각 기준 (옵션설정 1227, API `exCountRenewal`)**
  - **API 로그 상 `exCountRenewal`** 항목의 **일시값**을 기준으로 화면을 구분한다.
  - **현재 시각 < exCountRenewal** → **종업화면** (OFF 화면)
  - **현재 시각 ≥ exCountRenewal** → **시업화면** (BEFORE/START 화면)
  - 위 기준 적용이 출근 체크 여부 시각화에 가장 명확하다.
- **자율출퇴근(시간양 설정) — 옵션설정 1385, API `freeTimeWorkTypeYn`**
  - **출근 체크 여부에 따른 PC 잠금화면 노출 여부**는 **옵션설정 1385번**에 따라 정의된다.
  - API 응답 추정 필드: **`freeTimeWorkTypeYn`** (자율출퇴근 여부/시간양 설정 연동)
  - 해당 옵션에 따라 자율출근 시 출근 미처리 시 잠금화면 표시 여부를 결정한다.
- **핵심 판단 포인트 (설계서 보조)**
  1. PC-ON 예외: `isPcOn && now >= pcOnAllowedAt` → 시업화면 없이 즉시 사용
  2. **일자변경 경계**: `exCountRenewal`(옵션 1227) 이전 → 종업, 이후 → 시업
  3. 종업/연장 경계 계산: 종업시각 당일/익일, 임시연장 허용시간 당일/익일 조합
  4. 화면 결정: `now < exCountRenewal` → 종업화면, `now >= exCountRenewal` → 시업화면 (옵션 1227 적용 시)
- **케이스별 규칙 (설계서)**
  - 종업시각 당일 + 임시연장 경계 당일: 익일 00:00부터 시업화면
  - 종업시각 당일 + 임시연장 경계 익일: `tempExtendAllowedUntil` 이후 시업화면
  - 종업시각 익일: `tempExtendAllowedUntil` 이후 시업화면
- **자율출근(시업시각 없음)**: 시업화면에서 PC-ON 버튼 활성화 → 출근처리 + 즉시 `USABLE`. 잠금화면 여부는 옵션 1385(`freeTimeWorkTypeYn`) 반영.
- **상태머신 연계**
  - `SCREEN_TYPE_DETERMINED` 상태 전이 시 화면 결정
  - 타이머/`exCountRenewal` 기준 자동 전환
- **보완**
  - `shiftStartBoundary` 필수/선택 분리
  - `tempExtendExhausted` 반영 (임시연장 소진 시 즉시 종업화면)
  - 경계값 포함/제외 고정(`>=`)
  - 타임존 일치 필수 (서버-클라이언트 UTC 동기화)
  - PC-ON 예외 우선순위 고정
- **로그 코드**: `SCREEN_TYPE_BEFORE`, `SCREEN_TYPE_OFF`, `SCREEN_TYPE_USABLE`, `SCREEN_TRANSITION`

### 14. 고객사 설정 반영 (문구·이미지·로고·긴급해제·이석해제 비밀번호) (고객사 설정 리포트)

- **요구**: 관리자 콘솔에서 시업/종업/이석 화면 문구·이미지, 잠금화면 로고, 긴급해제 사용/비밀번호, 이석해제 비밀번호 옵션 설정
- **정책 모델**: `TenantLockPolicy`
  - `lockScreen.screens[before|leave|off].title/message/imageAssetId`
  - `unlockPolicy.emergencyUnlockEnabled`, `unlockPolicy.emergencyUnlockPassword.minLength`, `unlockPolicy.emergencyUnlockPassword.requireComplexity`, `unlockPolicy.emergencyUnlockPassword.maxFailures`, `unlockPolicy.emergencyUnlockPassword.lockoutSeconds`, `unlockPolicy.emergencyUnlockPassword.expiresInDays`
  - `unlockPolicy.leaveSeatUnlockRequirePassword`
- **API**
  - 설정 조회: `GET /api/v1/pcoff/tenants/{tenantId}/lock-policy`
  - 설정 게시: `POST /draft`, `POST /publish`, `POST /rollback`
  - 자산 업로드: `POST /api/v1/assets/upload` (png/jpg/webp/svg, 2MB 이하)
  - 긴급해제 검증: `POST /api/v1/pcoff/unlock/emergency/verify`
- **관리자 콘솔 워크플로우**
  - **Draft 저장**: 미리보기/저장, 즉시 적용 안 됨
  - **Publish**: 승인 후 에이전트 배포 (버전 증가, rolloutPolicy 적용)
  - **Rollback**: 이전 정상 버전으로 즉시 복원
  - **권한 모델**: VIEWER(읽기), EDITOR(초안), APPROVER(게시), ADMIN(전체)
- **정책 배포 방식(하이브리드)**
  - **Push**: 정책 게시 시 서버→에이전트 WebSocket 알림 또는 Long-Polling, TTL 30분 이내 갱신
  - **Periodic Polling**: 30분 주기 폴링 백업, 버전 비교 후 변경 시 다운로드
- **클라이언트 반영**
  - 렌더링 우선순위: 서버 정책 > 고객사 기본값 > 앱 내 fallback
  - 화면 매핑: `screenType=before` → before, `screenType=empty` → leave, 기타 → off
  - 긴급해제: `emergencyUnlockEnabled=false` → 버튼 숨김, true → 비밀번호 모달 + 서버 검증
  - 이석해제 비밀번호: `leaveSeatUnlockRequirePassword=true` → 해제 시 비밀번호 단계 강제
  - 캐시/오프라인: 마지막 정상 정책 로컬 암호화 캐시, TTL 24h, 오프라인 시 안전모드
- **감사 이벤트**: `LOCK_POLICY_DRAFT_SAVED`, `LOCK_POLICY_PUBLISHED`, `LOCK_POLICY_ROLLBACK`, `EMERGENCY_UNLOCK_ATTEMPT/SUCCESS/FAILURE`, `LEAVE_UNLOCK_PASSWORD_REQUIRED_APPLIED` 등
- **Phase 1**: `WorkTimeResponse` 확장 필드 추가, Renderer 동적 렌더링, 긴급해제 ON/OFF + 비밀번호 검증 API

### 15. 긴급해제(비밀번호 기반) 설계 (긴급해제 리포트)

- **목표**: 긴급사용과 별개로, 긴급해제(비밀번호 검증 후 잠금 해제) 독립 제어
- **긴급사용 vs 긴급해제**
  | 구분 | 긴급사용(EmergencyUse) | 긴급해제(EmergencyUnlock) |
  |------|------------------------|---------------------------|
  | 인증 | 관리자 승인/정책 | 비밀번호 검증 |
  | 용도 | 업무 연장 | 잠금 즉시 해제 |
  | 만료 | 정책 시간 | 3시간 고정 |
  | 감사 | 별도 승인 기록 | 시도/성공/실패/만료 |
- **노출 조건**: `emergencyUnlockUseYn=YES` && `emergencyUnlockPasswordSetYn=Y` && 잠금 상태
- **검증 플로우**: 비밀번호 입력 → 서버 검증 API(`POST /callPcOffEmergencyUnlock.do`) → 성공 시 잠금해제, 실패 시 남은 횟수 표시
- **시도 제한**: 5회(policy.maxFailures) 초과 시 5분(policy.lockoutSeconds) 차단, 차단 상태 로컬 저장 또는 서버 응답 기준 유지, 비밀번호 원문 로그 금지
- **3시간 만료**: 긴급해제 성공 후 `emergencyUnlockStartAt` 기록, 3시간 경과 시 조건 기반 잠금화면 자동 복귀, 5분 전 예고 알림 제공
- **IPC**: `pcoff:requestEmergencyUnlock`(password, reason)
- **API Client**: `EmergencyUnlockRequest`(password, reason, deviceId, userStaffId), `callPcOffEmergencyUnlock(request)`
- **API 응답**: `success`, `remainingAttempts`, `lockoutUntil`(실패 시), `message`
- **로그 코드**: `EMERGENCY_UNLOCK_ATTEMPT`, `EMERGENCY_UNLOCK_SUCCESS`, `EMERGENCY_UNLOCK_FAILED`, `EMERGENCY_UNLOCK_LOCKED`, `EMERGENCY_UNLOCK_EXPIRED`, `EMERGENCY_UNLOCK_EXPIRY_WARNING`
- **테스트**: 정책 OFF → 버튼 미노출, 정책 ON + 비밀번호 미설정 → 버튼 미노출, 올바른 비밀번호 → 해제 성공, 5회 초과 → 차단, 3시간 후 재잠금, 5분 전 경고 노출

### 16. 트레이 에이전트 작동정보 조회 (트레이 작동정보 리포트)

- **목표**: 시스템 트레이에서 PCOFF 작동정보(근태, 버전, 모드) 즉시 조회
- **트레이 메뉴**: `PCOFF 열기`, **`PCOFF 작동정보`(신규)**, `로그 보기`, `종료`
- **작동정보 패널**
  - 현재 반영 근태정보(기준 시각, 적용 정책)
  - 나의 근태정보(수동 새로고침 가능)
  - 현재 모드: 일반(`NORMAL`), 임시연장(`TEMP_EXTEND`), 긴급사용(`EMERGENCY_USE`), 긴급해제(`EMERGENCY_RELEASE`)
  - 버전정보: App Version, Agent/Core Version
- **상태 모델**: `TrayOperationInfo`
  - `reflectedAttendance`: { basedAt, appliedPolicy }
  - `myAttendance`: { workStartTime, workEndTime, pcOnYn, ... }
  - `versionInfo`: { appVersion, coreVersion, lastUpdatedAt }
  - `mode`: `NORMAL` | `TEMP_EXTEND` | `EMERGENCY_USE` | `EMERGENCY_RELEASE`
- **IPC**: `pcoff:getTrayOperationInfo`, `pcoff:refreshMyAttendance`, `pcoff:onModeChanged`
- **UX**: 캐시 우선 렌더 + 비동기 갱신, 실패 시 캐시 유지 + 오류 배지(! 아이콘), 모드 전환 시 실시간 업데이트, 트레이 아이콘 모드별 색상/배지 구분(선택)
- **로그 코드**: `TRAY_INFO_OPENED`, `TRAY_ATTENDANCE_REFRESHED`, `TRAY_MODE_CHANGED`
- **DoD**: 트레이 진입 → 패널 오픈, 5개 시나리오 PASS(근태/버전/모드 표시, 불러오기, 모드 전환, API 실패 시 캐시+오류 안내)

---

## 참고

- **단일 소스**: `PRD_5240_PcOff_Electron.md`, `TRD_5240_PcOff_Electron.md`, `PC_OFF_AGENT_API.md`, `VIBE_PROMPT_IMPLEMENTATION.md`
- **시뮬레이터**: `simulator/`, `artifacts/parity-report.json` — 새 플로우 추가 시 시나리오·parity 반영 권장
- **정의 완료(DoD)**: PRD §9 참고
