# Mac 설치 파일 실행 가이드

GitHub Release에서 받은 **5240 PcOff Agent** Mac용 `.dmg` 또는 `.zip`을 설치한 뒤, **「열 수 없음」** / **「Apple이 악성 코드 없음을 확인할 수 없습니다」** 경고가 나오는 경우의 해결 방법입니다.

- **Apple Silicon(M1/M2/M3 등)**: `*-arm64.dmg` 또는 `*-arm64-mac.zip` 사용.
- **Intel Mac**: `*-x64.dmg` 또는 `*-x64-mac.zip` 사용.  
  (Release에 아키텍처별 파일이 없으면 universal 또는 단일 빌드일 수 있습니다.)

---

## 왜 이런 경고가 나오나요?

- macOS **Gatekeeper**는 **Apple Developer ID로 서명되고 Apple notarization을 받은 앱**만 기본적으로 허용합니다.
- 현재 CI에서 만든 Mac 설치 파일은 **코드 서명·notarization을 하지 않습니다** (Apple Developer 계정·인증서 설정이 필요함).
- 그래서 "Apple이 이 앱에 악성 코드가 없음을 확인할 수 없습니다"라는 메시지와 함께 실행이 차단됩니다.
- **내부 테스트·개발용**으로는 아래 방법으로 실행을 허용할 수 있습니다.

---

## 방법 1: 마우스 오른쪽 버튼으로 "열기" (가장 간단)

1. **Applications** 폴더(또는 .dmg에서 복사한 위치)에서 **5240 PcOff Agent** 앱을 찾습니다.
2. **더블클릭하지 말고**, **마우스 오른쪽 버튼**(또는 Control+클릭)으로 앱을 클릭합니다.
3. 메뉴에서 **「열기」**를 선택합니다.
4. 다시 **「열기」** 버튼이 있는 창이 나오면 **「열기」**를 눌러 실행합니다.
5. 이 앱은 "승인된 앱"으로 기록되어, 다음부터는 **일반 더블클릭**으로도 실행됩니다.

---

## 방법 2: 시스템 설정에서 허용

1. **더블클릭**으로 실행을 시도했다가 **「열 수 없음」** / **「휴지통으로 이동」** 창이 떴다면 **「완료」**를 누릅니다.
2. **시스템 설정**(또는 시스템 환경설정)을 엽니다.
3. **개인 정보 보호 및 보안** → **보안**으로 이동합니다.
4. **「일반」** 탭 아래에 **"5240 PcOff Agent은(는) 다운로드한 앱에서 열었습니다"** 같은 문구와 **「그래도 열기」** 버튼이 보이면, **「그래도 열기」**를 클릭합니다.
5. 확인 창에서 다시 **「열기」**를 누르면 앱이 실행됩니다.

---

## 「그래도 열기」 후에도 "문제가 있기 때문에 열 수 없습니다"가 나올 때

**증상**: 보안 설정에서 **「그래도 열기」**를 눌렀는데, **「문제가 있기 때문에 5240 PcOff Agent(을)를 열 수 없습니다」** / **「개발자에게 문의하십시오」** 메시지가 뜨는 경우.

**가능한 원인**

- **아키텍처 불일치**: CI에서 만든 Mac 빌드가 **Apple Silicon(arm64) 전용**일 수 있습니다. **Intel Mac**에서 실행하면 이 오류가 날 수 있습니다. (반대로 Intel 전용 빌드를 Apple Silicon Mac에서 실행해도 비슷한 문제가 발생할 수 있습니다.)
- **격리(quarantine) 속성**: 일부 macOS에서는 「그래도 열기」만으로는 부족하고, 터미널에서 격리 속성을 제거해야 할 수 있습니다.
- **서명 없음**: 코드 서명·notarization이 없으면 특정 macOS 버전/설정에서 실행이 거부될 수 있습니다.
- **서명 불일치(Team ID 불일치)**: 터미널에서 실행 시 `dyld: Library not loaded ... (code signature ... have different Team IDs)` 가 나오면, 앱 실행 파일과 번들 안의 Electron Framework가 서로 다른 서명을 가지고 있어서 발생합니다. → 아래 **「Team ID 불일치(dyld)」** 참고.

**대응 방법**

1. **방법 3**처럼 터미널에서 **격리 속성 제거**를 먼저 시도합니다.

   ```bash
   xattr -cr "/Applications/5240 PcOff Agent.app"
   ```

   (앱 이름이 **5240 PcOff Agent 2**처럼 다르게 보이면, 해당 이름으로 바꿉니다.)

2. **본인 Mac 종류 확인**: **Apple 메뉴 → 이 Mac에 관하여**에서 **칩**이 "Apple M1/M2/M3" 등이면 Apple Silicon, "Intel"이면 Intel Mac입니다.  
   - Intel Mac인데 위 오류가 나면, **universal(arm64+x64) 빌드**가 포함된 새 버전이 나올 때까지 **소스에서 실행**하는 방법을 사용할 수 있습니다(아래 참고).

3. **소스에서 실행(개발/테스트용)**: 프로젝트를 클론한 뒤 다음으로 실행하면 설치 파일 없이 동작을 확인할 수 있습니다.

   ```bash
   npm ci && npm run start
   ```

4. **Team ID 불일치(dyld)**: 터미널에서 앱을 실행했을 때 `different Team IDs` / `Electron Framework not valid for use in process` 오류가 나온다면, 앱 번들 전체를 **동일한 서명(ad-hoc)**으로 다시 서명하면 됩니다. (한 번만 실행)

   ```bash
   codesign --force --deep --sign - "/Applications/5240 PcOff Agent.app"
   ```

   실행 후 앱을 다시 열어 봅니다. 정식 배포용이 아니라 **테스트/내부용**으로만 유효합니다.

---

## 방법 3: 터미널에서 격리 속성 제거 (고급)

**주의**: 아래 명령은 해당 앱에 대해 Gatekeeper 검사를 우회합니다. **신뢰하는 앱**에만 사용하세요.

1. **터미널**을 엽니다.
2. 아래 명령을 입력합니다 (앱 이름에 공백이 있으므로 따옴표 유지).

   ```bash
   xattr -cr "/Applications/5240 PcOff Agent.app"
   ```

3. Enter 후, **Applications**에서 **5240 PcOff Agent**를 더블클릭해 실행해 봅니다.

`.dmg`를 막 열어서 아직 Applications로 복사하지 않았다면, **드래그로 Applications에 앱을 넣은 뒤** 위 명령을 실행하면 됩니다.

---

## 설치 후 "내 로그인 정보가 아니다" / 다른 사용자로 로그인된 것처럼 보일 때

**증상**: 설치를 막 끝냈는데 앱을 실행하면 **이미 로그인된 상태**로 나오고, 표시되는 사용자 이름·정보가 **본인이 아님**.

**원인**: 앱은 **사용자별 데이터**를 `~/Library/Application Support/5240 PcOff Agent` 폴더에 저장합니다.  
이전에 **같은 Mac**에서 이 앱(또는 같은 이름의 앱)을 실행한 적이 있으면, 그때 저장된 **state.json**(로그인 정보)이 남아 있어 **이전 사용자 정보**가 그대로 보일 수 있습니다.

**해결**: 아래 폴더를 삭제(또는 안의 `state.json`만 삭제)한 뒤 앱을 다시 실행하면 **로그인 화면**이 나옵니다.

- **폴더 전체 삭제** (설정·로그인·로그 모두 초기화):  
  `~/Library/Application Support/5240 PcOff Agent`  
  (Finder에서 **이동 → 폴더로 이동** (Cmd+Shift+G) 후 위 경로 입력)
- **로그인 정보만 초기화**: 위 폴더 안의 **state.json** 파일만 삭제

---

## Apple 개발자 계정 없이 실행되는 이유 (ad-hoc 서명)

위 방법 중 **Team ID 불일치** 해결에 쓰는 `codesign --force --deep --sign -` 은 **Apple Developer Program 가입 없이** 동작합니다.

- **`--sign -`** 은 **ad-hoc identity**(로컬용 임시 서명)를 의미하며, 맥에 기본으로 있어 별도 등록이 필요 없습니다.
- 이 명령은 앱 번들 전체를 **같은 ad-hoc 서명**으로 통일해서 "different Team IDs" 오류만 제거할 뿐, **Apple이 인정하는 정식 서명이 아닙니다**.
- 따라서 **테스트·내부용**으로만 유효하고, 다른 사용자 PC에서는 같은 터미널 작업을 반복해야 할 수 있습니다.

**정식 배포**를 위해서는 아래처럼 **Apple 개발자 정보를 등록한 뒤** 코드 서명·notarization을 적용해야 합니다.

---

## 정식 배포를 위해 (개발자용)

- **나중에 외부 사용자에게 배포할 때**는 **Apple Developer Program** 가입 후 **Developer ID Application** 인증서로 앱을 **코드 서명**하고, **notarization**을 받아야 합니다. 그러면 사용자는 위와 같은 경고·터미널 작업 없이 설치·실행할 수 있습니다.
- electron-builder에서는 `CSC_*` 환경 변수·keychain 설정 후 `electron-builder --mac`으로 서명·notarization을 할 수 있으며, CI에서는 GitHub Secrets에 인증서·비밀번호를 넣어 자동화할 수 있습니다.
- 상세는 [다음_개발_진행_사항.md](다음_개발_진행_사항.md)의 "패키징 및 플랫폼 검증"·"Windows Defender/SmartScreen" 섹션 및 Apple 문서(Notarization, Code Signing)를 참고하세요.
