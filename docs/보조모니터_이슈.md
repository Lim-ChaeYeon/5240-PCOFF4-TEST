# 보조 모니터 잠금화면 이슈

다중 디스플레이 환경에서 **보조 모니터**에 표시되는 잠금화면에 배경(이미지·디폴트 색상)이 적용되지 않는 문제를 정리한 문서입니다.

---

## 1. 증상

| 구분 | 주 모니터 | 보조 모니터 |
|------|-----------|-------------|
| 잠금창 표시 | ✅ 동일 lock.html 표시 | ✅ 동일 lock.html 표시 |
| 배경 이미지 | ✅ 서버/설정 배경 정상 적용 | ❌ 배경 이미지 미적용 (회색/검정) |
| 디폴트 배경색 | ✅ 이미지 없을 때 그라데이션 적용 | ❌ 디폴트 색상도 미적용 |
| 문구·버튼·시계 | ✅ 정상 | ✅ 정상 |
| 잠금 해제 시 | ✅ 둘 다 해제·에이전트 창 전환 | ✅ 정상 |

- **영향**: 보조 모니터에서는 잠금화면이 **단색(회색 또는 검정)** 으로만 보이며, 주 모니터와 동일한 배경/테마가 나오지 않음.
- **확인 환경**: macOS 다중 디스플레이에서 반복 재현.

---

## 2. 시도한 대응 (미해결)

다음과 같은 수정을 적용했으나 보조 모니터에서는 배경/디폴트 색상이 여전히 적용되지 않음.

| # | 대응 내용 | 결과 |
|---|-----------|------|
| 1 | **getInitialLockWork** IPC 추가 — 보조 잠금창 로드 시 메인에서 `lastWorkTimeData`(배경 URL 포함) 요청·적용 | 보조에서 데이터 수신 후에도 배경 미적용 |
| 2 | **onLockInitialWork** 푸시 — `did-finish-load` 후 메인에서 동일 데이터 푸시(80ms·350ms 지연) | 동일 |
| 3 | **pickLockScreenImageFields** — getWorkTime() 응답에 배경 필드가 없을 때 `initialLockWork`의 배경/로고 필드로 보강 후 재적용 | 동일 |
| 4 | **디폴트 배경(LOCK_DEFAULT_BG)** — 배경 URL 없을 때 다크 블루 그라데이션 + `has-lock-bg` 적용 | 주 모니터만 적용, 보조 미적용 |
| 5 | **스크립트 로드 직후 기본 배경 적용** — lock.js 상단 IIFE에서 `document.body`에 LOCK_DEFAULT_BG 즉시 적용 | 동일 |
| 6 | **applyLockScreenImages** — 항상 먼저 디폴트 배경 적용 후 이미지 URL로 덮어쓰기 | 동일 |

동일한 lock.html·lock.js·preload를 사용하는데도 보조 창에서만 스타일이 적용되지 않는 것으로 보아, **Electron/멀티 디스플레이·풀스크린 환경**에서의 렌더링·스타일 적용 차이 가능성이 있음.

---

## 3. 캡처(미러) 방식 시도 및 원복

- **시도**: 주 모니터 잠금화면을 `webContents.capturePage()`로 캡처해 보조 창에 **이미지로만** 표시하는 방식(lock-mirror.html + 주기 전송).
- **장점**: 주 화면과 픽셀 단위 동일 표시, 배경 이슈 회피.
- **이유 for 원복**: 사용자 판단으로 **캡처 방식은 원복**하고, 현재는 **기존 방식(보조도 lock.html 로드)** 유지.
- **현재 코드 상태**: 보조 모니터용 **lock-mirror.html 및 캡처 전송 로직 제거됨**. 보조도 lock.html 로드 + getInitialLockWork/onLockInitialWork/디폴트 배경 로직 유지.

---

## 4. 현재 상태 및 권장 사항

- **현재**: 보조 모니터 잠금화면 **배경(이미지·디폴트 색상) 미적용** 이슈는 **미해결**로 남아 있음.
- **기능**: 잠금 표시·해제·버튼·문구·시계·다중 디스플레이 핫플러그·해제 시 보조창 정리 등은 정상 동작.
- **권장**:  
  - 재현 환경(macOS/Windows, 디스플레이 구성, Electron 버전) 명시하여 이슈 트래킹.  
  - 추후 **캡처(미러) 방식** 재검토 또는 Electron/Chromium 측 멀티 디스플레이·풀스크린 이슈 조사 후 재시도 가능.

---

## 5. 보조 모니터 보완 작업 (2026-02-13 완료)

| # | 항목 | 수정 내용 |
|---|------|-----------|
| 5.1 | **임시연장 카운트 동기화** | 보조 잠금창에 임시연장 배지가 0으로만 나오던 문제. lock.js의 onLockInitialWork 콜백에서 extendCountEl 갱신 추가. main에서 기존 보조창 재사용 시 pcoff:lock-initial-work 전송, refreshWorkTimeFromApi 후 broadcastWorkTimeToLockWindows()로 주·보조 모든 잠금창에 근태 데이터 동기화. |
| 5.2 | **긴급해제 시 디스플레이 배치** | 보조 모니터에서 긴급해제 성공 후 작동정보 창이 주 모니터에만 떠 반응이 없어 보이던 문제. requestEmergencyUnlock 성공 시 요청 창(sender)의 디스플레이를 구해 showTrayInfoInCurrentWindow(onDisplay)로 전달, 해당 디스플레이에 작동정보 창 배치·포커스. |

---

## 6. 미해결 → 수정 반영: 긴급사용·긴급해제 버튼 동작 (2026-02-13)

| 구분 | 증상 | 조치 |
|------|------|------|
| **긴급사용** | 보조 모니터에서 긴급사용 버튼 클릭 시 모달이 뜨지 않음. | **수정**: 스크립트 로드 시 긴급사용 클릭 리스너 즉시 등록(`setupEmergencyUseListener`). bootstrap 완료 전에도 클릭 시 토스트 또는 모달 표시. `pcoffApi` 없을 때 토스트 안내. |
| **긴급해제** | 주·보조 모니터 모두 긴급해제 버튼 클릭 시 동작하지 않음. | **수정**: (1) 버튼 비활성화를 시도 제한(lockout) 중일 때만 적용. 미설정(eligible false)이어도 클릭 가능. (2) 클릭 시 모달은 항상 열리게 하고, 확인 시에만 자격 검사. (3) 긴급해제 리스너 스크립트 로드 시 등록. (4) `pcoffApi`/모달 요소 없을 때 토스트 안내. |

동작 확인: 주/보조 모니터에서 긴급해제·긴급사용 버튼 클릭 후 모달 또는 토스트가 표시되는지 확인.

---

## 7. 관련 문서

- `docs/다중_디스플레이_QA.md` — 다중 모니터 QA 시나리오
- `docs/다음_개발_진행_사항.md` — §7·§11 다중 디스플레이 완료 항목 및 미해결 이슈
- `app/main/index.ts` — `ensureLockWindowsForAllDisplays`, `closeAllLockWindows`, `getInitialLockWork`
- `app/renderer/lock.js` — `applyLockScreenImages`, `LOCK_DEFAULT_BG`, `getInitialLockWork` 호출
