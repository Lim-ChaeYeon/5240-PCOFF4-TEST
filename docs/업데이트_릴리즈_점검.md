# 업데이트·릴리즈 점검 (개발자용)

설치형 앱의 자동 업데이트가 동작하지 않거나, "지금 재시작" 시 "적용할 업데이트가 없습니다"가 나올 때 확인할 항목입니다.

---

## 1. 자동 업데이트가 안 될 때

### 1.1 GitHub Release에 메타데이터 파일이 있는지

electron-updater는 **설치 파일만으로는 업데이트를 할 수 없고**, 다음 파일이 **같은 Release에 함께 있어야** 합니다.

| 플랫폼 | 필요 파일 예시 |
|--------|-----------------|
| Windows | `latest.yml`, `5240 PcOff Agent Setup x.x.x.exe`, `*.blockmap` |
| macOS   | `latest-mac.yml`, `*.dmg` 또는 `*.zip`, `*.blockmap` |

- **수동으로** Release를 만든 경우: 설치 파일만 올리고 `latest.yml` / `latest-mac.yml`을 올리지 않으면, 앱이 새 버전을 **찾지 못합니다**.
- **권장**: 태그 푸시 시 `.github/workflows/release.yml`로 빌드·업로드하면 위 파일들이 자동으로 포함됩니다.
  - `git tag v0.2.3 && git push origin v0.2.3`
  - 워크플로가 `release/`의 exe, dmg, zip, **yml**, blockmap을 Release에 올립니다.

### 1.2 저장소가 비공개인 경우

- **비공개(Private) 저장소**이면, 설치된 앱은 GitHub에 인증 없이 Release API/파일을 읽지 못해 **업데이트 검사가 실패**할 수 있습니다.
- 이 경우:
  - 저장소를 **공개**로 두거나,
  - 별도 **업데이트 전용 서버**를 두고 `publish` 설정을 그쪽으로 바꾸는 방식이 필요합니다.

### 1.3 앱에서 업데이트 검사 결과 보기

- 앱 실행 후 **업데이트 확인**을 누르면, 메인 프로세스 콘솔(또는 로그)에 다음 메시지가 나갑니다.
  - `[UpdateManager] current version: x.x.x`
  - `[UpdateManager] checking for update...`
  - `[UpdateManager] update available: x.x.x` ← 새 버전 발견
  - `[UpdateManager] update not available (...)` ← 최신이라고 판단
  - `[UpdateManager] error: ...` ← 오류 (네트워크, 404, 권한 등)
- **개발자 도구**를 켤 수 있는 환경이면, 터미널/콘솔에서 위 로그로 “검사만 하고 끝나는지”, “에러가 나는지” 확인할 수 있습니다.
- 로그 파일 경로: `%APPDATA%\5240 PcOff Agent\logs\` (Windows), `~/Library/Application Support/5240 PcOff Agent/logs/` (Mac).  
  `UPDATE_FOUND`, `UPDATE_FAILED` 등으로 업데이트 관련 로그를 검색하면 됩니다.

### 1.4 "Cannot find latest-mac.yml" 404가 나는데 Release에는 파일이 있을 때

Release 자산에 `latest-mac.yml`이 있어도 404가 날 수 있습니다. 이 경우 앱은 **종료되지 않고** "이 플랫폼용 업데이트 정보가 없습니다."로 표시하며, 재시도 큐에 넣지 않습니다.

- **가능한 원인**: 저장소 비공개(인증 없이 접근 불가), GitHub 일시적 오류·캐시, rate limit. 퍼블릭 저장소인데도 404가 나면 GitHub CDN 리다이렉트 이슈일 수 있음.
- **조치**: (1) 저장소를 공개로 두기. (2) 앱에서는 `requestHeaders`에 User-Agent를 설정하고, electron-updater를 6.8.x 이상으로 올려 리다이렉트 처리 개선. (3) 잠시 후 다시 "업데이트 확인" 시도.

---

## 2. "지금 재시작"을 눌렀는데 "적용할 업데이트가 없습니다"가 나올 때

이 메시지는 **“지금 재시작” 버튼을 눌렀을 때, 실제로 디스크에 다운로드된 업데이트가 없다**는 뜻입니다.

- 업데이트 검사에서 **새 버전을 찾지 못했거나**, **다운로드가 끝나기 전에** 버튼을 누른 경우일 수 있습니다.
- 또는 **한 번은 다운로드됐다가**, 그 뒤에 앱을 재시작하면 메모리 상태가 초기화되어 “다운로드됨” 상태가 사라지고, 이때도 “적용할 업데이트가 없습니다”가 나올 수 있습니다.

**확인할 것:**

1. **업데이트 확인** 버튼을 눌렀을 때  
   - “확인 중…” → “다운로드 0%…100%” → “지금 재시작” 순서로 바뀌었는지  
   - 중간에 “현재 최신 버전입니다” 또는 “업데이트 오류”로 끝나지 않았는지
2. 위 1번이 정상이라면, **다운로드가 100%로 끝난 뒤에만** “지금 재시작”을 눌러야 적용됩니다.
3. 1번에서 항상 “최신 버전” 또는 “오류”로 끝난다면, **섹션 1**처럼 Release에 yml이 있는지, 저장소가 비공개인지, 로그/콘솔에 `[UpdateManager] error`가 찍히는지 확인하는 것이 좋습니다.

---

## 3. 릴리즈 절차 요약 (자동 업데이트가 되게 하려면)

1. **버전 올리기**: `package.json`의 `version`을 올립니다 (예: `0.2.3`).
2. **태그 푸시**:  
   `git tag v0.2.3`  
   `git push origin v0.2.3`
3. **CI**: `release.yml`이 실행되며, 해당 태그용 설치 파일과 **latest.yml / latest-mac.yml**이 GitHub Release에 함께 올라갑니다.
4. 이미 설치된 앱(예: 0.2.2)은 **업데이트 확인** 또는 앱 시작 후 자동 검사로 0.2.3을 찾고, 다운로드 후 **앱 종료 시** 또는 **지금 재시작**으로 적용할 수 있습니다.

수동으로 Release를 만들었다면, 반드시 **같은 버전의** `latest.yml`(Windows) / `latest-mac.yml`(Mac)을 해당 Release에 업로드해야 합니다 (로컬에서 `electron-builder --win` 또는 `--mac` 한 뒤 생성된 yml 파일 사용).
