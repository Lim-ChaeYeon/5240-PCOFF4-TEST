# 업데이트·릴리즈 점검 (개발자용)

설치형 앱의 자동 업데이트가 동작하지 않거나, "지금 재시작" 시 "적용할 업데이트가 없습니다"가 나올 때 확인할 항목입니다.

---

## 1. 자동 업데이트가 안 될 때

### 1.1 GitHub Release에 메타데이터 파일이 있는지

electron-updater는 **설치 파일만으로는 업데이트를 할 수 없고**, 다음 파일이 **같은 Release에 함께 있어야** 합니다.

| 플랫폼 | 필요 파일 예시 |
|--------|-----------------|
| Windows | `latest.yml`, `5240 PcOff Agent Setup x.x.x.exe`, `*.blockmap` |
| macOS   | `latest-mac.yml`, `*.dmg` 또는 `*.zip`, `*.blockmap` |

- **수동으로** Release를 만든 경우: 설치 파일만 올리고 `latest.yml` / `latest-mac.yml`을 올리지 않으면, 앱이 새 버전을 **찾지 못합니다**.
- **권장**: 태그 푸시 시 `.github/workflows/release.yml`로 빌드·업로드하면 위 파일들이 자동으로 포함됩니다.
  - `git tag v0.2.3 && git push origin v0.2.3`
  - 워크플로가 `release/`의 exe, dmg, zip, **yml**, blockmap을 Release에 올립니다.

### 1.2 저장소가 비공개인 경우

- **비공개(Private) 저장소**이면, 설치된 앱은 GitHub에 인증 없이 Release API/파일을 읽지 못해 **업데이트 검사가 실패**할 수 있습니다.
- 이 경우:
  - 저장소를 **공개**로 두거나,
  - 별도 **업데이트 전용 서버**를 두고 `publish` 설정을 그쪽으로 바꾸는 방식이 필요합니다.

### 1.3 앱에서 업데이트 검사 결과 보기

- 앱 실행 후 **업데이트 확인**을 누르면, 메인 프로세스 콘솔(또는 로그)에 다음 메시지가 나갑니다.
  - `[UpdateManager] current version: x.x.x`
  - `[UpdateManager] checking for update...`
  - `[UpdateManager] update available: x.x.x` ← 새 버전 발견
  - `[UpdateManager] update not available (...)` ← 최신이라고 판단
  - `[UpdateManager] error: ...` ← 오류 (네트워크, 404, 권한 등)
- **개발자 도구**를 켤 수 있는 환경이면, 터미널/콘솔에서 위 로그로 “검사만 하고 끝나는지”, “에러가 나는지” 확인할 수 있습니다.
- 로그 파일 경로: `%APPDATA%\5240 PcOff Agent\logs\` (Windows), `~/Library/Application Support/5240 PcOff Agent/logs/` (Mac).  
  `UPDATE_FOUND`, `UPDATE_FAILED` 등으로 업데이트 관련 로그를 검색하면 됩니다.

### 1.4 "Cannot find latest-mac.yml" 404가 나는데 Release에는 파일이 있을 때

Release 자산에 `latest-mac.yml`이 있어도 404가 날 수 있습니다. 이 경우 앱은 **종료되지 않고** "이 플랫폼용 업데이트 정보가 없습니다."로 표시하며, 재시도 큐에 넣지 않습니다.

- **가능한 원인**: 저장소 비공개(인증 없이 접근 불가), GitHub 일시적 오류·캐시, rate limit. 퍼블릭 저장소인데도 404가 나면 GitHub CDN 리다이렉트 이슈일 수 있음.
- **조치**: (1) 저장소를 공개로 두기. (2) 앱에서는 `requestHeaders`에 User-Agent를 설정하고, electron-updater를 6.8.x 이상으로 올려 리다이렉트 처리 개선. (3) 잠시 후 다시 "업데이트 확인" 시도.

### 1.5 "최신 버전입니다"인데 GitHub에는 새 릴리스가 있을 때

**원인**: 설치된 앱의 버전과 GitHub 최신 릴리스 버전이 **같을 때** 나옵니다. (업데이트 검사는 “설치 버전 < 릴리스 버전”일 때만 새 버전으로 인식합니다.)

- **확인**: 앱에서 "업데이트 확인"을 누른 뒤, 콘솔/로그에  
  `[UpdateManager] update not available — installed: 0.2.6 , release: 0.2.6`  
  처럼 나오면, 둘 다 같은 버전이라 “최신”으로 처리된 것입니다.
- **흔한 경우**: 새 릴리스(v0.2.6)를 올리기 전에, 이미 **로컬에서 0.2.6으로 빌드해 설치**해 두었다면, 그 앱은 0.2.6이고 릴리스도 0.2.6이라 업데이트가 없다고 나옵니다.
- **업데이트 동작을 제대로 보려면**:  
  (1) **이전 버전** 앱을 설치해 둔 뒤(예: v0.2.5 릴리스에서 다운로드),  
  (2) **새 버전** 릴리스를 푸시(예: v0.2.6),  
  (3) 그 이전 버전 앱에서 "업데이트 확인"을 누르면 새 버전이 잡혀야 합니다.

**원인 2 — Pre-release 체크**: "Set as a pre-release"가 체크돼 있으면 API "latest"가 그 릴리스를 안 넘길 수 있음. 체크 해제 후 재시도.

**원인 3 — 버전 형식(0.2.5-2, 0.2.5-3)**: Pre-release 해제·Latest인데도 업데이트가 안 잡히면, **실제로 updater가 받은 버전**을 먼저 확인하세요.
- 앱에서 "업데이트 확인" 클릭 후, 콘솔 또는 `~/Library/Application Support/5240 PcOff Agent/logs/`(Mac) 등에서  
  `[UpdateManager] update not available — installed: 0.2.5-2 , release: ???`  
  로그를 봅니다.
- **release: 0.2.5-2** 로 나오면 → 서버/API가 0.2.5-3이 아닌 0.2.5-2를 최신으로 주는 상태. (캐시·GitHub 쪽 이슈 가능.)
- **release: 0.2.5-3** 로 나오면 → 받은 버전은 맞는데, 비교 로직에서 0.2.5-3 > 0.2.5-2를 인식 못하는 경우일 수 있음.
- **임시 우회**: 다음 릴리스는 **하이픈 없이** 버전을 올려 보세요 (예: `0.2.6`). 0.2.5-2 → 0.2.6이면 정식 semver라 업데이트가 잡히는지 확인할 수 있습니다.

---

## 2. "지금 재시작"을 눌렀는데 "적용할 업데이트가 없습니다"가 나올 때

이 메시지는 **“지금 재시작” 버튼을 눌렀을 때, 실제로 디스크에 다운로드된 업데이트가 없다**는 뜻입니다.

- 업데이트 검사에서 **새 버전을 찾지 못했거나**, **다운로드가 끝나기 전에** 버튼을 누른 경우일 수 있습니다.
- 또는 **한 번은 다운로드됐다가**, 그 뒤에 앱을 재시작하면 메모리 상태가 초기화되어 “다운로드됨” 상태가 사라지고, 이때도 “적용할 업데이트가 없습니다”가 나올 수 있습니다.

**확인할 것:**

1. **업데이트 확인** 버튼을 눌렀을 때  
   - “확인 중…” → “다운로드 0%…100%” → “지금 재시작” 순서로 바뀌었는지  
   - 중간에 “현재 최신 버전입니다” 또는 “업데이트 오류”로 끝나지 않았는지
2. 위 1번이 정상이라면, **다운로드가 100%로 끝난 뒤에만** “지금 재시작”을 눌러야 적용됩니다.
3. 1번에서 항상 “최신 버전” 또는 “오류”로 끝난다면, **섹션 1**처럼 Release에 yml이 있는지, 저장소가 비공개인지, 로그/콘솔에 `[UpdateManager] error`가 찍히는지 확인하는 것이 좋습니다.

---

## 3. 릴리즈 절차 요약 (자동 업데이트가 되게 하려면)

1. **버전 올리기**: `package.json`의 `version`을 올립니다 (예: `0.2.3`).
2. **태그 푸시**:  
   `git tag v0.2.3`  
   `git push origin v0.2.3`
3. **CI**: `release.yml`이 실행되며, 해당 태그용 설치 파일과 **latest.yml / latest-mac.yml**이 GitHub Release에 함께 올라갑니다.
4. 이미 설치된 앱(예: 0.2.2)은 **업데이트 확인** 또는 앱 시작 후 자동 검사로 0.2.3을 찾고, 다운로드 완료 시 버튼이 **「지금 재시작」**으로 바뀌며, **「지금 재시작」을 눌렀을 때만** 적용됩니다(앱 종료 시 자동 적용 없음).

수동으로 Release를 만들었다면, 반드시 **같은 버전의** `latest.yml`(Windows) / `latest-mac.yml`(Mac)을 해당 Release에 업로드해야 합니다 (로컬에서 `electron-builder --win` 또는 `--mac` 한 뒤 생성된 yml 파일 사용).

---

## 4. 업데이트 관련 이슈 및 수정 사항

### 4.1 "확인 중..."에서 버튼이 돌아오지 않음

- **원인**: 패키징되지 않은(개발) 환경에서 electron-updater가 검사를 스킵해 `update-not-available` 이벤트를 보내지 않음. UpdateManager는 150ms 후 상태를 `not-available`로 바꾸지만 Renderer에 알리지 않아 버튼이 "확인 중..."에 머무름.
- **수정**: `update-manager.ts` — 150ms 후에도 `state === "checking"`이면 `not-available`로 바꾼 뒤 **`sendStatusToRenderer()` 호출** 추가. 버튼이 "최신 버전" → 3초 후 "업데이트 확인"으로 복귀.

### 4.2 다운로드 중 앱(에이전트) 종료 — 적용 없이 종료만 발생

- **현상**: 업데이트 확인 클릭 후 "확인 중" → "다운로드 중" 단계에서 앱이 종료되고, 재실행 시 업데이트는 적용되지 않음.
- **원인(핵심)**: 실행 엔트리가 **dist** (`package.json`의 `"main": "dist/app/main/index.js"`)이므로, **src만 수정하고 빌드하지 않으면** 실제 실행 코드에는 개선 로직이 반영되지 않음.
- **수정 내용**
  1. **before-quit에서 종료 차단** (`app/main/index.ts`): 업데이트 상태가 `downloading` 또는 `available`일 때 `e.preventDefault()`로 **의도치 않은 종료 방지**. 다운로드가 끝나 "지금 재시작"을 누를 때만 종료·설치되도록 함.
  2. **방어 코드** (`app/core/update-manager.ts`): `download-progress`에서 `progress?.percent` 안전 접근, `sendStatusToRenderer`에 payload 복사 및 `.catch()`로 unhandledRejection 방지, `update-downloaded`에서 예외 시 `status = "error"` 설정.
  3. **로그 정리**: `update-downloaded` 시점에 `UPDATE_APPLIED`를 기록하지 않도록 변경. 실제 설치(지금 재시작) 후에만 "적용됨" 로그가 남도록 하여 관측 혼선 방지.
- **반영 조건**: 위 수정이 **실제 동작하려면** `npm run build`로 **dist를 갱신**해야 함. src만 수정한 상태로 `electron .`만 실행하면 예전 dist가 실행됨.

### 4.3 현재 동작 요약

- **업데이트 확인 클릭 시**: "확인 중" → (새 버전 있으면) "다운로드 0%…100%" → "지금 재시작"까지 **앱이 종료되지 않도록** 막은 상태임.
- 즉, **클릭 순간만** 막은 것이 아니라, **새 버전 발견(available) ~ 다운로드 완료(downloaded)** 구간 전체에서 `before-quit` 시 종료가 차단됨. 사용자가 강제 종료(Ctrl+Shift+Q 등)를 쓰지 않는 한, 다운로드 완료 후 "지금 재시작"으로 적용할 수 있음.
- 코드 수정 후에는 **`npm run build`**(또는 `npm run start`)로 dist를 한 번 갱신하는 것을 권장함.
