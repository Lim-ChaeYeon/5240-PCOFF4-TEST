# 원본(5240.PcOff-master WebView) 기준 긴급해제 설정 정리

**확인일**: 2026-02-27  
**목적**: Electron 앱에서 `callPcOffEmergencyUnlock.do` 404 원인 파악 — 원본 WebView에서 긴급해제가 어떻게 구현되어 있는지 정리.

**요약**: 원본에서는 긴급해제 시 **API 서버(api.tigris5240.com)가 아니라 PHP**를 호출합니다.  
→ **POST `/Includes/sendLockPass.php`** 에 `ServAreaID`, `LockPass`를 보내고, PHP에서 DB(`tblSetting.LockPass`)와 비교해 성공/실패를 반환합니다.

## 1. 원본 WebView에서의 “긴급해제”

### 1.1 UI·진입점

| 항목 | 위치 | 설명 |
|------|------|------|
| 긴급해제 진입 | `LockScreen/screen.php` | `$LockPass`(DB)가 있으면 `.screenlockpass` 요소 표시 (약 374행) |
| 모달 | `#LockPassModal` | 비밀번호 입력 필드: `input[name="LockSuperPass"]` |
| 전송 함수 | `Includes/js/screen.js` | `fLockSuperPassSend()` → **POST `/Includes/sendLockPass.php`** |

### 1.2 검증 경로 (원본은 API 서버 아님)

- **요청**: `sendLockPass.php`에 `ServAreaID`, `LockPass`(사용자 입력) POST.
- **검증**: 원본 구조상 **로컬 PHP**가 DB(`tblSetting.LockPass`)와 비교해 성공/실패 반환.
- **성공 시**: `result.result == 'success'` → `fAlert('hotkey')` 호출로 잠금 해제 처리.

```javascript
// screen.js 1008-1021행
$.ajax({
  url: '/Includes/sendLockPass.php',
  data: { ServAreaID: ..., LockPass: $LockPass.val() },
  success: function(result) {
    if (result.result == 'success') {
      fAlert('hotkey');  // 잠금 해제
    } else
      $LockPass.parent().find('.text-danger').text('비밀번호가 맞지 않습니다.');
  }
});
```

### 1.3 비밀번호 출처

| 출처 | 파일 | 내용 |
|------|------|------|
| 화면용 조회 | `LockScreen/screen.php` 252행 | `SELECT LockPass FROM tblSetting WHERE ServAreaID=...` |
| 설정 API | `LockScreen/getScreenInfo.php` | `tblLockScreen` JOIN `tblSetting` → 응답에 `LockPass` 포함 |

즉, 원본에서는 **긴급해제 비밀번호가 DB(tblSetting.LockPass)**에 있고, **검증은 로컬 PHP(sendLockPass.php)**에서 수행됨.

---

## 2. 원본과 “긴급사용” 구분

| 구분 | 원본 WebView | 비고 |
|------|----------------|------|
| **긴급사용** | `callPcOffEmergencyUse.do` 호출 → 서버가 `emergencyUsePass`(일회용) 반환 → 사용자 입력 후 **클라이언트에서 비교** (`$LockPass.val() != EmergencyUsePass`) | api.tigris5240.com 사용 |
| **긴급해제** | `sendLockPass.php` (로컬 PHP)에 비밀번호 전송 → DB `LockPass`와 비교 | **api.tigris5240.com 미사용** |

---

## 3. 원본 문서(architecture.md)의 API 목록

`5240.PcOff-master/docs/architecture.md` §7.2:

- `/getPcOffWorkTime.do`
- `/callPcOffTempDelay.do`
- `/callPcOffEmergencyUse.do`

**`/callPcOffEmergencyUnlock.do`는 목록에 없음.**  
즉, 원본 설계/문서 기준으로는 **긴급해제용 API가 API 서버(api.tigris5240.com)에 없음**.

---

## 4. Electron 앱과의 대응

| 항목 | 원본 WebView | Electron 앱 |
|------|----------------|-------------|
| 긴급해제 검증 | 로컬 PHP `sendLockPass.php` + `tblSetting.LockPass` | **우선 PHP**: `config.sendLockPassUrl` 또는 `config.lockScreenApiUrl`에서 도메인 추출 → **POST `/Includes/sendLockPass.php`** (ServAreaID, LockPass). 설정 없으면 기존 `callPcOffEmergencyUnlock.do` 시도. |
| 404 원인 | - | PHP URL이 설정되어 있으면 API 서버 호출 없이 PHP만 사용. `sendLockPassUrl`/`lockScreenApiUrl` 없을 때만 `.do` 호출(서버 미구현 시 404). |

**결론**:  
- **PHP 사용**: `config.json`에 `sendLockPassUrl`(전체 URL)을 넣거나, `lockScreenApiUrl`만 넣으면 자동으로 `{origin}/Includes/sendLockPass.php`를 호출합니다. 원본과 동일한 방식으로 긴급해제 검증이 가능합니다.  
- **추후 API**: 서버에 `callPcOffEmergencyUnlock.do`를 추가한 뒤에는 `sendLockPassUrl`을 제거하면 API 경로로 전환할 수 있습니다.

---

## 5. 참고 파일 경로

- `5240.PcOff-master/WebView/LockScreen/screen.php` — LockPass 조회, .screenlockpass 노출
- `5240.PcOff-master/WebView/LockScreen/getScreenInfo.php` — 설정 응답에 LockPass 포함
- `5240.PcOff-master/WebView/Includes/js/screen.js` — fLockSuperPassSend, sendLockPass.php 호출
- `5240.PcOff-master/docs/architecture.md` — API 목록, CLockPassDlg(긴급해제) 언급
