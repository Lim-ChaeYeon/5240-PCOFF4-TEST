# 잠금 화면·적용 정책 동작 설명

## 1. "적용 정책"이란?

작동정보 화면의 **「적용 정책」**은 **현재 표시 기준이 되는 화면 유형(screenType)**입니다.

| 값 | 의미 |
|----|------|
| **before** | 시업 전(출근 전) — 옵션 1227(exCountRenewal) 기준 현재 시각이 일자변경 시각 미만일 때 |
| **off** | 종업 — 현재 시각이 일자변경 시각(exCountRenewal) 미만이거나, 서버가 종업으로 내려준 경우 |
| **empty** | 이석 — 서버/로컬 이석 감지 시 |
| (기타) | 일반 등 |

- **데이터 출처**: `/getPcOffWorkTime.do` 응답 + **옵션 1227(exCountRenewal)** 과 현재 시각으로 `resolveScreenType()`이 계산합니다.
- **용도**: 잠금 화면/작동정보에서 **어떤 문구·화면을 보여줄지** 결정하는 **표시용** 값입니다.  
  즉, "지금이 시업 전인지, 종업인지, 이석인지"를 사용자에게 보여주는 라벨에 해당합니다.

---

## 2. 잠금 화면이 나오는 조건 (실제 잠금 트리거)

**잠금/잠금해제 기준**은 백엔드 정책에 따라 **다음 두 값으로만** 판단합니다.

| 필드 | 의미 |
|------|------|
| **pcOnYmdTime** | PC-ON 시간 (YYYYMMDDHH24MI) — 이 시각부터 PC 사용 가능 |
| **pcOffYmdTime** | PC-OFF 시간 (YYYYMMDDHH24MI, **임시연장 반영된 종료 시각**) — 이 시각부터 잠금 |

- **현재 시각 < pcOnYmdTime** → 잠금 (시업 전)
- **현재 시각 >= pcOffYmdTime** → 잠금 (종업 후)
- **pcOnYmdTime <= 현재 시각 < pcOffYmdTime** → 잠금 해제 (사용 가능)

**pcOnYn**은 **해당 일자의 PC 사용 가능 여부**(휴일·휴가·출장 등 일자 기준)이며, 실시간 잠금 여부를 나타내는 값이 아닙니다.  
따라서 에이전트는 **pcOnYmdTime / pcOffYmdTime**만으로 잠금 여부를 계산합니다.

- 앱은 **1분마다** `getPcOffWorkTime`으로 상태를 조회하고, 위 시각 비교 결과 잠금이면 잠금 화면을 띄웁니다.
- 주기: `LOCK_CHECK_INTERVAL_MS = 60_000`(1분). 로그인 직후·트레이에서 작동정보를 열 때에도 한 번씩 잠금 여부를 확인합니다.
- **임시연장 중**: 연장 만료 시각(`pcOffYmdTime`)이 지나기 전까지는 서버 재조회 없이 **로컬에 보정해 둔 근태 데이터**로만 잠금 여부를 판단합니다(서버 반영 지연·앱 재시작 후에도 60분 유지). `state.json`에 `tempExtendUntil`·`lastWorkTimeSnapshot`을 저장해 재시작 시 복원합니다.

**잠금화면에서 상세 안내(임시연장 N분·M회, 긴급사용 문구 등) 확인**: 잠금화면에는 제목·서버 문구만 표시하며, 임시연장·긴급사용 안내 문구는 화면에 뿌리지 않는다. **「나의 근태정보 불러오기」** 버튼을 클릭하면 근태정보 패널에서 시업/종업 시간, 임시연장 횟수·시간, 긴급사용 여부 등 상세 안내를 확인할 수 있다.

**잠금화면 배경·로고**: 고객사 설정(서버 또는 config)으로 잠금화면 **배경 이미지**와 **로고 이미지**를 지정할 수 있다. `/getPcOffWorkTime.do`·getLockScreenInfo 응답의 `lockScreen*Background`/`lockScreen*Logo` 또는 config.json `lockScreen.before`/`off`/`leave`의 `backgroundUrl`·`logoUrl`에 URL을 넣으면, 해당 화면 유형(시업 전/종업/이석)에서 자동 적용된다.

**요약**:  
- **적용 정책** = 화면에 표시하는 "지금 시업 전/종업/이석" 라벨 (표시용).  
- **실제 잠금** = **pcOnYmdTime / pcOffYmdTime** 시각 비교로 판단 (pcOnYn 아님).

**긴급사용 인증번호**:  
- 에이전트는 사용자가 **입력한 인증번호**를 `/callPcOffEmergencyUse.do`에 그대로 전달합니다.  
- **인증번호 발송**(SMS/알림/문자 등)은 **서버·관리자 쪽에서만** 가능합니다. 에이전트 앱은 인증번호를 “받아서 입력”하는 역할만 하며, 인증번호가 “오지 않는다”면 관리자/시스템에서 발급·발송 절차를 확인해야 합니다. 백엔드에서 "인증번호 발송 요청" API를 제공하면, 에이전트에 "인증번호 발송" 버튼을 추가해 연동할 수 있습니다.

---

## 3. 잠금 화면이 동작하는 흐름

1. **주기 검사**: 로그인 후 `startLockCheckInterval()`이 **1분 간격**으로 `checkLockAndShowLockWindow()`를 호출합니다.
2. **잠금 여부 판단**: `isLockRequired()`가 `/getPcOffWorkTime.do`를 호출하고, **pcOnYmdTime / pcOffYmdTime**과 현재 시각을 비교해 잠금이면 `true`를 반환합니다.
3. **화면 전환**: `true`이면 현재 창을 잠금 화면(lock.html)으로 전환하거나, 없으면 새 잠금 창을 띄웁니다.
4. **트레이에서 작동정보 열 때**: 트레이에서 "PCOFF 작동정보"를 열어도, 그 직전에 `checkLockAndShowLockWindow()`를 한 번 호출해, 잠금이 필요하면 **작동정보 대신 잠금 화면**이 나옵니다.

---

## 4. Windows 트레이 아이콘이 비어 보일 때

- 트레이 **칸은 생겼는데 아이콘이 안 보이는** 경우, 패키징된 앱에서 아이콘 파일 경로를 찾지 못했을 수 있습니다.
- 대응: 트레이 아이콘(`assets/tray-icon.png`)을 **extraResources**로 복사해 `process.resourcesPath`에서 읽도록 수정했습니다.  
  새로 빌드·설치 후 트레이 아이콘이 보이는지 확인해 보시고, 여전히 비어 있으면 작업 표시줄(라이트/다크) 대비가 잘 드러나는 아이콘 이미지로 교체하는 것을 권장합니다.
