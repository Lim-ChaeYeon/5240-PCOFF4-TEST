# 추후 개발·점검 — 연동·E2E 점검 가이드

추후 개발·점검 항목 1~3(이석 해제 비밀번호, 잠금화면 문구 API, 임시연장 서버 반영)에 대해 **서버 구현 후** 에이전트 연동 확인·E2E 점검 시 따를 수 있는 체크리스트와 시나리오입니다.  
관련 개요는 `docs/다음_개발_진행_사항.md`의 **「추후 개발·점검 항목」** 섹션을 참고하세요.

---

## 서버 준비 후 실행 순서 (한 페이지 체크리스트)

| 순서 | 항목 | 에이전트 측 확인 | 비고 |
|------|------|------------------|------|
| 1 | 이석 해제 비밀번호 | config 설정(PHP/로컬/mock) → 앱에서 이석 잠금 → PC-ON → 비밀번호 모달 → 검증 성공/실패·토스트 확인. §1 참고. | `leaveSeatUnlockVerifyUrl`만 쓸 경우 서버 신규 개발 없음. |
| 2 | 잠금화면 문구 API | 터미널 로그로 getLockScreenInfo/lock-policy 미사용 시 fallback(lockScreenApiUrl → config) 동작 확인. §2 참고. | 서버 구현 후 문구·이미지 반영 여부 확인. |
| 3 | 임시연장 서버 반영 | 임시연장 요청 후 터미널에서 `callPcOffTempDelay 응답`·`직후 getPcOffWorkTime 응답` 검색 → pcExCount·pcOffYmdTime 일치 여부. §3 참고. | 서버/DB 갱신 로직 점검 후 비교. |

**사전 확인**: `npx tsx simulator/cli.ts run-all` 로 11개 시나리오 PASS 여부 확인 권장.

---

## 1. 이석 해제 비밀번호 (우선 마무리 1번)

### 1.1 전제 조건

| 구분 | 내용 |
|------|------|
| **에이전트** | 이미 구현됨. `leaveSeatUnlockRequirePassword=true` 시 PC-ON 클릭 → 비밀번호 모달 → 검증 후 PC-ON. |
| **검증 경로** | (1) `leaveSeatUnlockPassword`(config 로컬 비교) (2) `leaveSeatUnlockVerifyUrl`(PHP) (3) `mockVerifyLeaveSeatUnlock`(개발용) (4) `POST /verifyLeaveSeatUnlock.do`(KiwiBox). |
| **모달 강제** | 서버에서 값을 안 주면 `config.json`에 `"leaveSeatUnlockRequirePassword": true` 설정 시 이석 화면에서 비밀번호 모달 표시. |

### 1.2 설정 예시 (config.json)

- **PHP 사용 시(원본 호환)**  
  `"leaveSeatUnlockVerifyUrl": "https://5240.work/Includes/sendPcOnPass.php"`  
  (ServAreaID, UserID=로그인계정, PcOnPass=비밀번호 POST, 응답 `code==1`이면 성공)
- **로컬 비밀번호 비교**  
  `"leaveSeatUnlockPassword": "설정한해제비밀번호"`, `leaveSeatUnlockVerifyUrl` 비우기.
- **개발용(서버 없이)**  
  `"mockVerifyLeaveSeatUnlock": true` → 검증 생략 후 PC-ON 진행.
- **모달만 띄워서 테스트**  
  `"leaveSeatUnlockRequirePassword": true` (이석 화면일 때만 모달 노출).

### 1.3 E2E 시나리오

1. **준비**: 로그인 후 이석 정책 사용(leaveSeatUseYn=Y, leaveSeatTime 설정). 유휴/절전으로 이석 잠금 화면 진입(또는 mock으로 screenType=empty 유지).
2. **잠금화면**: 이석 화면(empty)에서 PC-ON 버튼 클릭.
3. **모달**: 비밀번호 입력 모달이 뜨는지 확인.
4. **실패**: 잘못된 비밀번호 입력 → "비밀번호가 맞지 않습니다." 토스트, 모달 유지.
5. **성공(근무 시간 내)**: 올바른 비밀번호 입력 → "PC-ON (이석 해제) 완료" 토스트, 잠금 해제·작동정보 화면 전환.
6. **성공(근무 시간 외)**: 비밀번호 검증 성공이지만 서버가 잠금 유지 시 → "이석 해제되었습니다. 근무 시간이 아니면 PC-ON이 반영되지 않을 수 있습니다." 토스트, 잠금화면은 해제되어 작동정보로 전환.

### 1.4 연동·로그 확인

- **로그**: 이석 해제 시 `callCmmPcOnOffLogPrc`에 `eventName: "Lock Off - 이석해제"`, `emergencyYn`: `N/이석시간/시작HM/종료HM/0` 형식 전송 여부(JSONL·서버 로그).
- **API 미사용 시**: 404 또는 verifyLeaveSeatUnlock 관련 오류 시 토스트 "이석 해제 검증 API를 사용할 수 없습니다." 표시 여부.

---

## 2. 잠금화면 문구 API (우선 마무리 2번)

### 2.1 전제 조건

| 구분 | 내용 |
|------|------|
| **에이전트** | `getPcOffWorkTime` 후 문구 없을 때 `getLockScreenInfo.do` 시도, 실패 시 `[PCOFF] 잠금화면 문구 — getLockScreenInfo.do 미사용` 로그. 이후 `config.lockScreenApiUrl` 있으면 해당 URL로 문구 조회. `getLockPolicy(tenantId)`로 lock-policy 조회·30분 캐시·폴링. |
| **서버** | `getLockScreenInfo.do`, `GET /api/v1/pcoff/tenants/{tenantId}/lock-policy` 필요 시 신규 구현. |

### 2.2 연동 확인 절차

1. **getLockScreenInfo.do 미구현 시**: 터미널에 `[PCOFF] 잠금화면 문구 — getLockScreenInfo.do 미사용` 로그 확인. `config.lockScreenApiUrl` 설정 시 해당 URL 호출 여부 확인.
2. **lock-policy 미구현 시**: `[PCOFF] lock-policy API 미사용` 로그 확인. 30분 캐시·폴링으로 재시도하는지(다음 getWorkTime 시도 시) 확인.
3. **API 구현 후**: 잠금화면 표시 시 서버에서 내려준 제목·메시지·이미지가 적용되는지 확인(시업 전/종업/이석 각각).
4. **Fallback 경로(콘솔 로그)**: getLockScreenInfo 실패 후 → `lockScreenApiUrl` 있으면 해당 URL 호출 → 성공 시 `[PCOFF] 잠금화면 문구 — lockScreenApiUrl 적용됨`. URL도 실패 시 config 사용 → `[PCOFF] 잠금화면 문구 — config.json lockScreen 적용됨`. lock-policy 성공 시 `[PCOFF] 잠금화면 문구 — lock-policy API 적용됨`.

### 2.3 Fallback 동작 체크리스트

- [ ] getLockScreenInfo 실패 시 config `lockScreen.before/off/leave`의 title/message/backgroundUrl/logoUrl 사용 여부.
- [ ] getLockPolicy 실패 시 기존 getPcOffWorkTime·lockScreen API 응답만으로 잠금화면 표시 가능 여부.

---

## 3. 임시연장 서버 반영 (우선 마무리 3번)

### 3.1 전제 조건

| 구분 | 내용 |
|------|------|
| **에이전트** | `callPcOffTempDelay.do` 호출 성공 시 (1) 터미널에 `[PCOFF] callPcOffTempDelay 응답:` + JSON (2) `UNLOCK_TRIGGERED` payload에 `callPcOffTempDelayResponse` (3) 직후 `getPcOffWorkTime()` 호출 (4) 터미널에 `[PCOFF] 직후 getPcOffWorkTime 응답 (서버 반영 확인용):` + pcExCount/pcOffYmdTime 등 (5) `UNLOCK_TRIGGERED` action `getPcOffWorkTime_after_extend`. |
| **서버/DB** | `callPcOffTempDelay.do` 수신 후 JsonMapper·프로시저·DB 갱신 로직 구현·보완. |

### 3.2 반영 여부 점검 방법

1. **에이전트 실행**: 로그인 후 종업 화면에서 임시연장 요청 실행.
2. **터미널 로그**:  
   - `[PCOFF] callPcOffTempDelay 응답:` 의 `pcOffYmdTime`, `pcExCount` 등  
   - `[PCOFF] 직후 getPcOffWorkTime 응답 (서버 반영 확인용):` 의 동일 필드  
   → 두 값이 서로 맞는지(갱신 반영됐는지) 확인.
3. **터미널 검색용**: 앱 실행 시 터미널에서 `callPcOffTempDelay 응답` 또는 `직후 getPcOffWorkTime 응답`으로 검색하면 해당 로그만 빠르게 찾을 수 있음.
4. **로그 검증 스크립트(선택)**: 임시연장 실행 후 JSONL 로그에서 `pc_extend`·`getPcOffWorkTime_after_extend` 쌍을 찾아 일치 여부를 출력하는 스크립트 사용 가능.
   ```bash
   node scripts/check-temp-extend-reflect.mjs [로그파일경로 또는 logs폴더경로]
   ```
   경로 생략 시 `process.cwd()/logs` 중 최신 `YYYY-MM-DD.json` 사용. 설치 앱은 userData의 logs 경로를 인자로 넘기면 됨(예: Windows `%APPDATA%\5240 PcOff Agent\logs`, Mac `~/Library/Application Support/5240 PcOff Agent/logs`).
5. **JSONL**: `UNLOCK_TRIGGERED` 로그의 payload에 `callPcOffTempDelayResponse`와 직후 getWorkTime 결과가 포함되는지 확인.
6. **서버/DB**: 관리 콘솔 또는 DB에서 해당 사용자 연장 횟수·연장 시각 갱신 여부 확인.

### 3.3 체크리스트

- [ ] callPcOffTempDelay 성공 응답과 직후 getPcOffWorkTime 응답의 pcExCount·pcOffYmdTime 일치 여부.
- [ ] 서버/DB에 연장 데이터 반영 여부.
- [ ] 반영되지 않을 경우 KiwiBox JsonMapper·프로시저·DB 갱신 로직 점검.

---

## 4. 시뮬레이터

E2E는 **실제 앱(패키징 또는 npm start)**에서 수행한다. 시뮬레이터는 Electron Main/IPC를 사용하지 않는 Node 환경이므로:

- **이석 해제 비밀번호**: 전체 플로우(모달 → 검증 → PC-ON)는 앱에서 수동·자동 E2E로 점검.
- **이석 해제 config·mock 경로 검증**: 시나리오 `leave_seat_unlock`으로 config.json 읽기 및 mock/로컬/URL/.do 우선순위 설정 검증 가능. (mock=true 시 검증 생략 시뮬레이션, UNLOCK_TRIGGERED 로그 기록)
- **이석 정책 로직**: `leave_seat_reason_required`, `leave_seat_break_exempt` 시나리오로 사유 필수/휴게 면제 정책만 검증 가능.

```bash
npx tsx simulator/cli.ts run --scenario leave_seat_unlock
npx tsx simulator/cli.ts run --scenario leave_seat_reason_required
npx tsx simulator/cli.ts run --scenario leave_seat_break_exempt
npx tsx simulator/cli.ts run-all
```

---

## 5. 참고 문서

- **다음 진행 사항·추후 개발 항목**: `docs/다음_개발_진행_사항.md`
- **API 규격**: `PC_OFF_AGENT_API.md`
- **이석 해제 정합성**: `docs/다음_개발_진행_사항.md` 내 "이석 해제 비밀번호(verifyLeaveSeatUnlock)" 문단.
